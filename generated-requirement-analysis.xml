<?xml version="1.0" encoding="UTF-8"?>
<RequirementAnalysis xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <Metadata>
    <DocumentTitle>FiservMEA Authorize Flow Requirement Analysis</DocumentTitle>
    <ConnectorName>FiservMEA</ConnectorName>
    <ConnectorDisplayName>Authipay Payments API</ConnectorName>
    <GeneratedDate>2026-02-13</GeneratedDate>
    <Version>1.0</Version>
    <Scope>Authorize Flow Only</Scope>
  </Metadata>

  <!-- ================================================================= -->
  <!-- TECHNICAL SPECIFICATION SUMMARY -->
  <!-- ================================================================= -->
  <TechnicalSpecification>
    <ConnectorInformation>
      <Name>Authipay Payments API</Name>
      <BaseURL>https://prod.emea.api.fiservapps.com/sandbox/ipp/payments-gateway/v2/payments</BaseURL>
      <ProductionURL>https://prod.emea.api.fiservapps.com/sandbox/ipp/payments-gateway/v2/payments</ProductionURL>
    </ConnectorInformation>

    <Authentication>
      <Method>Message Signature Authentication</Method>
      <RequiredHeaders>
        <Header name="Content-Type" value="application/json" required="true"/>
        <Header name="Client-Request-Id" required="true" description="UUID for request tracking and idempotency"/>
        <Header name="Api-Key" required="true" description="Merchant API key from Developer Portal"/>
        <Header name="Timestamp" required="true" description="Epoch timestamp in milliseconds"/>
        <Header name="Message-Signature" required="true" description="HMAC-SHA256 signature"/>
        <Header name="Message-Authentication-Value" required="false" description="Optional for Card Present transactions"/>
      </RequiredHeaders>
      <SignatureGeneration>
        <Step>Concatenate: API-Key + ClientRequestId + Timestamp + requestBody</Step>
        <Step>Generate HMAC-SHA256 using API Secret as key</Step>
        <Step>Apply HMAC to concatenated string</Step>
        <Step>Encode result as Base64</Step>
      </SignatureGeneration>
    </Authentication>

    <AuthorizeEndpoint>
      <URL>/payments</URL>
      <HTTPMethod>POST</HTTPMethod>
      <ContentType>application/json</ContentType>
      <RequestType>PaymentCardPreAuthTransaction</RequestType>
      <Description>Pre-authorize an amount (requires completion via PostAuthTransaction)</Description>
    </AuthorizeEndpoint>

    <SupportedFeatures>
      <Feature>3D Secure authentication</Feature>
      <Feature>PCI DSS compliance</Feature>
      <Feature>Order management</Feature>
      <Feature>Multiple payment methods (Card, Token, Wallet, APM)</Feature>
      <Feature>Transaction inquiry</Feature>
    </SupportedFeatures>
  </TechnicalSpecification>

  <!-- ================================================================= -->
  <!-- FLOW REQUIREMENTS -->
  <!-- ================================================================= -->
  <FlowRequirements>
    <Flow>
      <Name>Authorize</Name>
      <Priority>HIGHEST</Priority>
      <ImplementationMethod>Macro-Based</ImplementationMethod>
      <Trait>ConnectorIntegrationV2&lt;Authorize, PaymentFlowData, PaymentsAuthorizeData&lt;T&gt;, PaymentsResponseData&gt;</Trait>
      
      <Prerequisites>
        <Prerequisite>Read pattern_authorize.md</Prerequisite>
        <Prerequisite>Read macro_patterns_reference.md</Prerequisite>
        <Prerequisite>Read flow_macro_guide.md</Prerequisite>
        <Prerequisite>Review Airwallex implementation for reference</Prerequisite>
      </Prerequisites>

      <MacroConfiguration>
        <CreateAllPrerequisites>
          <Entry>
            <Flow>Authorize</Flow>
            <RequestBody>FiservmeaAuthorizeRequest&lt;T&gt;</RequestBody>
            <ResponseBody>FiservmeaAuthorizeResponse</ResponseBody>
            <RouterData>RouterDataV2&lt;Authorize, PaymentFlowData, PaymentsAuthorizeData&lt;T&gt;, PaymentsResponseData&gt;</RouterData>
          </Entry>
        </CreateAllPrerequisites>

        <MacroConnectorImplementation>
          <ConnectorDefaultImplementations>
            <Implementation>get_content_type</Implementation>
            <Implementation>get_error_response_v2</Implementation>
          </ConnectorDefaultImplementations>
          <Connector>Fiservmea</Connector>
          <CurlRequest>Json(FiservmeaAuthorizeRequest)</CurlRequest>
          <CurlResponse>FiservmeaAuthorizeResponse</CurlResponse>
          <FlowName>Authorize</FlowName>
          <ResourceCommonData>PaymentFlowData</ResourceCommonData>
          <FlowRequest>PaymentsAuthorizeData&lt;T&gt;</FlowRequest>
          <FlowResponse>PaymentsResponseData</FlowResponse>
          <HTTPMethod>Post</HTTPMethod>
          <GenericType>T</GenericType>
          <TraitBounds>PaymentMethodDataTypes + Debug + Sync + Send + 'static + Serialize</TraitBounds>
        </MacroConnectorImplementation>
      </MacroConfiguration>
    </Flow>
  </FlowRequirements>

  <!-- ================================================================= -->
  <!-- DATA STRUCTURES -->
  <!-- ================================================================= -->
  <DataStructures>
    <RequestStructures>
      <Structure name="FiservmeaAuthorizeRequest">
        <Generics>&lt;T: PaymentMethodDataTypes + Debug + Sync + Send + 'static + Serialize&gt;</Generics>
        <Derives>Debug, Serialize</Derives>
        <SerdeAttributes>
          <Attribute>rename_all = "camelCase"</Attribute>
        </SerdeAttributes>
        <Fields>
          <Field name="requestType" type="String" required="true" defaultValue="PaymentCardPreAuthTransaction">
            <Description>Type of transaction to perform</Description>
          </Field>
          <Field name="transactionAmount" type="FiservmeaTransactionAmount" required="true">
            <Description>Transaction amount and currency</Description>
          </Field>
          <Field name="paymentMethod" type="FiservmeaPaymentMethod" required="true">
            <Description>Payment method details</Description>
          </Field>
          <Field name="order" type="Option&lt;FiservmeaOrder&gt;" required="false">
            <Description>Order information (optional)</Description>
          </Field>
          <Field name="authenticationRequest" type="Option&lt;FiservmeaAuthenticationRequest&gt;" required="false">
            <Description>3D Secure authentication request (optional)</Description>
          </Field>
        </Fields>
      </Structure>

      <Structure name="FiservmeaTransactionAmount">
        <Derives>Debug, Serialize</Derives>
        <SerdeAttributes>
          <Attribute>rename_all = "camelCase"</Attribute>
        </SerdeAttributes>
        <Fields>
          <Field name="total" type="String" required="true">
            <Description>Total amount as string (e.g., "100.00")</Description>
          </Field>
          <Field name="currency" type="String" required="true">
            <Description>ISO 4217 currency code (e.g., "GBP")</Description>
          </Field>
        </Fields>
      </Structure>

      <Structure name="FiservmeaPaymentMethod">
        <Derives>Debug, Serialize</Derives>
        <SerdeAttributes>
          <Attribute>rename_all = "camelCase"</Attribute>
        </SerdeAttributes>
        <Fields>
          <Field name="paymentCard" type="FiservmeaPaymentCard" required="true">
            <Description>Payment card details</Description>
          </Field>
        </Fields>
      </Structure>

      <Structure name="FiservmeaPaymentCard">
        <Derives>Debug, Serialize</Derives>
        <SerdeAttributes>
          <Attribute>rename_all = "camelCase"</Attribute>
        </SerdeAttributes>
        <Fields>
          <Field name="number" type="Secret&lt;String&gt;" required="true">
            <Description>Card number</Description>
          </Field>
          <Field name="securityCode" type="Secret&lt;String&gt;" required="true">
            <Description>CVV/CVC code</Description>
          </Field>
          <Field name="expiryDate" type="FiservmeaExpiryDate" required="true">
            <Description>Card expiry date</Description>
          </Field>
        </Fields>
      </Structure>

      <Structure name="FiservmeaExpiryDate">
        <Derives>Debug, Serialize</Derives>
        <SerdeAttributes>
          <Attribute>rename_all = "camelCase"</Attribute>
        </SerdeAttributes>
        <Fields>
          <Field name="month" type="String" required="true">
            <Description>Expiry month (MM format)</Description>
          </Field>
          <Field name="year" type="String" required="true">
            <Description>Expiry year (YY format)</Description>
          </Field>
        </Fields>
      </Structure>

      <Structure name="FiservmeaOrder">
        <Derives>Debug, Serialize</Derives>
        <SerdeAttributes>
          <Attribute>rename_all = "camelCase"</Attribute>
        </SerdeAttributes>
        <Fields>
          <Field name="orderId" type="String" required="true">
            <Description>Merchant order ID</Description>
          </Field>
          <Field name="billing" type="Option&lt;FiservmeaBilling&gt;" required="false">
            <Description>Billing information</Description>
          </Field>
        </Fields>
      </Structure>

      <Structure name="FiservmeaBilling">
        <Derives>Debug, Serialize</Derives>
        <SerdeAttributes>
          <Attribute>rename_all = "camelCase"</Attribute>
        </SerdeAttributes>
        <Fields>
          <Field name="name" type="String" required="true">
            <Description>Customer name</Description>
          </Field>
          <Field name="customerId" type="Option&lt;String&gt;" required="false">
            <Description>Customer ID</Description>
          </Field>
        </Fields>
      </Structure>

      <Structure name="FiservmeaAuthenticationRequest">
        <Derives>Debug, Serialize</Derives>
        <SerdeAttributes>
          <Attribute>rename_all = "camelCase"</Attribute>
        </SerdeAttributes>
        <Fields>
          <Field name="authenticationType" type="String" required="true" defaultValue="Secure3D21AuthenticationRequest">
            <Description>3D Secure authentication type</Description>
          </Field>
          <Field name="termURL" type="String" required="true">
            <Description>Term URL for 3DS callback</Description>
          </Field>
          <Field name="challengeIndicator" type="String" required="true" defaultValue="04">
            <Description>Challenge indicator</Description>
          </Field>
        </Fields>
      </Structure>
    </RequestStructures>

    <ResponseStructures>
      <Structure name="FiservmeaAuthorizeResponse">
        <Derives>Debug, Deserialize</Derives>
        <SerdeAttributes>
          <Attribute>rename_all = "camelCase"</Attribute>
        </SerdeAttributes>
        <Fields>
          <Field name="clientRequestId" type="String" required="true">
            <Description>Echoed client request ID</Description>
          </Field>
          <Field name="apiTraceId" type="String" required="true">
            <Description>API trace ID for support</Description>
          </Field>
          <Field name="ipgTransactionId" type="String" required="true">
            <Description>Response transaction ID</Description>
          </Field>
          <Field name="orderId" type="String" required="true">
            <Description>Order ID</Description>
          </Field>
          <Field name="transactionType" type="String" required="true">
            <Description>Transaction type (PREAUTH)</Description>
          </Field>
          <Field name="transactionResult" type="FiservmeaTransactionResult" required="true">
            <Description>Transaction result status</Description>
          </Field>
          <Field name="transactionState" type="FiservmeaTransactionState" required="true">
            <Description>Transaction state</Description>
          </Field>
          <Field name="approvalCode" type="Option&lt;String&gt;" required="false">
            <Description>Approval code</Description>
          </Field>
          <Field name="schemeResponseCode" type="Option&lt;String&gt;" required="false">
            <Description>Scheme response code</Description>
          </Field>
          <Field name="errorMessage" type="Option&lt;String&gt;" required="false">
            <Description>Error message if failed</Description>
          </Field>
          <Field name="approvedAmount" type="Option&lt;FiservmeaApprovedAmount&gt;" required="false">
            <Description>Approved amount</Description>
          </Field>
          <Field name="processor" type="Option&lt;FiservmeaProcessor&gt;" required="false">
            <Description>Processor response data</Description>
          </Field>
          <Field name="paymentMethodDetails" type="Option&lt;FiservmeaPaymentMethodDetails&gt;" required="false">
            <Description>Payment method details</Description>
          </Field>
        </Fields>
      </Structure>

      <Enum name="FiservmeaTransactionResult">
        <Derives>Debug, Deserialize</Derives>
        <SerdeAttributes>
          <Attribute>rename_all = "SCREAMING_SNAKE_CASE"</Attribute>
        </SerdeAttributes>
        <Variants>
          <Variant name="Approved" description="Transaction approved"/>
          <Variant name="Declined" description="Transaction declined"/>
          <Variant name="Failed" description="Transaction failed"/>
          <Variant name="Waiting" description="Transaction waiting"/>
          <Variant name="Partial" description="Partial transaction"/>
          <Variant name="Fraud" description="Fraud detected"/>
        </Variants>
      </Enum>

      <Enum name="FiservmeaTransactionState">
        <Derives>Debug, Deserialize</Derives>
        <SerdeAttributes>
          <Attribute>rename_all = "SCREAMING_SNAKE_CASE"</Attribute>
        </SerdeAttributes>
        <Variants>
          <Variant name="Authorized" description="Transaction authorized"/>
          <Variant name="Captured" description="Transaction captured"/>
          <Variant name="Declined" description="Transaction declined"/>
          <Variant name="Checked" description="Transaction checked"/>
          <Variant name="CompletedGet" description="GET completed"/>
          <Variant name="Initialized" description="Transaction initialized"/>
          <Variant name="Pending" description="Transaction pending"/>
          <Variant name="Ready" description="Transaction ready"/>
          <Variant name="Template" description="Transaction template"/>
          <Variant name="Settled" description="Transaction settled"/>
          <Variant name="Voided" description="Transaction voided"/>
          <Variant name="Waiting" description="Transaction waiting"/>
        </Variants>
      </Enum>

      <Structure name="FiservmeaApprovedAmount">
        <Derives>Debug, Deserialize</Derives>
        <SerdeAttributes>
          <Attribute>rename_all = "camelCase"</Attribute>
        </SerdeAttributes>
        <Fields>
          <Field name="total" type="f64" required="true">
            <Description>Total approved amount</Description>
          </Field>
          <Field name="currency" type="String" required="true">
            <Description>Currency code</Description>
          </Field>
        </Fields>
      </Structure>

      <Structure name="FiservmeaProcessor">
        <Derives>Debug, Deserialize</Derives>
        <SerdeAttributes>
          <Attribute>rename_all = "camelCase"</Attribute>
        </SerdeAttributes>
        <Fields>
          <Field name="referenceNumber" type="Option&lt;String&gt;" required="false">
            <Description>Reference transaction ID</Description>
          </Field>
          <Field name="authorizationCode" type="Option&lt;String&gt;" required="false">
            <Description>Authorization code</Description>
          </Field>
          <Field name="responseCode" type="Option&lt;String&gt;" required="false">
            <Description>Response code</Description>
          </Field>
          <Field name="responseMessage" type="Option&lt;String&gt;" required="false">
            <Description>Response message</Description>
          </Field>
          <Field name="securityCodeResponse" type="Option&lt;FiservmeaSecurityCodeResponse&gt;" required="false">
            <Description>CVV response</Description>
          </Field>
        </Fields>
      </Structure>

      <Enum name="FiservmeaSecurityCodeResponse">
        <Derives>Debug, Deserialize</Derives>
        <SerdeAttributes>
          <Attribute>rename_all = "SCREAMING_SNAKE_CASE"</Attribute>
        </SerdeAttributes>
        <Variants>
          <Variant name="Matched" description="CVV matched"/>
          <Variant name="NotMatched" description="CVV did not match"/>
          <Variant name="NotProcessed" description="CVV not processed"/>
          <Variant name="NotPresent" description="CVV not present"/>
          <Variant name="NotCertified" description="CVV not certified"/>
          <Variant name="NotChecked" description="CVV not checked"/>
        </Variants>
      </Enum>

      <Structure name="FiservmeaPaymentMethodDetails">
        <Derives>Debug, Deserialize</Derives>
        <SerdeAttributes>
          <Attribute>rename_all = "camelCase"</Attribute>
        </SerdeAttributes>
        <Fields>
          <Field name="paymentMethodType" type="Option&lt;String&gt;" required="false">
            <Description>Payment method type (PAYMENT_CARD)</Description>
          </Field>
          <Field name="paymentMethodBrand" type="Option&lt;String&gt;" required="false">
            <Description>Card brand (VISA, MASTERCARD, etc.)</Description>
          </Field>
        </Fields>
      </Structure>

      <Structure name="FiservmeaErrorResponse">
        <Derives>Debug, Deserialize</Derives>
        <SerdeAttributes>
          <Attribute>rename_all = "camelCase"</Attribute>
        </SerdeAttributes>
        <Fields>
          <Field name="clientRequestId" type="String" required="true">
            <Description>Echoed client request ID</Description>
          </Field>
          <Field name="apiTraceId" type="String" required="true">
            <Description>API trace ID</Description>
          </Field>
          <Field name="responseType" type="String" required="true">
            <Description>Response type (BadRequest, Unauthenticated, etc.)</Description>
          </Field>
          <Field name="error" type="FiservmeaError" required="true">
            <Description>Error details</Description>
          </Field>
        </Fields>
      </Structure>

      <Structure name="FiservmeaError">
        <Derives>Debug, Deserialize</Derives>
        <SerdeAttributes>
          <Attribute>rename_all = "camelCase"</Attribute>
        </SerdeAttributes>
        <Fields>
          <Field name="code" type="String" required="true">
            <Description>Error code</Description>
          </Field>
          <Field name="message" type="String" required="true">
            <Description>Error message</Description>
          </Field>
          <Field name="details" type="Option&lt;Vec&lt;FiservmeaErrorDetail&gt;&gt;" required="false">
            <Description>Error details</Description>
          </Field>
          <Field name="declineReasonCode" type="Option&lt;String&gt;" required="false">
            <Description>Decline reason code</Description>
          </Field>
        </Fields>
      </Structure>

      <Structure name="FiservmeaErrorDetail">
        <Derives>Debug, Deserialize</Derives>
        <SerdeAttributes>
          <Attribute>rename_all = "camelCase"</Attribute>
        </SerdeAttributes>
        <Fields>
          <Field name="field" type="String" required="true">
            <Description>Field with error</Description>
          </Field>
          <Field name="message" type="String" required="true">
            <Description>Error message</Description>
          </Field>
        </Fields>
      </Structure>
    </ResponseStructures>

    <AuthenticationStructures>
      <Structure name="FiservmeaAuthType">
        <Derives>Debug, Clone</Derives>
        <Fields>
          <Field name="api_key" type="Secret&lt;String&gt;" required="true">
            <Description>API key from Developer Portal</Description>
          </Field>
          <Field name="api_secret" type="Secret&lt;String&gt;" required="true">
            <Description>API secret for signature generation</Description>
          </Field>
        </Fields>
      </Structure>
    </AuthenticationStructures>
  </DataStructures>

  <!-- ================================================================= -->
  <!-- STATUS MAPPING -->
  <!-- ================================================================= -->
  <StatusMapping>
    <MappingFunction>
      <Name>map_fiservmea_status_to_attempt_status</Name>
      <Input>&amp;FiservmeaTransactionResult</Input>
      <Output>common_enums::AttemptStatus</Output>
    </MappingFunction>

    <Mappings>
      <Mapping>
        <ConnectorStatus>Approved</ConnectorStatus>
        <ConnectorState>Authorized</ConnectorState>
        <AttemptStatus>Authorized</AttemptStatus>
        <Description>Pre-authorization successful</Description>
      </Mapping>
      <Mapping>
        <ConnectorStatus>Approved</ConnectorStatus>
        <ConnectorState>Captured</ConnectorState>
        <AttemptStatus>Charged</AttemptStatus>
        <Description>Transaction captured (auto-capture)</Description>
      </Mapping>
      <Mapping>
        <ConnectorStatus>Declined</ConnectorStatus>
        <ConnectorState>Declined</ConnectorState>
        <AttemptStatus>Failure</AttemptStatus>
        <Description>Transaction declined</Description>
      </Mapping>
      <Mapping>
        <ConnectorStatus>Failed</ConnectorStatus>
        <ConnectorState>Declined</ConnectorState>
        <AttemptStatus>Failure</AttemptStatus>
        <Description>Transaction failed</Description>
      </Mapping>
      <Mapping>
        <ConnectorStatus>Waiting</ConnectorStatus>
        <ConnectorState>Pending</ConnectorState>
        <AttemptStatus>Pending</AttemptStatus>
        <Description>Transaction pending (e.g., 3DS)</Description>
      </Mapping>
      <Mapping>
        <ConnectorStatus>Fraud</ConnectorStatus>
        <ConnectorState>Declined</ConnectorState>
        <AttemptStatus>Failure</AttemptStatus>
        <Description>Fraud detected</Description>
      </Mapping>
    </Mappings>

    <CriticalRules>
      <Rule>ALWAYS derive status from connector response</Rule>
      <Rule>NEVER hardcode status values</Rule>
      <Rule>Map ALL possible connector status values</Rule>
      <Rule>Use dedicated status enum, not String</Rule>
    </CriticalRules>
  </StatusMapping>

  <!-- ================================================================= -->
  <!-- AMOUNT CONVERSION -->
  <!-- ================================================================= -->
  <AmountConversion>
    <ConverterType>StringMajorUnit</ConverterType>
    <Description>FiservMEA expects amounts as strings in major units (e.g., "100.00" for $100.00)</Description>
    <Examples>
      <Example input="10000" minor="true" output="100.00"/>
      <Example input="500" minor="true" output="5.00"/>
      <Example input="123456" minor="true" output="1234.56"/>
    </Examples>
  </AmountConversion>

  <!-- ================================================================= -->
  <!-- FILE MODIFICATIONS -->
  <!-- ================================================================= -->
  <FileModifications>
    <FilesToModify>
      <File path="backend/connector-integration/src/connectors/fiservemea.rs">
        <Description>Main connector implementation file</Description>
        <Changes>
          <Change>Add module declaration: pub mod transformers;</Change>
          <Change>Add trait implementations for PaymentAuthorizeV2</Change>
          <Change>Add create_all_prerequisites! macro with Authorize flow</Change>
          <Change>Add macro_connector_implementation! for Authorize flow</Change>
          <Change>Implement ConnectorCommon trait</Change>
          <Change>Add build_headers method with signature authentication</Change>
          <Change>Add connector_base_url_payments method</Change>
        </Changes>
      </File>
      <File path="backend/connector-integration/src/connectors/fiservemea/transformers.rs">
        <Description>Data transformation logic file</Description>
        <Changes>
          <Change>Define FiservmeaAuthType struct</Change>
          <Change>Implement TryFrom for ConnectorAuthType</Change>
          <Change>Define all request structures</Change>
          <Change>Define all response structures</Change>
          <Change>Define error response structures</Change>
          <Change>Implement TryFrom for FiservmeaAuthorizeRequest</Change>
          <Change>Implement TryFrom for RouterDataV2 response transformation</Change>
          <Change>Implement status mapping function</Change>
        </Changes>
      </File>
    </FilesToModify>

    <FilesNotToModify>
      <File path="Any other file" reason="Scope limited to fiservemea.rs and fiservemea/transformers.rs only"/>
    </FilesNotToModify>
  </FileModifications>

  <!-- ================================================================= -->
  <!-- IMPLEMENTATION STEPS -->
  <!-- ================================================================= -->
  <ImplementationSteps>
    <Phase number="1" name="TECH_SPEC_VALIDATION">
      <Steps>
        <Step>Read and validate technical specification</Step>
        <Step>Extract connector requirements</Step>
        <Step>Identify supported features</Step>
        <Step>Document authentication mechanism</Step>
      </Steps>
    </Phase>

    <Phase number="2" name="MACRO_PATTERN_REFERENCE">
      <Steps>
        <Step>Study pattern_authorize.md</Step>
        <Step>Study macro_patterns_reference.md</Step>
        <Step>Study flow_macro_guide.md</Step>
        <Step>Review macro_templates.md</Step>
        <Step>Review Airwallex implementation</Step>
      </Steps>
    </Phase>

    <Phase number="3" name="MAIN CONNECTOR FILE">
      <Steps>
        <Step>Create fiservemea.rs file structure</Step>
        <Step>Add necessary imports</Step>
        <Step>Add trait implementations</Step>
        <Step>Configure create_all_prerequisites! macro</Step>
        <Step>Implement macro_connector_implementation! for Authorize</Step>
        <Step>Implement ConnectorCommon trait</Step>
        <Step>Add build_headers with signature authentication</Step>
      </Steps>
    </Phase>

    <Phase number="4" name="TRANSFORMERS FILE">
      <Steps>
        <Step>Create transformers.rs file</Step>
        <Step>Define authentication type</Step>
        <Step>Define request structures</Step>
        <Step>Define response structures</Step>
        <Step>Define error structures</Step>
        <Step>Implement request transformation</Step>
        <Step>Implement response transformation</Step>
        <Step>Implement status mapping</Step>
      </Steps>
    </Phase>

    <Phase number="5" name="VALIDATION">
      <Steps>
        <Step>Run cargo build</Step>
        <Step>Run cargo clippy</Step>
        <Step>Fix any compilation errors</Step>
        <Step>Verify Authorize flow implementation</Step>
      </Steps>
    </Phase>
  </ImplementationSteps>

  <!-- ================================================================= -->
  <!-- CODE QUALITY RULES -->
  <!-- ================================================================= -->
  <CodeQualityRules>
    <CriticalRules>
      <Rule>NEVER manually implement ConnectorIntegrationV2 - ALWAYS use macros</Rule>
      <Rule>ALWAYS add flow to create_all_prerequisites! before using macro_connector_implementation!</Rule>
      <Rule>Flow name MUST match exactly in both macros</Rule>
      <Rule>Request/Response types MUST match between macro and transformers</Rule>
      <Rule>ALWAYS use domain_types imports (not hyperswitch_*)</Rule>
      <Rule>ALWAYS use RouterDataV2 (not RouterData)</Rule>
      <Rule>Generic &lt;T&gt; needed for Authorize flow</Rule>
      <Rule>POST endpoints: always include curl_request parameter</Rule>
      <Rule>Remove all fields hardcoded to None</Rule>
      <Rule>Don't use Option unless truly optional per API spec</Rule>
      <Rule>NEVER hardcode status - always derive from connector response</Rule>
      <Rule>Use specific NotSupported errors with exact feature names</Rule>
      <Rule>Only include fields actually used by the connector API</Rule>
    </CriticalRules>

    <SerdeRules>
      <Rule>Rust fields: snake_case</Rule>
      <Rule>JSON: camelCase using #[serde(rename_all = "camelCase")]</Rule>
      <Rule>Enums: SCREAMING_SNAKE_CASE for connector-specific enums</Rule>
    </SerdeRules>

    <NamingConventions>
      <Convention type="Structs">PascalCase (e.g., FiservmeaAuthorizeRequest)</Convention>
      <Convention type="Fields">snake_case (e.g., transaction_amount)</Convention>
      <Convention type="Enums">PascalCase variants (e.g., Approved, Declined)</Convention>
      <Convention type="Functions">snake_case (e.g., map_fiservmea_status_to_attempt_status)</Convention>
    </NamingConventions>
  </CodeQualityRules>

  <!-- ================================================================= -->
  <!-- PROHIBITIONS -->
  <!-- ================================================================= -->
  <Prohibitions>
    <Prohibition>Implementing any flow other than Authorize</Prohibition>
    <Prohibition>Manually implementing ConnectorIntegrationV2 trait</Prohibition>
    <Prohibition>Mocked responses</Prohibition>
    <Prohibition>Using unwrap / expect</Prohibition>
    <Prohibition>Returning success on error</Prohibition>
    <Prohibition>Code that does not compile</Prohibition>
    <Prohibition>Skipping macro-based approach</Prohibition>
    <Prohibition>Adding fields "just in case"</Prohibition>
    <Prohibition>Modifying any core files other than fiservemea.rs and fiservemea/transformers.rs</Prohibition>
  </Prohibitions>

  <!-- ================================================================= -->
  <!-- VALIDATION CHECKLIST -->
  <!-- ================================================================= -->
  <ValidationChecklist>
    <Category name="Pre-Implementation">
      <Item>API Documentation reviewed</Item>
      <Item>Authentication requirements understood</Item>
      <Item>Request/response formats identified</Item>
      <Item>Status codes and meanings documented</Item>
      <Item>Pattern files studied</Item>
      <Item>Airwallex reference reviewed</Item>
    </Category>

    <Category name="Implementation">
      <Item>fiservemea.rs file created</Item>
      <Item>fiservemea/transformers.rs file created</Item>
      <Item>Trait implementations added</Item>
      <Item>create_all_prerequisites! configured</Item>
      <Item>macro_connector_implementation! added</Item>
      <Item>ConnectorCommon implemented</Item>
      <Item>Request structures defined</Item>
      <Item>Response structures defined</Item>
      <Item>Error structures defined</Item>
      <Item>Request transformation implemented</Item>
      <Item>Response transformation implemented</Item>
      <Item>Status mapping function implemented</Item>
    </Category>

    <Category name="Code Quality">
      <Item>cargo build succeeds</Item>
      <Item>cargo clippy passes</Item>
      <Item>No unwrap/expect usage</Item>
      <Item>No hardcoded status values</Item>
      <Item>All optional fields justified</Item>
      <Item>Proper error handling</Item>
      <Item>Correct trait bounds</Item>
    </Category>

    <Category name="Final Checks">
      <Item>ONLY Authorize flow implemented</Item>
      <Item>create_all_prerequisites! has Authorize flow</Item>
      <Item>macro_connector_implementation! used for Authorize</Item>
      <Item>Request/Response types match</Item>
      <Item>Status mapping function exists</Item>
      <Item>Signature authentication implemented</Item>
      <Item>Amount converter configured</Item>
    </Category>
  </ValidationChecklist>

  <!-- ================================================================= -->
  <!-- ERROR HANDLING -->
  <!-- ================================================================= -->
  <ErrorHandling>
    <ErrorResponses>
      <Error statusCode="400" responseType="BadRequest">
        <Description>The request cannot be validated</Description>
        <Causes>Invalid JSON format, missing required fields, invalid field values</Causes>
      </Error>
      <Error statusCode="401" responseType="Unauthenticated">
        <Description>The request cannot be authenticated</Description>
        <Causes>Invalid API key, incorrect message signature, expired timestamp</Causes>
      </Error>
      <Error statusCode="403" responseType="Unauthorized">
        <Description>The request was unauthorized</Description>
        <Causes>API key doesn't have permission for the operation</Causes>
      </Error>
      <Error statusCode="404" responseType="NotFound">
        <Description>The requested resource doesn't exist</Description>
        <Causes>Invalid transaction ID, resource has been deleted</Causes>
      </Error>
      <Error statusCode="409" responseType="GatewayDeclined">
        <Description>The attempted action is not valid</Description>
        <Causes>Duplicate order ID, transaction already processed</Causes>
      </Error>
      <Error statusCode="422" responseType="EndpointDeclined">
        <Description>The processor declined the transaction</Description>
        <Causes>Insufficient funds, invalid card details, card declined by issuer</Causes>
      </Error>
      <Error statusCode="500" responseType="ServerError">
        <Description>An unexpected internal server error occurred</Description>
        <Causes>Internal system error, temporary service disruption</Causes>
      </Error>
      <Error statusCode="502" responseType="EndpointCommunicationError">
        <Description>There was a problem communicating with the endpoint</Description>
        <Causes>Downstream service unavailable, network timeout</Causes>
      </Error>
    </ErrorResponses>

    <ErrorMapping>
      <Mapping>
        <ConnectorError>TRANSACTION_DECLINED</ConnectorError>
        <AttemptStatus>Failure</AttemptStatus>
      </Mapping>
      <Mapping>
        <ConnectorError>INSUFFICIENT_FUNDS</ConnectorError>
        <AttemptStatus>Failure</AttemptStatus>
      </Mapping>
      <Mapping>
        <ConnectorError>INVALID_CARD</ConnectorError>
        <AttemptStatus>Failure</AttemptStatus>
      </Mapping>
      <Mapping>
        <ConnectorError>EXPIRED_CARD</ConnectorError>
        <AttemptStatus>Failure</AttemptStatus>
      </Mapping>
      <Mapping>
        <ConnectorError>AUTHENTICATION_FAILED</ConnectorError>
        <AttemptStatus>AuthenticationFailed</AttemptStatus>
      </Mapping>
    </ErrorMapping>
  </ErrorHandling>

  <!-- ================================================================= -->
  <!-- SIGNATURE AUTHENTICATION DETAILS -->
  <!-- ================================================================= -->
  <SignatureAuthentication>
    <Algorithm>HMAC-SHA256</Algorithm>
    <Encoding>Base64</Encoding>
    <Components>
      <Component name="API-Key" source="ConnectorAuthType::SignatureKey.api_key"/>
      <Component name="Client-Request-Id" source="Generated UUID"/>
      <Component name="Timestamp" source="Current epoch milliseconds"/>
      <Component name="RequestBody" source="Serialized request JSON"/>
    </Components>
    <Validation>
      <Rule>Timestamp must be within 5 minutes of server time</Rule>
      <Rule>Client-Request-Id must be unique per request</Rule>
      <Rule>Signature must be calculated correctly</Rule>
    </Validation>
    <ImplementationNotes>
      <Note>Need to generate UUID for Client-Request-Id</Note>
      <Note>Need to get current timestamp in milliseconds</Note>
      <Note>Need to serialize request body to string</Note>
      <Note>Need to calculate HMAC-SHA256 signature</Note>
      <Note>Need to encode signature as Base64</Note>
    </ImplementationNotes>
  </SignatureAuthentication>

  <!-- ================================================================= -->
  <!-- DELIVERABLES -->
  <!-- ================================================================= -->
  <Deliverables>
    <Deliverable>
      <Name>fiservemea.rs</Name>
      <Path>backend/connector-integration/src/connectors/fiservemea.rs</Path>
      <Description>Main connector implementation with macro-based Authorize flow</Description>
    </Deliverable>
    <Deliverable>
      <Name>transformers.rs</Name>
      <Path>backend/connector-integration/src/connectors/fiservemea/transformers.rs</Path>
      <Description>Data transformation logic for request/response handling</Description>
    </Deliverable>
  </Deliverables>

  <!-- ================================================================= -->
  <!-- NOTES AND CONSIDERATIONS -->
  <!-- ================================================================= -->
  <Notes>
    <Note priority="HIGH">
      <Topic>Signature Authentication</Topic>
      <Description>FiservMEA requires complex signature authentication. Need to implement HMAC-SHA256 signature generation with Base64 encoding.</Description>
    </Note>
    <Note priority="HIGH">
      <Topic>Amount Format</Topic>
      <Description>FiservMEA expects amounts as strings in major units (e.g., "100.00"). Use StringMajorUnit converter.</Description>
    </Note>
    <Note priority="MEDIUM">
      <Topic>3D Secure</Topic>
      <Description>3D Secure authentication is supported but optional for initial implementation. Can be added later if needed.</Description>
    </Note>
    <Note priority="MEDIUM">
      <Topic>Pre-Auth vs Sale</Topic>
      <Description>Using PaymentCardPreAuthTransaction for Authorize flow. This requires PostAuthTransaction for completion (not in scope).</Description>
    </Note>
    <Note priority="LOW">
      <Topic>Order Management</Topic>
      <Description>Order information is optional but recommended for better tracking.</Description>
    </Note>
  </Notes>

  <!-- ================================================================= -->
  <!-- REFERENCES -->
  <!-- ================================================================= -->
  <References>
    <Reference>grace/rulesbook/codegen/references/fiservemea/technicalspecification.md</Reference>
    <Reference>guides/patterns/pattern_authorize.md</Reference>
    <Reference>guides/patterns/macro_patterns_reference.md</Reference>
    <Reference>guides/patterns/flow_macro_guide.md</Reference>
    <Reference>template-generation/macro_templates.md</Reference>
    <Reference>backend/connector-integration/src/connectors/airwallex.rs</Reference>
    <Reference>backend/connector-integration/src/connectors/airwallex/transformers.rs</Reference>
  </References>
</RequirementAnalysis>