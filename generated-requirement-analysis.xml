<?xml version="1.0" encoding="UTF-8"?>
<RequirementAnalysis xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                     xsi:noNamespaceSchemaLocation="requirement_analysis.xsd">
  <!-- ======================================================================== -->
  <!-- METADATA -->
  <!-- ======================================================================== -->
  <Metadata>
    <DocumentTitle>FiservEMEA Connector - Authorize Flow Requirement Analysis</DocumentTitle>
    <DocumentVersion>1.0.0</DocumentVersion>
    <GeneratedDate>2026-02-12</GeneratedDate>
    <ConnectorName>FiservEMEA</ConnectorName>
    <ConnectorDisplayName>Authipay Payments API (Fiserv EMEA)</ConnectorDisplayName>
    <Scope>Authorize Flow Only</Scope>
    <Architecture>Macro-Based UCS Connector Integration</Architecture>
  </Metadata>

  <!-- ======================================================================== -->
  <!-- CONNECTOR OVERVIEW -->
  <!-- ======================================================================== -->
  <ConnectorOverview>
    <Identification>
      <InternalName>fiservemea</InternalName>
      <PascalCaseName>Fiservemea</PascalCaseName>
      <DisplayName>Authipay Payments API</DisplayName>
      <Provider>Fiserv EMEA</Provider>
      <Region>EMEA (Europe, Middle East, Africa)</Region>
    </Identification>

    <APIEndpoints>
      <BaseURL>https://prod.emea.api.fiservapps.com/sandbox/ipp/payments-gateway/v2/payments</BaseURL>
      <ProductionURL>https://prod.emea.api.fiservapps.com/sandbox/ipp/payments-gateway/v2/payments</ProductionURL>
      <SandboxURL>https://prod.emea.api.fiservapps.com/sandbox/ipp/payments-gateway/v2/payments</SandboxURL>
    </APIEndpoints>

    <SupportedFlows>
      <Flow name="Authorize" status="IMPLEMENT" priority="HIGH">
        <Description>Pre-authorization of payment card transactions</Description>
        <RequestType>PaymentCardPreAuthTransaction</RequestType>
        <HTTPMethod>POST</HTTPMethod>
        <Endpoint>/payments</Endpoint>
      </Flow>
      <Flow name="Capture" status="NOT_IMPLEMENTED" priority="NONE"/>
      <Flow name="Refund" status="NOT_IMPLEMENTED" priority="NONE"/>
      <Flow name="Void" status="NOT_IMPLEMENTED" priority="NONE"/>
      <Flow name="PSync" status="NOT_IMPLEMENTED" priority="NONE"/>
      <Flow name="RSync" status="NOT_IMPLEMENTED" priority="NONE"/>
    </SupportedFlows>
  </ConnectorOverview>

  <!-- ======================================================================== -->
  <!-- AUTHENTICATION REQUIREMENTS -->
  <!-- ======================================================================== -->
  <Authentication>
    <Type>SignatureKey</Type>
    <Mechanism>Message Signature Authentication (HMAC-SHA256)</Mechanism>

    <RequiredHeaders>
      <Header name="Content-Type" required="true" value="application/json"/>
      <Header name="Api-Key" required="true" description="API Key from Developer Portal"/>
      <Header name="Client-Request-Id" required="true" description="UUID for request tracking and idempotency"/>
      <Header name="Timestamp" required="true" description="Epoch timestamp in milliseconds"/>
      <Header name="Message-Signature" required="true" description="Base64 encoded HMAC-SHA256 signature"/>
      <Header name="Message-Authentication-Value" required="false" description="Optional for Card Present transactions"/>
    </RequiredHeaders>

    <SignatureGeneration>
      <Algorithm>HMAC-SHA256</Algorithm>
      <SecretKey>API Secret from Developer Portal</SecretKey>
      <Process>
        <Step order="1">Concatenate: API-Key + ClientRequestId + Timestamp + RequestBody</Step>
        <Step order="2">Generate HMAC using SHA256 with API Secret as key</Step>
        <Step order="3">Apply HMAC to concatenated string</Step>
        <Step order="4">Encode result as Base64 string</Step>
      </Process>
    </SignatureGeneration>

    <ValidationRules>
      <Rule>Timestamp must be within 5 minutes of server time</Rule>
      <Rule>Client-Request-Id must be unique per request (recommended 128-bit UUID)</Rule>
      <Rule>Same Client-Request-Id will be echoed back in response</Rule>
    </ValidationRules>
  </Authentication>

  <!-- ======================================================================== -->
  <!-- AUTHORIZE FLOW SPECIFICATION -->
  <!-- ======================================================================== -->
  <AuthorizeFlow>
    <FlowDefinition>
      <FlowName>Authorize</FlowName>
      <FlowType>PaymentCardPreAuthTransaction</FlowType>
      <HTTPMethod>POST</HTTPMethod>
      <Endpoint>/payments</Endpoint>
      <FullURL>https://prod.emea.api.fiservapps.com/sandbox/ipp/payments-gateway/v2/payments</FullURL>
    </FlowDefinition>

    <TraitImplementation>
      <Trait>ConnectorIntegrationV2</Trait>
      <TypeParameters>
        <Parameter>Authorize</Parameter>
        <Parameter>PaymentFlowData</Parameter>
        <Parameter>PaymentsAuthorizeData&lt;T&gt;</Parameter>
        <Parameter>PaymentsResponseData</Parameter>
      </TypeParameters>
    </TraitImplementation>

    <MacroConfiguration>
      <Prerequisites>
        <Entry>
          <Flow>Authorize</Flow>
          <RequestBody>FiservemeaAuthorizeRequest&lt;T&gt;</RequestBody>
          <ResponseBody>FiservemeaAuthorizeResponse</ResponseBody>
          <RouterData>RouterDataV2&lt;Authorize, PaymentFlowData, PaymentsAuthorizeData&lt;T&gt;, PaymentsResponseData&gt;</RouterData>
        </Entry>
      </Prerequisites>

      <Implementation>
        <ConnectorDefaultImplementations>get_content_type, get_error_response_v2</ConnectorDefaultImplementations>
        <Connector>Fiservemea</Connector>
        <CurlRequest>Json(FiservemeaAuthorizeRequest)</CurlRequest>
        <CurlResponse>FiservemeaAuthorizeResponse</CurlResponse>
        <FlowName>Authorize</FlowName>
        <ResourceCommonData>PaymentFlowData</ResourceCommonData>
        <FlowRequest>PaymentsAuthorizeData&lt;T&gt;</FlowRequest>
        <FlowResponse>PaymentsResponseData</FlowResponse>
        <HTTPMethod>Post</HTTPMethod>
        <GenericType>T</GenericType>
        <Traits>PaymentMethodDataTypes + Debug + Sync + Send + 'static + Serialize</Traits>
      </Implementation>
    </MacroConfiguration>

    <!-- REQUEST STRUCTURE -->
    <RequestStructure>
      <StructName>FiservemeaAuthorizeRequest&lt;T&gt;</StructName>
      <Derives>Debug, Serialize</Derives>
      <SerdeAttributes>
        <Attribute name="rename_all" value="camelCase"/>
      </SerdeAttributes>

      <Fields>
        <Field name="requestType" type="String" required="true">
          <Description>Type of transaction request</Description>
          <FixedValue>PaymentCardPreAuthTransaction</FixedValue>
        </Field>

        <Field name="transactionAmount" type="FiservemeaTransactionAmount" required="true">
          <Description>Transaction amount details</Description>
          <NestedFields>
            <NestedField name="total" type="String" required="true">
              <Description>Total amount in decimal format (e.g., "100.00")</Description>
            </NestedField>
            <NestedField name="currency" type="String" required="true">
              <Description>ISO 4217 currency code (e.g., "GBP", "USD")</Description>
            </NestedField>
          </NestedFields>
        </Field>

        <Field name="paymentMethod" type="FiservemeaPaymentMethod&lt;T&gt;" required="true">
          <Description>Payment method details</Description>
        </Field>

        <Field name="order" type="Option&lt;FiservemeaOrder&gt;" required="false">
          <Description>Order information (optional)</Description>
          <NestedFields>
            <NestedField name="orderId" type="String" required="false">
              <Description>Merchant order ID</Description>
            </NestedField>
            <NestedField name="billing" type="Option&lt;FiservemeaBilling&gt;" required="false">
              <Description>Billing address information</Description>
            </NestedField>
          </NestedFields>
        </Field>
      </Fields>

      <Rules>
        <Rule>Remove any field that will always be None</Rule>
        <Rule>Don't use Option unless truly optional per API spec</Rule>
        <Rule>Use String for amount (decimal format)</Rule>
        <Rule>requestType must be "PaymentCardPreAuthTransaction"</Rule>
      </Rules>
    </RequestStructure>

    <!-- PAYMENT METHOD STRUCTURE -->
    <PaymentMethodStructure>
      <StructName>FiservemeaPaymentMethod&lt;T&gt;</StructName>
      <Derives>Debug, Serialize</Derives>
      <SerdeAttributes>
        <Attribute name="rename_all" value="camelCase"/>
      </SerdeAttributes>

      <Fields>
        <Field name="paymentCard" type="FiservemeaPaymentCard&lt;T&gt;" required="true">
          <Description>Payment card details</Description>
        </Field>
      </Fields>
    </PaymentMethodStructure>

    <PaymentCardStructure>
      <StructName>FiservemeaPaymentCard&lt;T&gt;</StructName>
      <Derives>Debug, Serialize</Derives>
      <SerdeAttributes>
        <Attribute name="rename_all" value="camelCase"/>
      </SerdeAttributes>

      <Fields>
        <Field name="number" type="RawCardNumber&lt;T&gt;" required="true">
          <Description>Card number (masked)</Description>
        </Field>
        <Field name="securityCode" type="Secret&lt;String&gt;" required="true">
          <Description>Card security code (CVV/CVC)</Description>
        </Field>
        <Field name="expiryDate" type="FiservemeaExpiryDate" required="true">
          <Description>Card expiry date</Description>
        </Field>
      </Fields>
    </PaymentCardStructure>

    <ExpiryDateStructure>
      <StructName>FiservemeaExpiryDate</StructName>
      <Derives>Debug, Serialize</Derives>
      <SerdeAttributes>
        <Attribute name="rename_all" value="camelCase"/>
      </SerdeAttributes>

      <Fields>
        <Field name="month" type="String" required="true">
          <Description>Expiry month (MM format)</Description>
        </Field>
        <Field name="year" type="String" required="true">
          <Description>Expiry year (YY format)</Description>
        </Field>
      </Fields>
    </ExpiryDateStructure>

    <!-- RESPONSE STRUCTURE -->
    <ResponseStructure>
      <StructName>FiservemeaAuthorizeResponse</StructName>
      <Derives>Debug, Deserialize</Derives>
      <SerdeAttributes>
        <Attribute name="rename_all" value="camelCase"/>
      </SerdeAttributes>

      <CoreFields>
        <Field name="clientRequestId" type="String" required="true">
          <Description>Echoed back from request header</Description>
        </Field>
        <Field name="apiTraceId" type="String" required="true">
          <Description>Request identifier for support logs</Description>
        </Field>
        <Field name="ipgTransactionId" type="String" required="true">
          <Description>The response transaction ID</Description>
        </Field>
        <Field name="orderId" type="String" required="true">
          <Description>Client Order ID or IPG generated ID</Description>
        </Field>
        <Field name="transactionType" type="String" required="true">
          <Description>Type of transaction (PREAUTH for authorize)</Description>
        </Field>
      </CoreFields>

      <StatusFields>
        <Field name="transactionResult" type="FiservemeaTransactionResult" required="true">
          <Description>Result of the operation</Description>
          <EnumValues>
            <EnumValue>APPROVED</EnumValue>
            <EnumValue>DECLINED</EnumValue>
            <EnumValue>FAILED</EnumValue>
            <EnumValue>WAITING</EnumValue>
            <EnumValue>PARTIAL</EnumValue>
            <EnumValue>FRAUD</EnumValue>
          </EnumValues>
        </Field>
        <Field name="transactionState" type="FiservemeaTransactionState" required="true">
          <Description>State of the current transaction</Description>
          <EnumValues>
            <EnumValue>AUTHORIZED</EnumValue>
            <EnumValue>CAPTURED</EnumValue>
            <EnumValue>DECLINED</EnumValue>
            <EnumValue>CHECKED</EnumValue>
            <EnumValue>COMPLETED_GET</EnumValue>
            <EnumValue>INITIALIZED</EnumValue>
            <EnumValue>PENDING</EnumValue>
            <EnumValue>READY</EnumValue>
            <EnumValue>TEMPLATE</EnumValue>
            <EnumValue>SETTLED</EnumValue>
            <EnumValue>VOIDED</EnumValue>
            <EnumValue>WAITING</EnumValue>
          </EnumValues>
        </Field>
        <Field name="approvalCode" type="Option&lt;String&gt;" required="false">
          <Description>Transaction approval code</Description>
        </Field>
        <Field name="schemeResponseCode" type="Option&lt;String&gt;" required="false">
          <Description>Scheme Response Code</Description>
        </Field>
        <Field name="errorMessage" type="Option&lt;String&gt;" required="false">
          <Description>Transaction error message</Description>
        </Field>
      </StatusFields>

      <AmountFields>
        <Field name="approvedAmount" type="Option&lt;FiservemeaAmount&gt;" required="false">
          <Description>Approved transaction amount</Description>
        </Field>
        <Field name="transactionAmount" type="Option&lt;FiservemeaAmount&gt;" required="false">
          <Description>Transaction amount</Description>
        </Field>
      </AmountFields>

      <ProcessorFields>
        <Field name="processor" type="Option&lt;FiservemeaProcessor&gt;" required="false">
          <Description>Processor response data</Description>
        </Field>
      </ProcessorFields>

      <PaymentMethodFields>
        <Field name="paymentMethodDetails" type="Option&lt;FiservemeaPaymentMethodDetails&gt;" required="false">
          <Description>Payment method used</Description>
        </Field>
      </PaymentMethodFields>

      <Rules>
        <Rule>Add ONLY fields that will be used</Rule>
        <Rule>Create enums for status fields instead of String</Rule>
        <Rule>Use Option for truly optional fields</Rule>
      </Rules>
    </ResponseStructure>

    <!-- STATUS ENUMS -->
    <StatusEnums>
      <Enum name="FiservemeaTransactionResult">
        <Variants>
          <Variant name="Approved"/>
          <Variant name="Declined"/>
          <Variant name="Failed"/>
          <Variant name="Waiting"/>
          <Variant name="Partial"/>
          <Variant name="Fraud"/>
        </Variants>
        <SerdeAttributes>
          <Attribute name="rename_all" value="SCREAMING_SNAKE_CASE"/>
        </SerdeAttributes>
      </Enum>

      <Enum name="FiservemeaTransactionState">
        <Variants>
          <Variant name="Authorized"/>
          <Variant name="Captured"/>
          <Variant name="Declined"/>
          <Variant name="Checked"/>
          <Variant name="CompletedGet"/>
          <Variant name="Initialized"/>
          <Variant name="Pending"/>
          <Variant name="Ready"/>
          <Variant name="Template"/>
          <Variant name="Settled"/>
          <Variant name="Voided"/>
          <Variant name="Waiting"/>
        </Variants>
        <SerdeAttributes>
          <Attribute name="rename_all" value="SCREAMING_SNAKE_CASE"/>
        </SerdeAttributes>
      </Enum>
    </StatusEnums>

    <!-- STATUS MAPPING -->
    <StatusMapping>
      <FunctionName>map_fiservemea_status_to_attempt_status</FunctionName>
      <Input>&amp;FiservemeaTransactionResult</Input>
      <Output>common_enums::AttemptStatus</Output>

      <MappingRules>
        <Rule>
          <ConnectorStatus>Approved</ConnectorStatus>
          <AttemptStatus>Authorized</AttemptStatus>
          <Description>Successful pre-authorization</Description>
        </Rule>
        <Rule>
          <ConnectorStatus>Declined</ConnectorStatus>
          <AttemptStatus>Failure</AttemptStatus>
          <Description>Transaction declined by processor</Description>
        </Rule>
        <Rule>
          <ConnectorStatus>Failed</ConnectorStatus>
          <AttemptStatus>Failure</AttemptStatus>
          <Description>Transaction processing failed</Description>
        </Rule>
        <Rule>
          <ConnectorStatus>Waiting</ConnectorStatus>
          <AttemptStatus>Pending</AttemptStatus>
          <Description>Transaction pending completion</Description>
        </Rule>
        <Rule>
          <ConnectorStatus>Fraud</ConnectorStatus>
          <AttemptStatus>Failure</AttemptStatus>
          <Description>Transaction flagged as fraud</Description>
        </Rule>
      </MappingRules>

      <AdditionalMappings>
        <Mapping>
          <Source>transactionState == Authorized</Source>
          <Target>AttemptStatus::Authorized</Target>
        </Mapping>
        <Mapping>
          <Source>transactionState == Declined</Source>
          <Target>AttemptStatus::Failure</Target>
        </Mapping>
        <Mapping>
          <Source>transactionState == Pending</Source>
          <Target>AttemptStatus::Pending</Target>
        </Mapping>
      </AdditionalMappings>

      <CriticalRules>
        <Rule>ALWAYS create dedicated status enum</Rule>
        <Rule>ALWAYS use mapping function in response transformers</Rule>
        <Rule>NEVER hardcode status values</Rule>
        <Rule>Map ALL possible connector status values from API docs</Rule>
        <Rule>Consider both transactionResult and transactionState for accurate mapping</Rule>
      </CriticalRules>
    </StatusMapping>
  </AuthorizeFlow>

  <!-- ======================================================================== -->
  <!-- ERROR HANDLING -->
  <!-- ======================================================================== -->
  <ErrorHandling>
    <ErrorResponseStructure>
      <StructName>FiservemeaErrorResponse</StructName>
      <Derives>Debug, Deserialize</Derives>
      <SerdeAttributes>
        <Attribute name="rename_all" value="camelCase"/>
      </SerdeAttributes>

      <Fields>
        <Field name="clientRequestId" type="String" required="true"/>
        <Field name="apiTraceId" type="String" required="true"/>
        <Field name="responseType" type="FiservemeaResponseType" required="true">
          <EnumValues>
            <EnumValue>BadRequest</EnumValue>
            <EnumValue>Unauthenticated</EnumValue>
            <EnumValue>Unauthorized</EnumValue>
            <EnumValue>NotFound</EnumValue>
            <EnumValue>GatewayDeclined</EnumValue>
            <EnumValue>EndpointDeclined</EnumValue>
            <EnumValue>ServerError</EnumValue>
            <EnumValue>EndpointCommunicationError</EnumValue>
            <EnumValue>UnsupportedMediaType</EnumValue>
          </EnumValues>
        </Field>
        <Field name="error" type="Option&lt;FiservemeaErrorDetail&gt;" required="false"/>
      </Fields>
    </ErrorResponseStructure>

    <ErrorDetailStructure>
      <StructName>FiservemeaErrorDetail</StructName>
      <Derives>Debug, Deserialize</Derives>
      <SerdeAttributes>
        <Attribute name="rename_all" value="camelCase"/>
      </SerdeAttributes>

      <Fields>
        <Field name="code" type="String" required="true"/>
        <Field name="message" type="String" required="true"/>
        <Field name="details" type="Option&lt;Vec&lt;FiservemeaErrorField&gt;&gt;" required="false"/>
        <Field name="declineReasonCode" type="Option&lt;String&gt;" required="false"/>
      </Fields>
    </ErrorDetailStructure>

    <HTTPStatusCodes>
      <StatusCode code="400" responseType="BadRequest">
        <Description>Invalid JSON format, missing required fields, invalid field values</Description>
      </StatusCode>
      <StatusCode code="401" responseType="Unauthenticated">
        <Description>Invalid API key, incorrect message signature, expired timestamp</Description>
      </StatusCode>
      <StatusCode code="403" responseType="Unauthorized">
        <Description>API key doesn't have permission for the operation</Description>
      </StatusCode>
      <StatusCode code="404" responseType="NotFound">
        <Description>Invalid transaction ID, resource has been deleted</Description>
      </StatusCode>
      <StatusCode code="409" responseType="GatewayDeclined">
        <Description>Duplicate order ID, transaction already processed</Description>
      </StatusCode>
      <StatusCode code="415" responseType="UnsupportedMediaType">
        <Description>Missing or incorrect Content-Type header</Description>
      </StatusCode>
      <StatusCode code="422" responseType="EndpointDeclined">
        <Description>Insufficient funds, invalid card details, card declined by issuer</Description>
      </StatusCode>
      <StatusCode code="500" responseType="ServerError">
        <Description>Internal system error, temporary service disruption</Description>
      </StatusCode>
      <StatusCode code="502" responseType="EndpointCommunicationError">
        <Description>Downstream service unavailable, network timeout</Description>
      </StatusCode>
    </HTTPStatusCodes>
  </ErrorHandling>

  <!-- ======================================================================== -->
  <!-- AMOUNT CONVERSION -->
  <!-- ======================================================================== -->
  <AmountConversion>
    <ConnectorFormat>Decimal String</ConnectorFormat>
    <Examples>
      <Example input="1000" minorUnits="true" output="10.00"/>
      <Example input="10000" minorUnits="true" output="100.00"/>
      <Example input="12345" minorUnits="true" output="123.45"/>
    </Examples>
    <ConverterType>StringMajorUnit</ConverterType>
    <Description>Convert from minor units (cents) to decimal string format</Description>
  </AmountConversion>

  <!-- ======================================================================== -->
  <!-- FILE STRUCTURE -->
  <!-- ======================================================================== -->
  <FileStructure>
    <Files>
      <File path="backend/connector-integration/src/connectors/fiservemea.rs">
        <Description>Main connector implementation file</Description>
        <Components>
          <Component>Module declarations</Component>
          <Component>Imports</Component>
          <Component>Trait implementations</Component>
          <Component>create_all_prerequisites! macro</Component>
          <Component>ConnectorCommon implementation</Component>
          <Component>macro_connector_implementation! for Authorize</Component>
          <Component>Stub implementations for unsupported flows</Component>
        </Components>
      </File>
      <File path="backend/connector-integration/src/connectors/fiservemea/transformers.rs">
        <Description>Data transformation logic</Description>
        <Components>
          <Component>Authentication type definition</Component>
          <Component>Request structures</Component>
          <Component>Response structures</Component>
          <Component>Error response structures</Component>
          <Component>Status enums</Component>
          <Component>Status mapping function</Component>
          <Component>Request transformer (TryFrom)</Component>
          <Component>Response transformer (TryFrom)</Component>
          <Component>Helper structs</Component>
        </Components>
      </File>
    </Files>
  </FileStructure>

  <!-- ======================================================================== -->
  <!-- IMPLEMENTATION STEPS -->
  <!-- ======================================================================== -->
  <ImplementationSteps>
    <Phase number="1" name="FILE_SETUP">
      <Tasks>
        <Task>Create directory: backend/connector-integration/src/connectors/fiservemea/</Task>
        <Task>Create file: backend/connector-integration/src/connectors/fiservemea.rs</Task>
        <Task>Create file: backend/connector-integration/src/connectors/fiservemea/transformers.rs</Task>
      </Tasks>
    </Phase>

    <Phase number="2" name="TRANSFORMERS_IMPLEMENTATION">
      <Tasks>
        <Task>Define FiservemeaAuthType struct</Task>
        <Task>Implement TryFrom&lt;&amp;ConnectorAuthType&gt; for FiservemeaAuthType</Task>
        <Task>Define all request structures (FiservemeaAuthorizeRequest, etc.)</Task>
        <Task>Define all response structures (FiservemeaAuthorizeResponse, etc.)</Task>
        <Task>Define status enums (FiservemeaTransactionResult, FiservemeaTransactionState)</Task>
        <Task>Implement map_fiservemea_status_to_attempt_status function</Task>
        <Task>Implement request transformer TryFrom</Task>
        <Task>Implement response transformer TryFrom</Task>
        <Task>Define FiservemeaRouterData helper struct</Task>
      </Tasks>
    </Phase>

    <Phase number="3" name="MAIN_CONNECTOR_IMPLEMENTATION">
      <Tasks>
        <Task>Add module declaration: pub mod transformers;</Task>
        <Task>Add all necessary imports</Task>
        <Task>Implement trait markers (ConnectorServiceTrait, PaymentAuthorizeV2)</Task>
        <Task>Add create_all_prerequisites! macro with Authorize flow</Task>
        <Task>Implement ConnectorCommon trait</Task>
        <Task>Implement build_headers member function</Task>
        <Task>Implement connector_base_url_payments member function</Task>
        <Task>Add macro_connector_implementation! for Authorize flow</Task>
        <Task>Add stub implementations for unsupported flows</Task>
      </Tasks>
    </Phase>

    <Phase number="4" name="CONFIGURATION">
      <Tasks>
        <Task>Add Fiservemea to ConnectorEnum in connector_types.rs</Task>
        <Task>Add base_url to Connectors struct in domain_types</Task>
        <Task>Update connector module exports</Task>
        <Task>Add connector to integration module</Task>
      </Tasks>
    </Phase>

    <Phase number="5" name="VALIDATION">
      <Tasks>
        <Task>Run cargo build</Task>
        <Task>Fix compilation errors</Task>
        <Task>Run cargo clippy</Task>
        <Task>Fix clippy warnings</Task>
        <Task>Run cargo fmt</Task>
        <Task>Verify no todos or mock implementations</Task>
      </Tasks>
    </Phase>

    <Phase number="6" name="COMPLETION">
      <Tasks>
        <Task>Mark generated-requirement-analysis.xml as generated-requirement-analysis.xml.resolved</Task>
      </Tasks>
    </Phase>
  </ImplementationSteps>

  <!-- ======================================================================== -->
  <!-- CODE GENERATION TEMPLATES -->
  <!-- ======================================================================== -->
  <CodeTemplates>
    <Template name="CREATE_ALL_PREREQUISITES">
      <Code>
        <![CDATA[
macros::create_all_prerequisites!(
    connector_name: Fiservemea,
    generic_type: T,
    api: [
        (
            flow: Authorize,
            request_body: FiservemeaAuthorizeRequest<T>,
            response_body: FiservemeaAuthorizeResponse,
            router_data: RouterDataV2<Authorize, PaymentFlowData, PaymentsAuthorizeData<T>, PaymentsResponseData>,
        ),
    ],
    amount_converters: [
        amount_converter: StringMajorUnit
    ],
    member_functions: {
        pub fn build_headers<F, FCD, Req, Res>(
            &self,
            req: &RouterDataV2<F, FCD, Req, Res>,
        ) -> CustomResult<Vec<(String, Maskable<String>)>, errors::ConnectorError> {
            let mut header = vec![(
                headers::CONTENT_TYPE.to_string(),
                "application/json".to_string().into(),
            )];
            let mut auth_header = self.get_auth_header(&req.connector_auth_type)?;
            header.append(&mut auth_header);
            Ok(header)
        }

        pub fn connector_base_url_payments<'a, F, Req, Res>(
            &self,
            req: &'a RouterDataV2<F, PaymentFlowData, Req, Res>,
        ) -> &'a str {
            &req.resource_common_data.connectors.fiservemea.base_url
        }
    }
);
        ]]>
      </Code>
    </Template>

    <Template name="MACRO_CONNECTOR_IMPLEMENTATION">
      <Code>
        <![CDATA[
macros::macro_connector_implementation!(
    connector_default_implementations: [get_content_type, get_error_response_v2],
    connector: Fiservemea,
    curl_request: Json(FiservemeaAuthorizeRequest),
    curl_response: FiservemeaAuthorizeResponse,
    flow_name: Authorize,
    resource_common_data: PaymentFlowData,
    flow_request: PaymentsAuthorizeData<T>,
    flow_response: PaymentsResponseData,
    http_method: Post,
    generic_type: T,
    [PaymentMethodDataTypes + Debug + Sync + Send + 'static + Serialize],
    other_functions: {
        fn get_headers(
            &self,
            req: &RouterDataV2<Authorize, PaymentFlowData, PaymentsAuthorizeData<T>, PaymentsResponseData>,
        ) -> CustomResult<Vec<(String, Maskable<String>)>, errors::ConnectorError> {
            self.build_headers(req)
        }

        fn get_url(
            &self,
            req: &RouterDataV2<Authorize, PaymentFlowData, PaymentsAuthorizeData<T>, PaymentsResponseData>,
        ) -> CustomResult<String, errors::ConnectorError> {
            let base_url = self.connector_base_url_payments(req);
            Ok(format!("{}/payments", base_url))
        }
    }
);
        ]]>
      </Code>
    </Template>

    <Template name="STATUS_MAPPING_FUNCTION">
      <Code>
        <![CDATA[
pub fn map_fiservemea_status_to_attempt_status(
    transaction_result: &FiservemeaTransactionResult,
    transaction_state: &FiservemeaTransactionState,
) -> common_enums::AttemptStatus {
    match transaction_result {
        FiservemeaTransactionResult::Approved => {
            match transaction_state {
                FiservemeaTransactionState::Authorized => common_enums::AttemptStatus::Authorized,
                FiservemeaTransactionState::Captured => common_enums::AttemptStatus::Charged,
                _ => common_enums::AttemptStatus::Authorized,
            }
        }
        FiservemeaTransactionResult::Declined => common_enums::AttemptStatus::Failure,
        FiservemeaTransactionResult::Failed => common_enums::AttemptStatus::Failure,
        FiservemeaTransactionResult::Waiting => common_enums::AttemptStatus::Pending,
        FiservemeaTransactionResult::Fraud => common_enums::AttemptStatus::Failure,
        FiservemeaTransactionResult::Partial => common_enums::AttemptStatus::Pending,
    }
}
        ]]>
      </Code>
    </Template>
  </CodeTemplates>

  <!-- ======================================================================== -->
  <!-- VALIDATION CHECKLIST -->
  <!-- ======================================================================== -->
  <ValidationChecklist>
    <Category name="CODE_QUALITY">
      <Check id="QC001" description="No unwrap() or expect() calls" required="true"/>
      <Check id="QC002" description="No TODO comments" required="true"/>
      <Check id="QC003" description="No mock implementations" required="true"/>
      <Check id="QC004" description="Code compiles without errors" required="true"/>
      <Check id="QC005" description="cargo clippy passes" required="true"/>
      <Check id="QC006" description="cargo fmt applied" required="true"/>
    </Category>

    <Category name="FLOW_IMPLEMENTATION">
      <Check id="FI001" description="ONLY Authorize flow implemented" required="true"/>
      <Check id="FI002" description="create_all_prerequisites! includes Authorize" required="true"/>
      <Check id="FI003" description="macro_connector_implementation! used for Authorize" required="true"/>
      <Check id="FI004" description="Flow names match exactly in both macros" required="true"/>
      <Check id="FI005" description="Request/Response types match between macros" required="true"/>
    </Category>

    <Category name="TRANSFORMERS">
      <Check id="TR001" description="Request structures defined" required="true"/>
      <Check id="TR002" description="Response structures defined" required="true"/>
      <Check id="TR003" description="Status enums created" required="true"/>
      <Check id="TR004" description="Status mapping function implemented" required="true"/>
      <Check id="TR005" description="Request transformer TryFrom implemented" required="true"/>
      <Check id="TR006" description="Response transformer TryFrom implemented" required="true"/>
      <Check id="TR007" description="No hardcoded status values" required="true"/>
    </Category>

    <Category name="AUTHENTICATION">
      <Check id="AU001" description="AuthType struct defined" required="true"/>
      <Check id="AU002" description="TryFrom for ConnectorAuthType implemented" required="true"/>
      <Check id="AU003" description="get_auth_header implemented" required="true"/>
      <Check id="AU004" description="Signature generation logic documented" required="true"/>
    </Category>

    <Category name="ERROR_HANDLING">
      <Check id="EH001" description="ErrorResponse structure defined" required="true"/>
      <Check id="EH002" description="build_error_response implemented" required="true"/>
      <Check id="EH003" description="Error codes mapped appropriately" required="true"/>
    </Category>

    <Category name="SERDE_RULES">
      <Check id="SR001" description="Rust fields use snake_case" required="true"/>
      <Check id="SR002" description="JSON uses camelCase via rename_all" required="true"/>
      <Check id="SR003" description="No unnecessary Option fields" required="true"/>
    </Category>
  </ValidationChecklist>

  <!-- ======================================================================== -->
  <!-- CRITICAL RULES -->
  <!-- ======================================================================== -->
  <CriticalRules>
    <Rule category="IMPLEMENTATION" priority="CRITICAL">
      <Description>NEVER manually implement ConnectorIntegrationV2 - ALWAYS use macros</Description>
    </Rule>
    <Rule category="IMPLEMENTATION" priority="CRITICAL">
      <Description>ALWAYS add flow to create_all_prerequisites! before using macro_connector_implementation!</Description>
    </Rule>
    <Rule category="IMPLEMENTATION" priority="CRITICAL">
      <Description>Flow name MUST match exactly in both macros</Description>
    </Rule>
    <Rule category="IMPLEMENTATION" priority="CRITICAL">
      <Description>Request/Response types MUST match between macro and transformers</Description>
    </Rule>
    <Rule category="IMPORTS" priority="CRITICAL">
      <Description>ALWAYS use domain_types imports (not hyperswitch_*)</Description>
    </Rule>
    <Rule category="TYPES" priority="CRITICAL">
      <Description>ALWAYS use RouterDataV2 (not RouterData)</Description>
    </Rule>
    <Rule category="GENERICS" priority="CRITICAL">
      <Description>Generic &lt;T&gt; needed for Authorize flow</Description>
    </Rule>
    <Rule category="HTTP" priority="CRITICAL">
      <Description>GET endpoints: omit curl_request parameter in macro</Description>
    </Rule>
    <Rule category="HTTP" priority="CRITICAL">
      <Description>POST/PUT endpoints: always include curl_request parameter</Description>
    </Rule>
    <Rule category="CLEAN_CODE" priority="CRITICAL">
      <Description>Remove all fields hardcoded to None - if always None, delete the field</Description>
    </Rule>
    <Rule category="CLEAN_CODE" priority="CRITICAL">
      <Description>Don't use Option unless truly optional per API spec</Description>
    </Rule>
    <Rule category="STATUS" priority="CRITICAL">
      <Description>NEVER hardcode status - always derive from connector response</Description>
    </Rule>
    <Rule category="ERRORS" priority="CRITICAL">
      <Description>Use specific NotSupported errors with exact feature names</Description>
    </Rule>
    <Rule category="SCOPE" priority="CRITICAL">
      <Description>Only include fields actually used by the connector API</Description>
    </Rule>
    <Rule category="SCOPE" priority="CRITICAL">
      <Description>Implementing any flow other than Authorize is INVALID</Description>
    </Rule>
  </CriticalRules>

  <!-- ======================================================================== -->
  <!-- ABSOLUTE PROHIBITIONS -->
  <!-- ======================================================================== -->
  <AbsoluteProhibitions>
    <Prohibition>Implementing any flow other than Authorize</Prohibition>
    <Prohibition>Manually implementing ConnectorIntegrationV2 trait</Prohibition>
    <Prohibition>Mocked responses</Prohibition>
    <Prohibition>unwrap / expect usage</Prohibition>
    <Prohibition>Returning success on error</Prohibition>
    <Prohibition>Code that does not compile</Prohibition>
    <Prohibition>Skipping macro-based approach</Prohibition>
    <Prohibition>Adding fields "just in case"</Prohibition>
    <Prohibition>Hardcoded status values</Prohibition>
    <Prohibition>TODO comments in production code</Prohibition>
  </AbsoluteProhibitions>

  <!-- ======================================================================== -->
  <!-- DELIVERABLES -->
  <!-- ======================================================================== -->
  <Deliverables>
    <Deliverable type="SOURCE_CODE" path="backend/connector-integration/src/connectors/fiservemea.rs">
      <Description>Main connector implementation with macro-based Authorize flow</Description>
    </Deliverable>
    <Deliverable type="SOURCE_CODE" path="backend/connector-integration/src/connectors/fiservemea/transformers.rs">
      <Description>Request/response transformers and status mapping</Description>
    </Deliverable>
    <Deliverable type="DOCUMENTATION" path="generated-requirement-analysis.xml">
      <Description>This requirement analysis document</Description>
    </Deliverable>
    <Deliverable type="COMPLETION_MARKER" path="generated-requirement-analysis.xml.resolved">
      <Description>Marker file indicating all requirements completed</Description>
    </Deliverable>
  </Deliverables>

  <!-- ======================================================================== -->
  <!-- FINAL SELF-CHECK -->
  <!-- ======================================================================== -->
  <FinalSelfCheck>
    <Check id="FSC001" description="ONLY Authorize flow implemented" status="PENDING"/>
    <Check id="FSC002" description="create_all_prerequisites! macro updated with Authorize flow" status="PENDING"/>
    <Check id="FSC003" description="macro_connector_implementation! used for Authorize flow" status="PENDING"/>
    <Check id="FSC004" description="Request/Response types defined in transformers.rs" status="PENDING"/>
    <Check id="FSC005" description="Status mapping function implemented" status="PENDING"/>
    <Check id="FSC006" description="cargo build succeeds" status="PENDING"/>
    <Check id="FSC007" description="cargo clippy passes" status="PENDING"/>
    <Check id="FSC008" description="No todos or mocks in code" status="PENDING"/>
    <Check id="FSC009" description="generated-requirement-analysis.xml.resolved created" status="PENDING"/>
  </FinalSelfCheck>

  <!-- ======================================================================== -->
  <!-- COMPLETION STEP -->
  <!-- ======================================================================== -->
  <CompletionStep>
    <Description>
      After all implementation tasks are completed successfully, execute the final step:
      Rename/move generated-requirement-analysis.xml to generated-requirement-analysis.xml.resolved
      to indicate that all requirements have been fulfilled.
    </Description>
    <Command>mv generated-requirement-analysis.xml generated-requirement-analysis.xml.resolved</Command>
    <Validation>
      <Condition>cargo build succeeds without errors</Condition>
      <Condition>cargo clippy passes without warnings</Condition>
      <Condition>All FinalSelfCheck items marked as COMPLETED</Condition>
      <Condition>No TODO comments in code</Condition>
      <Condition>No mock implementations</Condition>
    </Validation>
  </CompletionStep>
</RequirementAnalysis>