<?xml version="1.0" encoding="UTF-8"?>
<RequirementAnalysis>
  <Metadata>
    <DocumentTitle>FiservMEA Authorize Flow Requirement Analysis</DocumentTitle>
    <ConnectorName>FiservMEA</ConnectorName>
    <ConnectorDisplayName>Authipay Payments API</ConnectorName>
    <Flow>Authorize</Flow>
    <GeneratedDate>2026-02-13</GeneratedDate>
    <Version>1.0.0</Version>
  </Metadata>

  <!-- ========================================================= -->
  <!-- TECHNICAL SPECIFICATION SUMMARY                           -->
  <!-- ========================================================= -->
  <TechnicalSpecification>
    <ConnectorInformation>
      <Name>Authipay Payments API</Name>
      <Provider>Fiserv EMEA</Provider>
      <BaseURL>https://prod.emea.api.fiservapps.com/sandbox/ipp/payments-gateway/v2/payments</BaseURL>
      <ProductionURL>https://prod.emea.api.fiservapps.com/sandbox/ipp/payments-gateway/v2/payments</ProductionURL>
    </ConnectorInformation>

    <Authentication>
      <Method>Message Signature Authentication</Method>
      <RequiredHeaders>
        <Header>
          <Name>Content-Type</Name>
          <Value>application/json</Value>
          <Required>true</Required>
        </Header>
        <Header>
          <Name>Api-Key</Name>
          <Description>Key given to merchant after boarding</Description>
          <Required>true</Required>
        </Header>
        <Header>
          <Name>Client-Request-Id</Name>
          <Description>UUID for request tracking and idempotency</Description>
          <Required>true</Required>
        </Header>
        <Header>
          <Name>Timestamp</Name>
          <Description>Epoch timestamp in milliseconds</Description>
          <Required>true</Required>
        </Header>
        <Header>
          <Name>Message-Signature</Name>
          <Description>HMAC-SHA256 signature (Base64 encoded)</Description>
          <Required>true</Required>
        </Header>
        <Header>
          <Name>Message-Authentication-Value</Name>
          <Description>Optional for Card Present transactions</Description>
          <Required>false</Required>
        </Header>
      </RequiredHeaders>
      <SignatureGeneration>
        <Step1>Concatenate: API-Key + ClientRequestId + Timestamp + RequestBody</Step1>
        <Step2>Generate HMAC-SHA256 using API Secret as key</Step2>
        <Step3>Apply HMAC to concatenated string</Step3>
        <Step4>Encode result in Base64</Step4>
      </SignatureGeneration>
    </Authentication>

    <AuthorizeEndpoint>
      <URL>/payments</URL>
      <HTTPMethod>POST</HTTPMethod>
      <RequestType>PaymentCardSaleTransaction</RequestType>
      <AlternativeRequestType>PaymentCardPreAuthTransaction</AlternativeRequestType>
    </AuthorizeEndpoint>

    <AmountFormat>
      <Type>StringMajorUnit</Type>
      <Description>Decimal string (e.g., "100.00" for $100.00)</Description>
      <Examples>
        <Example>"13.00"</Example>
        <Example>"100.00"</Example>
        <Example>"150.00"</Example>
      </Examples>
    </AmountFormat>

    <SupportedFeatures>
      <Feature>3D Secure authentication</Feature>
      <Feature>PCI DSS compliance</Feature>
      <Feature>Order management</Feature>
      <Feature>Multiple payment methods (Card, Token, SEPA, Wallet, APM)</Feature>
      <Feature>Transaction inquiry</Feature>
    </SupportedFeatures>
  </TechnicalSpecification>

  <!-- ========================================================= -->
  <!-- FLOW SCOPE AND CONSTRAINTS                                -->
  <!-- ========================================================= -->
  <FlowScope>
    <AllowedFlows>
      <Flow>Authorize</Flow>
    </AllowedFlows>
    <ProhibitedFlows>
      <Flow>Capture</Flow>
      <Flow>Refund</Flow>
      <Flow>Void</Flow>
      <Flow>PSync</Flow>
      <Flow>RSync</Flow>
      <Flow>SetupMandate</Flow>
      <Flow>RepeatPayment</Flow>
      <Flow>Any other flow</Flow>
    </ProhibitedFlows>
    <Constraints>
      <Constraint>MUST use macro-based implementation</Constraint>
      <Constraint>MUST NOT manually implement ConnectorIntegrationV2 trait</Constraint>
      <Constraint>MUST add flow to create_all_prerequisites! macro FIRST</Constraint>
      <Constraint>MUST use PaymentFlowData as resource_common_data</Constraint>
      <Constraint>MUST use PaymentsAuthorizeData&lt;T&gt; as flow_request</Constraint>
      <Constraint>MUST use PaymentsResponseData as flow_response</Constraint>
      <Constraint>MUST implement ConnectorIntegrationV2&lt;Authorize, PaymentFlowData, PaymentsAuthorizeData&lt;T&gt;, PaymentsResponseData&gt;</Constraint>
    </Constraints>
  </FlowScope>

  <!-- ========================================================= -->
  <!-- FILES TO MODIFY                                           -->
  <!-- ========================================================= -->
  <FilesToModify>
    <File>
      <Path>backend/connector-integration/src/connectors/fiservemea.rs</Path>
      <Description>Main connector implementation file</Description>
      <Changes>
        <Change>Add trait implementations with generic types</Change>
        <Change>Add create_all_prerequisites! macro with Authorize flow</Change>
        <Change>Implement ConnectorCommon trait</Change>
        <Change>Implement Authorize flow with macro_connector_implementation!</Change>
        <Change>Add authentication header generation</Change>
        <Change>Add error response handling</Change>
      </Changes>
    </File>
    <File>
      <Path>backend/connector-integration/src/connectors/fiservemea/transformers.rs</Path>
      <Description>Data transformation logic file</Description>
      <Changes>
        <Change>Define FiservmeaAuthType</Change>
        <Change>Define FiservmeaAuthorizeRequest&lt;T&gt; struct</Change>
        <Change>Define FiservmeaAuthorizeResponse struct</Change>
        <Change>Define FiservmeaErrorResponse struct</Change>
        <Change>Define FiservmeaPaymentStatus enum</Change>
        <Change>Implement request transformer (TryFrom)</Change>
        <Change>Implement response transformer (TryFrom)</Change>
        <Change>Implement status mapping function</Change>
      </Changes>
    </File>
  </FilesToModify>

  <!-- ========================================================= -->
  <!-- MACRO CONFIGURATION                                       -->
  <!-- ========================================================= -->
  <MacroConfiguration>
    <PrerequisitesMacro>
      <MacroName>create_all_prerequisites!</MacroName>
      <Parameters>
        <Parameter>
          <Name>connector_name</Name>
          <Value>Fiservmea</Value>
        </Parameter>
        <Parameter>
          <Name>generic_type</Name>
          <Value>T</Value>
        </Parameter>
        <Parameter>
          <Name>api</Name>
          <Value>
            <FlowDefinition>
              <Flow>Authorize</Flow>
              <RequestBody>FiservmeaAuthorizeRequest&lt;T&gt;</RequestBody>
              <ResponseBody>FiservmeaAuthorizeResponse</ResponseBody>
              <RouterData>RouterDataV2&lt;Authorize, PaymentFlowData, PaymentsAuthorizeData&lt;T&gt;, PaymentsResponseData&gt;</RouterData>
            </FlowDefinition>
          </Value>
        </Parameter>
        <Parameter>
          <Name>amount_converters</Name>
          <Value>
            <Converter>
              <Name>amount_converter</Name>
              <Type>StringMajorUnit</Type>
            </Converter>
          </Value>
        </Parameter>
        <Parameter>
          <Name>member_functions</Name>
          <Value>
            <Functions>
              <Function>
                <Name>build_headers</Name>
                <Signature>pub fn build_headers&lt;F, FCD, Req, Res&gt;(&amp;self, req: &amp;RouterDataV2&lt;F, FCD, Req, Res&gt;) -&gt; CustomResult&lt;Vec&lt;(String, Maskable&lt;String&gt;)&gt;, ConnectorError&gt;</Signature>
                <Description>Build headers with authentication</Description>
              </Function>
              <Function>
                <Name>connector_base_url_payments</Name>
                <Signature>pub fn connector_base_url_payments&lt;'a, F, Req, Res&gt;(&amp;self, req: &amp;'a RouterDataV2&lt;F, PaymentFlowData, Req, Res&gt;) -&gt; &amp;'a str</Signature>
                <Description>Get base URL for payment operations</Description>
              </Function>
            </Functions>
          </Value>
        </Parameter>
      </Parameters>
    </PrerequisitesMacro>

    <ImplementationMacro>
      <MacroName>macro_connector_implementation!</MacroName>
      <Parameters>
        <Parameter>
          <Name>connector_default_implementations</Name>
          <Value>[get_content_type, get_error_response_v2]</Value>
        </Parameter>
        <Parameter>
          <Name>connector</Name>
          <Value>Fiservmea</Value>
        </Parameter>
        <Parameter>
          <Name>curl_request</Name>
          <Value>Json(FiservmeaAuthorizeRequest)</Value>
        </Parameter>
        <Parameter>
          <Name>curl_response</Name>
          <Value>FiservmeaAuthorizeResponse</Value>
        </Parameter>
        <Parameter>
          <Name>flow_name</Name>
          <Value>Authorize</Value>
        </Parameter>
        <Parameter>
          <Name>resource_common_data</Name>
          <Value>PaymentFlowData</Value>
        </Parameter>
        <Parameter>
          <Name>flow_request</Name>
          <Value>PaymentsAuthorizeData&lt;T&gt;</Value>
        </Parameter>
        <Parameter>
          <Name>flow_response</Name>
          <Value>PaymentsResponseData</Value>
        </Parameter>
        <Parameter>
          <Name>http_method</Name>
          <Value>Post</Value>
        </Parameter>
        <Parameter>
          <Name>generic_type</Name>
          <Value>T</Value>
        </Parameter>
        <Parameter>
          <Name>trait_bounds</Name>
          <Value>[PaymentMethodDataTypes + Debug + Sync + Send + 'static + Serialize]</Value>
        </Parameter>
        <Parameter>
          <Name>other_functions</Name>
          <Value>
            <Functions>
              <Function>
                <Name>get_headers</Name>
                <Implementation>self.build_headers(req)</Implementation>
              </Function>
              <Function>
                <Name>get_url</Name>
                <Implementation>format!("{}/payments", self.connector_base_url_payments(req))</Implementation>
              </Function>
            </Functions>
          </Value>
        </Parameter>
      </Parameters>
    </ImplementationMacro>
  </MacroConfiguration>

  <!-- ========================================================= -->
  <!-- REQUEST STRUCTURE SPECIFICATION                           -->
  <!-- ========================================================= -->
  <RequestStructure>
    <StructName>FiservmeaAuthorizeRequest&lt;T&gt;</StructName>
    <Derives>Debug, Serialize</Derives>
    <SerdeAttributes>
      <Attribute>rename_all = "camelCase"</Attribute>
    </SerdeAttributes>
    <Fields>
      <Field>
        <Name>request_type</Name>
        <Type>String</Type>
        <Required>true</Required>
        <FixedValue>PaymentCardSaleTransaction</FixedValue>
        <Description>Type of transaction to perform</Description>
      </Field>
      <Field>
        <Name>transaction_amount</Name>
        <Type>FiservmeaTransactionAmount</Type>
        <Required>true</Required>
        <Description>Transaction amount details</Description>
      </Field>
      <Field>
        <Name>payment_method</Name>
        <Type>FiservmeaPaymentMethod&lt;T&gt;</Type>
        <Required>true</Required>
        <Description>Payment method details</Description>
      </Field>
      <Field>
        <Name>order</Name>
        <Type>Option&lt;FiservmeaOrder&gt;</Type>
        <Required>false</Required>
        <Description>Order information (optional)</Description>
      </Field>
      <Field>
        <Name>authentication_request</Name>
        <Type>Option&lt;FiservmeaAuthenticationRequest&gt;</Type>
        <Required>false</Required>
        <Description>3D Secure authentication request (optional)</Description>
      </Field>
    </Fields>
    <NestedStructs>
      <Struct>
        <Name>FiservmeaTransactionAmount</Name>
        <Fields>
          <Field>
            <Name>total</Name>
            <Type>String</Type>
            <Required>true</Required>
            <Description>Total amount in major units (e.g., "100.00")</Description>
          </Field>
          <Field>
            <Name>currency</Name>
            <Type>String</Type>
            <Required>true</Required>
            <Description>ISO 4217 currency code (e.g., "GBP")</Description>
          </Field>
        </Fields>
      </Struct>
      <Struct>
        <Name>FiservmeaPaymentMethod&lt;T&gt;</Name>
        <Fields>
          <Field>
            <Name>payment_card</Name>
            <Type>Option&lt;FiservmeaPaymentCard&lt;T&gt;&gt;</Type>
            <Required>false</Required>
            <Description>Card payment details</Description>
          </Field>
        </Fields>
      </Struct>
      <Struct>
        <Name>FiservmeaPaymentCard&lt;T&gt;</Name>
        <Fields>
          <Field>
            <Name>number</Name>
            <Type>Secret&lt;String&gt;</Type>
            <Required>true</Required>
            <Description>Card number</Description>
          </Field>
          <Field>
            <Name>security_code</Name>
            <Type>Secret&lt;String&gt;</Type>
            <Required>true</Required>
            <Description>CVV/CVC code</Description>
          </Field>
          <Field>
            <Name>expiry_date</Name>
            <Type>FiservmeaExpiryDate</Type>
            <Required>true</Required>
            <Description>Card expiry date</Description>
          </Field>
        </Fields>
      </Struct>
      <Struct>
        <Name>FiservmeaExpiryDate</Name>
        <Fields>
          <Field>
            <Name>month</Name>
            <Type>String</Type>
            <Required>true</Required>
            <Description>Expiry month (MM)</Description>
          </Field>
          <Field>
            <Name>year</Name>
            <Type>String</Type>
            <Required>true</Required>
            <Description>Expiry year (YY)</Description>
          </Field>
        </Fields>
      </Struct>
      <Struct>
        <Name>FiservmeaOrder</Name>
        <Fields>
          <Field>
            <Name>order_id</Name>
            <Type>String</Type>
            <Required>true</Required>
            <Description>Merchant order ID</Description>
          </Field>
          <Field>
            <Name>billing</Name>
            <Type>Option&lt;FiservmeaBilling&gt;</Type>
            <Required>false</Required>
            <Description>Billing information</Description>
          </Field>
        </Fields>
      </Struct>
      <Struct>
        <Name>FiservmeaBilling</Name>
        <Fields>
          <Field>
            <Name>name</Name>
            <Type>String</Type>
            <Required>true</Required>
            <Description>Customer name</Description>
          </Field>
          <Field>
            <Name>customer_id</Name>
            <Type>Option&lt;String&gt;</Type>
            <Required>false</Required>
            <Description>Customer ID</Description>
          </Field>
        </Fields>
      </Struct>
      <Struct>
        <Name>FiservmeaAuthenticationRequest</Name>
        <Fields>
          <Field>
            <Name>authentication_type</Name>
            <Type>String</Type>
            <Required>true</Required>
            <FixedValue>Secure3D21AuthenticationRequest</FixedValue>
          </Field>
          <Field>
            <Name>term_url</Name>
            <Type>String</Type>
            <Required>true</Required>
            <Description>Return URL after 3DS authentication</Description>
          </Field>
          <Field>
            <Name>challenge_indicator</Name>
            <Type>String</Type>
            <Required>true</Required>
            <Description>3DS challenge indicator</Description>
          </Field>
        </Fields>
      </Struct>
    </NestedStructs>
  </RequestStructure>

  <!-- ========================================================= -->
  <!-- RESPONSE STRUCTURE SPECIFICATION                          -->
  <!-- ========================================================= -->
  <ResponseStructure>
    <StructName>FiservmeaAuthorizeResponse</StructName>
    <Derives>Debug, Deserialize</Derives>
    <SerdeAttributes>
      <Attribute>rename_all = "camelCase"</Attribute>
    </SerdeAttributes>
    <Fields>
      <Field>
        <Name>client_request_id</Name>
        <Type>String</Type>
        <Required>true</Required>
        <Description>Echoed back from request</Description>
      </Field>
      <Field>
        <Name>api_trace_id</Name>
        <Type>String</Type>
        <Required>true</Required>
        <Description>Request identifier for support</Description>
      </Field>
      <Field>
        <Name>ipg_transaction_id</Name>
        <Type>String</Type>
        <Required>true</Required>
        <Description>The response transaction ID</Description>
      </Field>
      <Field>
        <Name>order_id</Name>
        <Type>String</Type>
        <Required>false</Required>
        <Description>Client Order ID</Description>
      </Field>
      <Field>
        <Name>transaction_type</Name>
        <Type>String</Type>
        <Required>true</Required>
        <Description>Type of transaction (SALE, PREAUTH, etc.)</Description>
      </Field>
      <Field>
        <Name>transaction_result</Name>
        <Type>FiservmeaTransactionResult</Type>
        <Required>true</Required>
        <Description>Result of the operation</Description>
      </Field>
      <Field>
        <Name>transaction_state</Name>
        <Type>FiservmeaTransactionState</Type>
        <Required>true</Required>
        <Description>State of the transaction</Description>
      </Field>
      <Field>
        <Name>approval_code</Name>
        <Type>Option&lt;String&gt;</Type>
        <Required>false</Required>
        <Description>Transaction approval code</Description>
      </Field>
      <Field>
        <Name>scheme_response_code</Name>
        <Type>Option&lt;String&gt;</Type>
        <Required>false</Required>
        <Description>Scheme response code</Description>
      </Field>
      <Field>
        <Name>error_message</Name>
        <Type>Option&lt;String&gt;</Type>
        <Required>false</Required>
        <Description>Error message if failed</Description>
      </Field>
      <Field>
        <Name>approved_amount</Name>
        <Type>Option&lt;FiservmeaAmount&gt;</Type>
        <Required>false</Required>
        <Description>Approved amount</Description>
      </Field>
      <Field>
        <Name>processor</Name>
        <Type>Option&lt;FiservmeaProcessor&gt;</Type>
        <Required>false</Required>
        <Description>Processor response data</Description>
      </Field>
      <Field>
        <Name>payment_method_details</Name>
        <Type>Option&lt;FiservmeaPaymentMethodDetails&gt;</Type>
        <Required>false</Required>
        <Description>Payment method used</Description>
      </Field>
    </Fields>
    <NestedStructs>
      <Enum>
        <Name>FiservmeaTransactionResult</Name>
        <Variants>
          <Variant>APPROVED</Variant>
          <Variant>DECLINED</Variant>
          <Variant>FAILED</Variant>
          <Variant>WAITING</Variant>
          <Variant>PARTIAL</Variant>
          <Variant>FRAUD</Variant>
        </Variants>
      </Enum>
      <Enum>
        <Name>FiservmeaTransactionState</Name>
        <Variants>
          <Variant>AUTHORIZED</Variant>
          <Variant>CAPTURED</Variant>
          <Variant>DECLINED</Variant>
          <Variant>CHECKED</Variant>
          <Variant>COMPLETED_GET</Variant>
          <Variant>INITIALIZED</Variant>
          <Variant>PENDING</Variant>
          <Variant>READY</Variant>
          <Variant>TEMPLATE</Variant>
          <Variant>SETTLED</Variant>
          <Variant>VOIDED</Variant>
          <Variant>WAITING</Variant>
        </Variants>
      </Enum>
      <Struct>
        <Name>FiservmeaAmount</Name>
        <Fields>
          <Field>
            <Name>total</Name>
            <Type>f64</Type>
          </Field>
          <Field>
            <Name>currency</Name>
            <Type>String</Type>
          </Field>
        </Fields>
      </Struct>
      <Struct>
        <Name>FiservmeaProcessor</Name>
        <Fields>
          <Field>
            <Name>reference_number</Name>
            <Type>Option&lt;String&gt;</Type>
          </Field>
          <Field>
            <Name>authorization_code</Name>
            <Type>Option&lt;String&gt;</Type>
          </Field>
          <Field>
            <Name>response_code</Name>
            <Type>Option&lt;String&gt;</Type>
          </Field>
          <Field>
            <Name>response_message</Name>
            <Type>Option&lt;String&gt;</Type>
          </Field>
          <Field>
            <Name>security_code_response</Name>
            <Type>Option&lt;String&gt;</Type>
          </Field>
        </Fields>
      </Struct>
      <Struct>
        <Name>FiservmeaPaymentMethodDetails</Name>
        <Fields>
          <Field>
            <Name>payment_method_type</Name>
            <Type>Option&lt;String&gt;</Type>
          </Field>
          <Field>
            <Name>payment_method_brand</Name>
            <Type>Option&lt;String&gt;</Type>
          </Field>
        </Fields>
      </Struct>
    </NestedStructs>
  </ResponseStructure>

  <!-- ========================================================= -->
  <!-- ERROR RESPONSE STRUCTURE                                  -->
  <!-- ========================================================= -->
  <ErrorResponseStructure>
    <StructName>FiservmeaErrorResponse</StructName>
    <Derives>Debug, Deserialize</Derives>
    <SerdeAttributes>
      <Attribute>rename_all = "camelCase"</Attribute>
    </SerdeAttributes>
    <Fields>
      <Field>
        <Name>client_request_id</Name>
        <Type>String</Type>
      </Field>
      <Field>
        <Name>api_trace_id</Name>
        <Type>String</Type>
      </Field>
      <Field>
        <Name>response_type</Name>
        <Type>String</Type>
        <Description>BadRequest, Unauthenticated, Unauthorized, NotFound, GatewayDeclined, EndpointDeclined, ServerError, EndpointCommunicationError, UnsupportedMediaType</Description>
      </Field>
      <Field>
        <Name>error</Name>
        <Type>Option&lt;FiservmeaErrorDetail&gt;</Type>
      </Field>
      <Field>
        <Name>ipg_transaction_id</Name>
        <Type>Option&lt;String&gt;</Type>
      </Field>
      <Field>
        <Name>order_id</Name>
        <Type>Option&lt;String&gt;</Type>
      </Field>
      <Field>
        <Name>transaction_type</Name>
        <Type>Option&lt;String&gt;</Type>
      </Field>
      <Field>
        <Name>transaction_result</Name>
        <Type>Option&lt;String&gt;</Type>
      </Field>
      <Field>
        <Name>transaction_state</Name>
        <Type>Option&lt;String&gt;</Type>
      </Field>
      <Field>
        <Name>scheme_response_code</Name>
        <Type>Option&lt;String&gt;</Type>
      </Field>
      <Field>
        <Name>error_message</Name>
        <Type>Option&lt;String&gt;</Type>
      </Field>
    </Fields>
    <NestedStructs>
      <Struct>
        <Name>FiservmeaErrorDetail</Name>
        <Fields>
          <Field>
            <Name>code</Name>
            <Type>String</Type>
          </Field>
          <Field>
            <Name>message</Name>
            <Type>String</Type>
          </Field>
          <Field>
            <Name>details</Name>
            <Type>Option&lt;Vec&lt;FiservmeaErrorField&gt;&gt;</Type>
          </Field>
          <Field>
            <Name>decline_reason_code</Name>
            <Type>Option&lt;String&gt;</Type>
          </Field>
        </Fields>
      </Struct>
      <Struct>
        <Name>FiservmeaErrorField</Name>
        <Fields>
          <Field>
            <Name>field</Name>
            <Type>String</Type>
          </Field>
          <Field>
            <Name>message</Name>
            <Type>String</Type>
          </Field>
        </Fields>
      </Struct>
    </NestedStructs>
    <DefaultImplementation>
      <ErrorCode>UNKNOWN_ERROR</ErrorCode>
      <ErrorMessage>Unknown error occurred</ErrorMessage>
    </DefaultImplementation>
  </ErrorResponseStructure>

  <!-- ========================================================= -->
  <!-- STATUS MAPPING                                            -->
  <!-- ========================================================= -->
  <StatusMapping>
    <FunctionName>map_fiservmea_status_to_attempt_status</FunctionName>
    <InputType>&amp;FiservmeaTransactionResult</InputType>
    <OutputType>common_enums::AttemptStatus</OutputType>
    <MappingRules>
      <Rule>
        <Input>APPROVED</Input>
        <Output>Charged</Output>
        <Condition>When transaction_result is APPROVED and transaction_state is CAPTURED</Condition>
      </Rule>
      <Rule>
        <Input>APPROVED</Input>
        <Output>Authorized</Output>
        <Condition>When transaction_result is APPROVED and transaction_state is AUTHORIZED</Condition>
      </Rule>
      <Rule>
        <Input>DECLINED</Input>
        <Output>Failure</Output>
      </Rule>
      <Rule>
        <Input>FAILED</Input>
        <Output>Failure</Output>
      </Rule>
      <Rule>
        <Input>WAITING</Input>
        <Output>Pending</Output>
      </Rule>
      <Rule>
        <Input>PENDING</Input>
        <Output>Pending</Output>
        <Condition>When transaction_state is PENDING</Condition>
      </Rule>
      <Rule>
        <Input>FRAUD</Input>
        <Output>Failure</Output>
      </Rule>
      <Rule>
        <Input>PARTIAL</Input>
        <Output>Charged</Output>
        <Condition>Partial capture scenario</Condition>
      </Rule>
    </MappingRules>
    <CriticalRules>
      <Rule>ALWAYS create dedicated status enum</Rule>
      <Rule>ALWAYS use mapping function in response transformers</Rule>
      <Rule>NEVER hardcode status values</Rule>
      <Rule>Map ALL possible connector status values from API docs</Rule>
      <Rule>Consider both transaction_result and transaction_state for accurate mapping</Rule>
    </CriticalRules>
  </StatusMapping>

  <!-- ========================================================= -->
  <!-- AUTHENTICATION TYPE DEFINITION                            -->
  <!-- ========================================================= -->
  <AuthenticationType>
    <StructName>FiservmeaAuthType</StructName>
    <Derives>Debug</Derives>
    <Fields>
      <Field>
        <Name>api_key</Name>
        <Type>Secret&lt;String&gt;</Type>
        <Description>API Key from developer portal</Description>
      </Field>
      <Field>
        <Name>api_secret</Name>
        <Type>Secret&lt;String&gt;</Type>
        <Description>API Secret for signature generation</Description>
      </Field>
    </Fields>
    <TryFromImplementation>
      <SourceType>&amp;ConnectorAuthType</SourceType>
      <SupportedVariants>
        <Variant>SignatureKey { api_key, api_secret, .. }</Variant>
      </SupportedVariants>
      <ErrorOnMismatch>ConnectorError::FailedToObtainAuthType</ErrorOnMismatch>
    </TryFromImplementation>
    <HelperMethods>
      <Method>
        <Name>generate_signature</Name>
        <Signature>pub fn generate_signature(&amp;self, client_request_id: &amp;str, timestamp: i64, request_body: &amp;str) -&gt; String</Signature>
        <Description>Generate HMAC-SHA256 signature for request authentication</Description>
      </Method>
    </HelperMethods>
  </AuthenticationType>

  <!-- ========================================================= -->
  <!-- TRANSFORMER IMPLEMENTATIONS                               -->
  <!-- ========================================================= -->
  <TransformerImplementations>
    <RequestTransformer>
      <Trait>TryFrom</Trait>
      <InputType>FiservmeaRouterData&lt;RouterDataV2&lt;Authorize, PaymentFlowData, PaymentsAuthorizeData&lt;T&gt;, PaymentsResponseData&gt;, T&gt;</InputType>
      <OutputType>FiservmeaAuthorizeRequest&lt;T&gt;</OutputType>
      <TransformationSteps>
        <Step>
          <Description>Extract payment method data from router_data.request.payment_method_data</Description>
          <Logic>Match on PaymentMethodData::Card and transform to FiservmeaPaymentCard</Logic>
        </Step>
        <Step>
          <Description>Convert amount using amount_converter</Description>
          <Logic>Use StringMajorUnit converter for decimal string format</Logic>
        </Step>
        <Step>
          <Description>Build transaction_amount object</Description>
          <Logic>Include total (converted amount) and currency</Logic>
        </Step>
        <Step>
          <Description>Build payment_method object</Description>
          <Logic>Wrap card details in FiservmeaPaymentMethod</Logic>
        </Step>
        <Step>
          <Description>Build order object if available</Description>
          <Logic>Include order_id from connector_request_reference_id</Logic>
        </Step>
        <Step>
          <Description>Set request_type to "PaymentCardSaleTransaction"</Description>
          <Logic>Fixed value for authorize flow</Logic>
        </Step>
      </TransformationSteps>
      <ErrorHandling>
        <Error>NotImplemented("Payment Method", "Fiservmea")</Error>
        <Condition>When payment method is not Card</Condition>
      </ErrorHandling>
    </RequestTransformer>

    <ResponseTransformer>
      <Trait>TryFrom</Trait>
      <InputType>ResponseRouterData&lt;FiservmeaAuthorizeResponse, RouterDataV2&lt;Authorize, PaymentFlowData, PaymentsAuthorizeData&lt;T&gt;, PaymentsResponseData&gt;&gt;</InputType>
      <OutputType>RouterDataV2&lt;Authorize, PaymentFlowData, PaymentsAuthorizeData&lt;T&gt;, PaymentsResponseData&gt;</OutputType>
      <TransformationSteps>
        <Step>
          <Description>Map connector status to attempt status</Description>
          <Logic>Use map_fiservmea_status_to_attempt_status function</Logic>
        </Step>
        <Step>
          <Description>Extract network transaction ID</Description>
          <Logic>From processor.authorization_code or ipg_transaction_id</Logic>
        </Step>
        <Step>
          <Description>Build PaymentsResponseData::TransactionResponse</Description>
          <Logic>Include resource_id, network_txn_id, status_code</Logic>
        </Step>
        <Step>
          <Description>Update resource_common_data.status</Description>
          <Logic>Set to mapped attempt status</Logic>
        </Step>
      </TransformationSteps>
      <ResponseFieldsMapping>
        <Mapping>
          <Source>ipg_transaction_id</Source>
          <Target>resource_id (ResponseId::ConnectorTransactionId)</Target>
        </Mapping>
        <Mapping>
          <Source>processor.authorization_code</Source>
          <Target>network_txn_id</Target>
        </Mapping>
        <Mapping>
          <Source>order_id</Source>
          <Target>connector_response_reference_id</Target>
        </Mapping>
        <Mapping>
          <Source>transaction_result + transaction_state</Source>
          <Target>status (via mapping function)</Target>
        </Mapping>
      </ResponseFieldsMapping>
    </ResponseTransformer>
  </TransformerImplementations>

  <!-- ========================================================= -->
  <!-- CONNECTOR COMMON IMPLEMENTATION                            -->
  <!-- ========================================================= -->
  <ConnectorCommonImplementation>
    <Trait>ConnectorCommon</Trait>
    <Methods>
      <Method>
        <Name>id</Name>
        <ReturnType>&amp;'static str</ReturnType>
        <Implementation>"fiservmea"</Implementation>
      </Method>
      <Method>
        <Name>get_currency_unit</Name>
        <ReturnType>common_enums::CurrencyUnit</ReturnType>
        <Implementation>common_enums::CurrencyUnit::Base</Implementation>
        <Reason>FiservMEA uses major units (decimal strings)</Reason>
      </Method>
      <Method>
        <Name>base_url</Name>
        <ReturnType>&amp;'a str</ReturnType>
        <Implementation>connectors.fiservmea.base_url.as_ref()</Implementation>
      </Method>
      <Method>
        <Name>get_auth_header</Name>
        <ReturnType>CustomResult&lt;Vec&lt;(String, Maskable&lt;String&gt;)&gt;, ConnectorError&gt;</ReturnType>
        <Implementation>
          <Step1>Parse ConnectorAuthType to FiservmeaAuthType</Step1>
          <Step2>Return empty vec (headers built in build_headers with signature)</Step2>
        </Implementation>
      </Method>
      <Method>
        <Name>build_error_response</Name>
        <ReturnType>CustomResult&lt;ErrorResponse, ConnectorError&gt;</ReturnType>
        <Implementation>
          <Step1>Parse response as FiservmeaErrorResponse</Step1>
          <Step2>Set event_builder error response body</Step2>
          <Step3>Map error fields to ErrorResponse</Step3>
          <Step4>Map response_type to attempt_status if applicable</Step4>
        </Implementation>
      </Method>
    </Methods>
  </ConnectorCommonImplementation>

  <!-- ========================================================= -->
  <!-- HEADER GENERATION                                         -->
  <!-- ========================================================= -->
  <HeaderGeneration>
    <MethodName>build_headers</MethodName>
    <Signature>pub fn build_headers&lt;F, FCD, Req, Res&gt;(&amp;self, req: &amp;RouterDataV2&lt;F, FCD, Req, Res&gt;) -&gt; CustomResult&lt;Vec&lt;(String, Maskable&lt;String&gt;)&gt;, ConnectorError&gt;</Signature>
    <Headers>
      <Header>
        <Name>Content-Type</Name>
        <Value>application/json</Value>
      </Header>
      <Header>
        <Name>Api-Key</Name>
        <Value>auth.api_key</Value>
      </Header>
      <Header>
        <Name>Client-Request-Id</Name>
        <Value>Generated UUID</Value>
        <Generation>Use connector_request_reference_id or generate new UUID</Generation>
      </Header>
      <Header>
        <Name>Timestamp</Name>
        <Value>Current epoch milliseconds</Value>
        <Generation>System time in milliseconds since Unix epoch</Generation>
      </Header>
      <Header>
        <Name>Message-Signature</Name>
        <Value>HMAC-SHA256 signature</Value>
        <Generation>auth.generate_signature(client_request_id, timestamp, request_body)</Generation>
      </Header>
    </Headers>
    <SignatureGenerationLogic>
      <Step1>Get client_request_id from request or generate UUID</Step1>
      <Step2>Get current timestamp in milliseconds</Step2>
      <Step3>Serialize request body to JSON string</Step3>
      <Step4>Concatenate: api_key + client_request_id + timestamp + request_body</Step4>
      <Step5>Generate HMAC-SHA256 using api_secret</Step5>
      <Step6>Encode result in Base64</Step6>
    </SignatureGenerationLogic>
  </HeaderGeneration>

  <!-- ========================================================= -->
  <!-- URL CONSTRUCTION                                          -->
  <!-- ========================================================= -->
  <URLConstruction>
    <MethodName>get_url</MethodName>
    <Signature>fn get_url(&amp;self, req: &amp;RouterDataV2&lt;Authorize, PaymentFlowData, PaymentsAuthorizeData&lt;T&gt;, PaymentsResponseData&gt;) -&gt; CustomResult&lt;String, ConnectorError&gt;</Signature>
    <Implementation>format!("{}/payments", self.connector_base_url_payments(req))</Implementation>
    <BaseURLMethod>connector_base_url_payments</BaseURLMethod>
    <BaseURLSource>req.resource_common_data.connectors.fiservmea.base_url</BaseURLSource>
  </URLConstruction>

  <!-- ========================================================= -->
  <!-- IMPORT REQUIREMENTS                                       -->
  <!-- ========================================================= -->
  <ImportRequirements>
    <File>fiservemea.rs</File>
    <Imports>
      <Import>std::fmt::Debug</Import>
      <Import>common_enums::CurrencyUnit</Import>
      <Import>common_utils::{errors::CustomResult, events, ext_traits::ByteSliceExt, types::StringMajorUnit}</Import>
      <Import>domain_types::{connector_flow::*, connector_types::*, errors, payment_method_data::PaymentMethodDataTypes, router_data::{ConnectorAuthType, ErrorResponse}, router_data_v2::RouterDataV2, router_response_types::Response, types::Connectors}</Import>
      <Import>error_stack::ResultExt</Import>
      <Import>hyperswitch_masking::{Mask, Maskable}</Import>
      <Import>interfaces::{api::ConnectorCommon, connector_integration_v2::ConnectorIntegrationV2, connector_types}</Import>
      <Import>serde::Serialize</Import>
      <Import>transformers::{self as fiservmea, *}</Import>
      <Import>super::macros</Import>
      <Import>crate::{types::ResponseRouterData, with_error_response_body}</Import>
    </Imports>
  </ImportRequirements>
  <ImportRequirements>
    <File>fiservmea/transformers.rs</File>
    <Imports>
      <Import>crate::types::ResponseRouterData</Import>
      <Import>common_enums::AttemptStatus</Import>
      <Import>common_utils::types::StringMajorUnit</Import>
      <Import>domain_types::{connector_flow::Authorize, connector_types::{PaymentFlowData, PaymentsAuthorizeData, PaymentsResponseData, ResponseId}, errors, payment_method_data::PaymentMethodDataTypes, router_data::ConnectorAuthType, router_data_v2::RouterDataV2}</Import>
      <Import>hyperswitch_masking::{ExposeInterface, Secret}</Import>
      <Import>serde::{Deserialize, Serialize}</Import>
    </Imports>
  </ImportRequirements>

  <!-- ========================================================= -->
  <!-- TRAIT IMPLEMENTATIONS                                     -->
  <!-- ========================================================= -->
  <TraitImplementations>
    <Trait>
      <Name>ConnectorServiceTrait&lt;T&gt;</Name>
      <Bounds>PaymentMethodDataTypes + Debug + Sync + Send + 'static + Serialize</Bounds>
      <Implementation>Empty (auto-derived by macro)</Implementation>
    </Trait>
    <Trait>
      <Name>PaymentAuthorizeV2&lt;T&gt;</Name>
      <Bounds>PaymentMethodDataTypes + Debug + Sync + Send + 'static + Serialize</Bounds>
      <Implementation>Empty (auto-derived by macro)</Implementation>
    </Trait>
  </TraitImplementations>

  <!-- ========================================================= -->
  <!-- CODE QUALITY RULES                                        -->
  <!-- ========================================================= -->
  <CodeQualityRules>
    <CriticalRules>
      <Rule>NEVER manually implement ConnectorIntegrationV2 - ALWAYS use macros</Rule>
      <Rule>ALWAYS add flow to create_all_prerequisites! before using macro_connector_implementation!</Rule>
      <Rule>Flow name MUST match exactly in both macros</Rule>
      <Rule>Request/Response types MUST match between macro and transformers</Rule>
      <Rule>ALWAYS use domain_types imports (not hyperswitch_*)</Rule>
      <Rule>ALWAYS use RouterDataV2 (not RouterData)</Rule>
      <Rule>Generic &lt;T&gt; needed for Authorize flow</Rule>
      <Rule>POST endpoints: always include curl_request parameter in macro</Rule>
      <Rule>Remove all fields hardcoded to None - if always None, delete the field</Rule>
      <Rule>Don't use Option unless truly optional per API spec</Rule>
      <Rule>NEVER hardcode status - always derive from connector response</Rule>
      <Rule>Use specific NotSupported errors with exact feature names</Rule>
      <Rule>Only include fields actually used by the connector API</Rule>
      <Rule>Rust fields: snake_case</Rule>
      <Rule>JSON: camelCase using #[serde(rename_all = "camelCase")]</Rule>
    </CriticalRules>
    <BestPractices>
      <Practice>Use Secret&lt;String&gt; for sensitive data (API keys, card numbers, CVV)</Practice>
      <Practice>Use Maskable&lt;String&gt; for headers that contain sensitive data</Practice>
      <Practice>Provide specific error messages with payment method details</Practice>
      <Practice>Map all connector status values to appropriate attempt statuses</Practice>
      <Practice>Handle both transaction_result and transaction_state for accurate status mapping</Practice>
      <Practice>Generate unique Client-Request-Id for each request</Practice>
      <Practice>Validate timestamp is within 5 minutes of server time</Practice>
    </BestPractices>
  </CodeQualityRules>

  <!-- ========================================================= -->
  <!-- VALIDATION CHECKLIST                                      -->
  <!-- ========================================================= -->
  <ValidationChecklist>
    <PreImplementation>
      <Item>Read tech spec from grace/rulesbook/codegen/references/fiservemea/technicalspecification.md</Item>
      <Item>Read flow pattern: guides/patterns/pattern_authorize.md</Item>
      <Item>Read macro patterns: guides/patterns/macro_patterns_reference.md</Item>
      <Item>Read flow macro guide: guides/patterns/flow_macro_guide.md</Item>
      <Item>Read macro templates: template-generation/macro_templates.md</Item>
      <Item>Review Airwallex implementation for reference</Item>
    </PreImplementation>
    <Implementation>
      <Item>Create fiservmea.rs file with proper imports</Item>
      <Item>Create fiservemea/transformers.rs file</Item>
      <Item>Add trait implementations with generic types</Item>
      <Item>Add create_all_prerequisites! macro with Authorize flow</Item>
      <Item>Implement ConnectorCommon trait</Item>
      <Item>Implement Authorize flow with macro_connector_implementation!</Item>
      <Item>Define FiservmeaAuthType in transformers</Item>
      <Item>Define FiservmeaAuthorizeRequest&lt;T&gt; struct</Item>
      <Item>Define FiservmeaAuthorizeResponse struct</Item>
      <Item>Define FiservmeaErrorResponse struct</Item>
      <Item>Define FiservmeaTransactionResult enum</Item>
      <Item>Define FiservmeaTransactionState enum</Item>
      <Item>Implement request transformer (TryFrom)</Item>
      <Item>Implement response transformer (TryFrom)</Item>
      <Item>Implement status mapping function</Item>
      <Item>Implement signature generation helper</Item>
      <Item>Implement build_headers method</Item>
      <Item>Implement build_error_response method</Item>
    </Implementation>
    <PostImplementation>
      <Item>Run cargo build and fix all errors</Item>
      <Item>Run cargo test and ensure all tests pass</Item>
      <Item>Run cargo clippy and fix warnings</Item>
      <Item>Run cargo fmt for consistent formatting</Item>
      <Item>Verify ONLY Authorize flow is implemented</Item>
      <Item>Verify create_all_prerequisites! macro is correct</Item>
      <Item>Verify macro_connector_implementation! is correct</Item>
      <Item>Verify status mapping covers all cases</Item>
      <Item>Verify error handling is complete</Item>
      <Item>Verify no hardcoded status values</Item>
      <Item>Verify no fields hardcoded to None</Item>
    </PostImplementation>
  </ValidationChecklist>

  <!-- ========================================================= -->
  <!-- DELIVERABLES                                              -->
  <!-- ========================================================= -->
  <Deliverables>
    <Deliverable>
      <Name>backend/connector-integration/src/connectors/fiservemea.rs</Name>
      <Description>Main connector implementation file</Description>
      <Contains>
        <Item>Trait implementations</Item>
        <Item>create_all_prerequisites! macro</Item>
        <Item>ConnectorCommon implementation</Item>
        <Item>macro_connector_implementation! for Authorize</Item>
        <Item>build_headers method</Item>
        <Item>build_error_response method</Item>
      </Contains>
    </Deliverable>
    <Deliverable>
      <Name>backend/connector-integration/src/connectors/fiservemea/transformers.rs</Name>
      <Description>Data transformation logic file</Description>
      <Contains>
        <Item>FiservmeaAuthType definition</Item>
        <Item>FiservmeaAuthorizeRequest&lt;T&gt; struct</Item>
        <Item>FiservmeaAuthorizeResponse struct</Item>
        <Item>FiservmeaErrorResponse struct</Item>
        <Item>FiservmeaTransactionResult enum</Item>
        <Item>FiservmeaTransactionState enum</Item>
        <Item>Request transformer implementation</Item>
        <Item>Response transformer implementation</Item>
        <Item>Status mapping function</Item>
        <Item>Signature generation helper</Item>
      </Contains>
    </Deliverable>
  </Deliverables>

  <!-- ========================================================= -->
  <!-- ABSOLUTE PROHIBITIONS                                     -->
  <!-- ========================================================= -->
  <AbsoluteProhibitions>
    <Prohibition>Implementing any flow other than Authorize</Prohibition>
    <Prohibition>Manually implementing ConnectorIntegrationV2 trait</Prohibition>
    <Prohibition>Mocked responses</Prohibition>
    <Prohibition>Using unwrap / expect</Prohibition>
    <Prohibition>Returning success on error</Prohibition>
    <Prohibition>Skipping macro-based approach</Prohibition>
    <Prohibition>Adding fields "just in case"</Prohibition>
    <Prohibition>Hardcoding status values</Prohibition>
    <Prohibition>Modifying any core files other than fiservemea.rs and fiservemea/transformers.rs</Prohibition>
  </AbsoluteProhibitions>

  <!-- ========================================================= -->
  <!-- FINAL SELF-CHECK                                          -->
  <!-- ========================================================= -->
  <FinalSelfCheck>
    <Check>ONLY Authorize flow implemented</Check>
    <Check>create_all_prerequisites! macro updated with Authorize flow</Check>
    <Check>macro_connector_implementation! used for Authorize flow</Check>
    <Check>Request/Response types defined in transformers.rs</Check>
    <Check>Status mapping function implemented</Check>
    <Check>No hardcoded status values</Check>
    <Check>No fields hardcoded to None</Check>
    <Check>Only fiservemea.rs and fiservemea/transformers.rs modified</Check>
    <Check>Production-ready code (no todos or mocks)</Check>
  </FinalSelfCheck>
</RequirementAnalysis>