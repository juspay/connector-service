<?xml version="1.0" encoding="UTF-8"?>
<RequirementAnalysis xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <!-- ================================================================= -->
  <!-- METADATA -->
  <!-- ================================================================= -->
  <Metadata>
    <DocumentTitle>FiservEMEA Authorize Flow Requirement Analysis</DocumentTitle>
    <DocumentVersion>1.0</DocumentVersion>
    <GeneratedDate>2026-02-13</GeneratedDate>
    <ConnectorName>FiservEMEA</ConnectorName>
    <ConnectorDisplayName>Authipay Payments API</ConnectorName>
    <FlowScope>Authorize Only</FlowScope>
    <Architecture>Macro-Based UCS Connector Integration</Architecture>
  </Metadata>

  <!-- ================================================================= -->
  <!-- TECHNICAL SPECIFICATION SUMMARY -->
  <!-- ================================================================= -->
  <TechnicalSpecification>
    <ConnectorInformation>
      <Name>Authipay Payments API</Name>
      <Provider>Fiserv EMEA</Provider>
      <BaseUrls>
        <Production>https://prod.emea.api.fiservapps.com/sandbox/ipp/payments-gateway/v2/payments</Production>
        <Sandbox>https://prod.emea.api.fiservapps.com/sandbox/ipp/payments-gateway/v2/payments</Sandbox>
      </BaseUrls>
    </ConnectorInformation>

    <Authentication>
      <Method>Message Signature Authentication</Method>
      <RequiredHeaders>
        <Header>
          <Name>Content-Type</Name>
          <Value>application/json</Value>
          <Required>true</Required>
        </Header>
        <Header>
          <Name>Client-Request-Id</Name>
          <Value>UUID v4 (128-bit)</Value>
          <Required>true</Required>
          <Description>Client-generated ID for request tracking and signature creation, unique per request</Description>
        </Header>
        <Header>
          <Name>Api-Key</Name>
          <Value>API Key from Developer Portal</Value>
          <Required>true</Required>
          <Description>Key given to merchant after boarding</Description>
        </Header>
        <Header>
          <Name>Timestamp</Name>
          <Value>Epoch timestamp in milliseconds</Value>
          <Required>true</Required>
          <Description>Must be within 5 minutes of server time</Description>
        </Header>
        <Header>
          <Name>Message-Signature</Name>
          <Value>Base64 encoded HMAC-SHA256 signature</Value>
          <Required>true</Required>
          <Description>Generated from API-Key + ClientRequestId + Timestamp + requestBody</Description>
        </Header>
        <Header>
          <Name>Message-Authentication-Value</Name>
          <Value>Optional for Card Present transactions</Value>
          <Required>false</Required>
        </Header>
      </RequiredHeaders>
      <SignatureGeneration>
        <Algorithm>HMAC-SHA256</Algorithm>
        <SecretKey>API Secret from Developer Portal</SecretKey>
        <Process>
          <Step>Concatenate: API-Key + ClientRequestId + Timestamp + requestBody</Step>
          <Step>Generate HMAC using SHA256 with API Secret as key</Step>
          <Step>Apply HMAC to concatenated string</Step>
          <Step>Encode result in Base64</Step>
        </Process>
      </SignatureGeneration>
    </Authentication>

    <AuthorizeEndpoint>
      <Url>/payments</Url>
      <HttpMethod>POST</HttpMethod>
      <RequestType>PaymentCardPreAuthTransaction</RequestType>
      <Description>Pre-authorize an amount (requires completion via PostAuthTransaction)</Description>
    </AuthorizeEndpoint>

    <SupportedFeatures>
      <Feature>3D Secure authentication</Feature>
      <Feature>PCI DSS compliance</Feature>
      <Feature>Order management</Feature>
      <Feature>Multiple payment methods (Card, Token, SEPA, Wallet, APM)</Feature>
      <Feature>Transaction inquiry</Feature>
    </SupportedFeatures>
  </TechnicalSpecification>

  <!-- ================================================================= -->
  <!-- FLOW SCOPE DEFINITION -->
  <!-- ================================================================= -->
  <FlowScope>
    <IncludedFlows>
      <Flow>
        <Name>Authorize</Name>
        <Priority>HIGH</Priority>
        <Description>Pre-authorization of payment amount using PaymentCardPreAuthTransaction</Description>
      </Flow>
    </IncludedFlows>
    <ExcludedFlows>
      <Flow>Capture</Flow>
      <Flow>Refund</Flow>
      <Flow>Void</Flow>
      <Flow>PSync</Flow>
      <Flow>RSync</Flow>
      <Flow>SetupMandate</Flow>
      <Flow>All other flows</Flow>
    </ExcludedFlows>
  </FlowScope>

  <!-- ================================================================= -->
  <!-- MACRO CONFIGURATION -->
  <!-- ================================================================= -->
  <MacroConfiguration>
    <PrerequisitesMacro>
      <ConnectorName>Fiservemea</ConnectorName>
      <GenericType>T</GenericType>
      <ApiDefinitions>
        <ApiDefinition>
          <Flow>Authorize</Flow>
          <RequestBody>FiservemeaAuthorizeRequest&lt;T&gt;</RequestBody>
          <ResponseBody>FiservemeaAuthorizeResponse</ResponseBody>
          <RouterDataType>RouterDataV2&lt;Authorize, PaymentFlowData, PaymentsAuthorizeData&lt;T&gt;, PaymentsResponseData&gt;</RouterDataType>
        </ApiDefinition>
      </ApiDefinitions>
      <AmountConverters>
        <Converter>
          <Name>amount_converter</Name>
          <Type>StringMajorUnit</Type>
          <Reason>FiservEMEA API expects amounts as strings in major units (e.g., "100.00" for $100.00)</Reason>
        </Converter>
      </AmountConverters>
    </PrerequisitesMacro>

    <ImplementationMacro>
      <Connector>Fiservemea</Connector>
      <FlowName>Authorize</FlowName>
      <ResourceCommonData>PaymentFlowData</ResourceCommonData>
      <FlowRequest>PaymentsAuthorizeData&lt;T&gt;</FlowRequest>
      <FlowResponse>PaymentsResponseData</FlowResponse>
      <HttpMethod>Post</HttpMethod>
      <CurlRequest>Json(FiservemeaAuthorizeRequest)</CurlRequest>
      <CurlResponse>FiservemeaAuthorizeResponse</CurlResponse>
      <DefaultImplementations>
        <Implementation>get_content_type</Implementation>
        <Implementation>get_error_response_v2</Implementation>
      </DefaultImplementations>
      <GenericType>T</GenericType>
      <TraitBounds>PaymentMethodDataTypes + Debug + Sync + Send + 'static + Serialize</TraitBounds>
    </ImplementationMacro>
  </MacroConfiguration>

  <!-- ================================================================= -->
  <!-- REQUEST STRUCTURE SPECIFICATION -->
  <!-- ================================================================= -->
  <RequestStructure>
    <StructName>FiservemeaAuthorizeRequest&lt;T&gt;</StructName>
    <Derives>Debug, Serialize</Derives>
    <SerdeAttributes>
      <Attribute>rename_all = "camelCase"</Attribute>
    </SerdeAttributes>
    <Fields>
      <Field>
        <Name>request_type</Name>
        <Type>String</Type>
        <Required>true</Required>
        <FixedValue>"PaymentCardPreAuthTransaction"</FixedValue>
        <Description>Type of transaction to perform</Description>
      </Field>
      <Field>
        <Name>transaction_amount</Name>
        <Type>FiservemeaTransactionAmount</Type>
        <Required>true</Required>
        <Description>Transaction amount details</Description>
      </Field>
      <Field>
        <Name>payment_method</Name>
        <Type>FiservemeaPaymentMethod&lt;T&gt;</Type>
        <Required>true</Required>
        <Description>Payment method details</Description>
      </Field>
      <Field>
        <Name>order</Name>
        <Type>Option&lt;FiservemeaOrder&gt;</Type>
        <Required>false</Required>
        <Description>Order information including billing/shipping</Description>
      </Field>
      <Field>
        <Name>authentication_request</Name>
        <Type>Option&lt;FiservemeaAuthenticationRequest&gt;</Type>
        <Required>false</Required>
        <Description>3D Secure authentication request</Description>
      </Field>
    </Fields>
    <NestedStructures>
      <Struct>
        <Name>FiservemeaTransactionAmount</Name>
        <Fields>
          <Field>
            <Name>total</Name>
            <Type>String</Type>
            <Required>true</Required>
            <Description>Total amount in major units (e.g., "100.00")</Description>
          </Field>
          <Field>
            <Name>currency</Name>
            <Type>String</Type>
            <Required>true</Required>
            <Description>ISO 4217 currency code (e.g., "GBP", "USD")</Description>
          </Field>
        </Fields>
      </Struct>
      <Struct>
        <Name>FiservemeaPaymentMethod&lt;T&gt;</Name>
        <Fields>
          <Field>
            <Name>payment_card</Name>
            <Type>Option&lt;FiservemeaPaymentCard&lt;T&gt;&gt;</Type>
            <Required>true</Required>
            <Description>Card payment details</Description>
          </Field>
        </Fields>
      </Struct>
      <Struct>
        <Name>FiservemeaPaymentCard&lt;T&gt;</Name>
        <Fields>
          <Field>
            <Name>number</Name>
            <Type>RawCardNumber&lt;T&gt;</Type>
            <Required>true</Required>
            <Description>Card number</Description>
          </Field>
          <Field>
            <Name>security_code</Name>
            <Type>Secret&lt;String&gt;</Type>
            <Required>true</Required>
            <Description>CVV/CVC security code</Description>
          </Field>
          <Field>
            <Name>expiry_date</Name>
            <Type>FiservemeaExpiryDate</Type>
            <Required>true</Required>
            <Description>Card expiry date</Description>
          </Field>
        </Fields>
      </Struct>
      <Struct>
        <Name>FiservemeaExpiryDate</Name>
        <Fields>
          <Field>
            <Name>month</Name>
            <Type>String</Type>
            <Required>true</Required>
            <Description>Expiry month (e.g., "01", "12")</Description>
          </Field>
          <Field>
            <Name>year</Name>
            <Type>String</Type>
            <Required>true</Required>
            <Description>Expiry year in 2-digit format (e.g., "25", "29")</Description>
          </Field>
        </Fields>
      </Struct>
      <Struct>
        <Name>FiservemeaOrder</Name>
        <Fields>
          <Field>
            <Name>order_id</Name>
            <Type>String</Type>
            <Required>true</Required>
            <Description>Client Order ID</Description>
          </Field>
          <Field>
            <Name>billing</Name>
            <Type>Option&lt;FiservemeaAddress&gt;</Type>
            <Required>false</Required>
            <Description>Billing address</Description>
          </Field>
          <Field>
            <Name>shipping</Name>
            <Type>Option&lt;FiservemeaAddress&gt;</Type>
            <Required>false</Required>
            <Description>Shipping address</Description>
          </Field>
        </Fields>
      </Struct>
      <Struct>
        <Name>FiservemeaAddress</Name>
        <Fields>
          <Field>
            <Name>name</Name>
            <Type>Option&lt;String&gt;</Type>
            <Required>false</Required>
            <Description>Contact name</Description>
          </Field>
          <Field>
            <Name>address</Name>
            <Type>Option&lt;FiservemeaAddressDetails&gt;</Type>
            <Required>false</Required>
            <Description>Address details</Description>
          </Field>
        </Fields>
      </Struct>
      <Struct>
        <Name>FiservemeaAddressDetails</Name>
        <Fields>
          <Field>
            <Name>street</Name>
            <Type>Option&lt;String&gt;</Type>
            <Required>false</Required>
            <Description>Street address</Description>
          </Field>
          <Field>
            <Name>city</Name>
            <Type>Option&lt;String&gt;</Type>
            <Required>false</Required>
            <Description>City</Description>
          </Field>
          <Field>
            <Name>postal_code</Name>
            <Type>Option&lt;String&gt;</Type>
            <Required>false</Required>
            <Description>Postal/ZIP code</Description>
          </Field>
          <Field>
            <Name>country</Name>
            <Type>Option&lt;String&gt;</Type>
            <Required>false</Required>
            <Description>Country code (e.g., "GB", "US")</Description>
          </Field>
        </Fields>
      </Struct>
      <Struct>
        <Name>FiservemeaAuthenticationRequest</Name>
        <Fields>
          <Field>
            <Name>authentication_type</Name>
            <Type>String</Type>
            <Required>true</Required>
            <FixedValue>"Secure3D21AuthenticationRequest"</FixedValue>
          </Field>
          <Field>
            <Name>term_url</Name>
            <Type>String</Type>
            <Required>true</Required>
            <Description>URL for 3DS callback</Description>
          </Field>
          <Field>
            <Name>challenge_indicator</Name>
            <Type>String</Type>
            <Required>false</Required>
            <Description>Challenge indicator (e.g., "04")</Description>
          </Field>
        </Fields>
      </Struct>
    </NestedStructures>
  </RequestStructure>

  <!-- ================================================================= -->
  <!-- RESPONSE STRUCTURE SPECIFICATION -->
  <!-- ================================================================= -->
  <ResponseStructure>
    <StructName>FiservemeaAuthorizeResponse</StructName>
    <Derives>Debug, Deserialize</Derives>
    <SerdeAttributes>
      <Attribute>rename_all = "camelCase"</Attribute>
    </SerdeAttributes>
    <Fields>
      <Field>
        <Name>client_request_id</Name>
        <Type>String</Type>
        <Required>true</Required>
        <Description>Echoed back from request header for tracking</Description>
      </Field>
      <Field>
        <Name>api_trace_id</Name>
        <Type>String</Type>
        <Required>true</Required>
        <Description>Request identifier in API for support logs</Description>
      </Field>
      <Field>
        <Name>ipg_transaction_id</Name>
        <Type>String</Type>
        <Required>true</Required>
        <Description>The response transaction ID</Description>
      </Field>
      <Field>
        <Name>order_id</Name>
        <Type>String</Type>
        <Required>true</Required>
        <Description>Client Order ID or IPG-generated ID</Description>
      </Field>
      <Field>
        <Name>transaction_type</Name>
        <Type>String</Type>
        <Required>true</Required>
        <Description>Type of transaction (e.g., "PREAUTH")</Description>
      </Field>
      <Field>
        <Name>transaction_result</Name>
        <Type>FiservemeaTransactionResult</Type>
        <Required>true</Required>
        <Description>Result of the operation</Description>
      </Field>
      <Field>
        <Name>transaction_state</Name>
        <Type>FiservemeaTransactionState</Type>
        <Required>true</Required>
        <Description>State of the current transaction</Description>
      </Field>
      <Field>
        <Name>approval_code</Name>
        <Type>Option&lt;String&gt;</Type>
        <Required>false</Required>
        <Description>Transaction approval code</Description>
      </Field>
      <Field>
        <Name>scheme_response_code</Name>
        <Type>Option&lt;String&gt;</Type>
        <Required>false</Required>
        <Description>Scheme Response Code</Description>
      </Field>
      <Field>
        <Name>error_message</Name>
        <Type>Option&lt;String&gt;</Type>
        <Required>false</Required>
        <Description>Transaction error message</Description>
      </Field>
      <Field>
        <Name>approved_amount</Name>
        <Type>Option&lt;FiservemeaAmount&gt;</Type>
        <Required>false</Required>
        <Description>Approved amount</Description>
      </Field>
      <Field>
        <Name>processor</Name>
        <Type>Option&lt;FiservemeaProcessor&gt;</Type>
        <Required>false</Required>
        <Description>Processor response data</Description>
      </Field>
      <Field>
        <Name>payment_method_details</Name>
        <Type>Option&lt;FiservemeaPaymentMethodDetails&gt;</Type>
        <Required>false</Required>
        <Description>Payment method used</Description>
      </Field>
      <Field>
        <Name>authentication_response</Name>
        <Type>Option&lt;FiservemeaAuthenticationResponse&gt;</Type>
        <Required>false</Required>
        <Description>3DS authentication response</Description>
      </Field>
    </Fields>
    <NestedStructures>
      <Enum>
        <Name>FiservemeaTransactionResult</Name>
        <Variants>
          <Variant>Approved</Variant>
          <Variant>Declined</Variant>
          <Variant>Failed</Variant>
          <Variant>Waiting</Variant>
          <Variant>Partial</Variant>
          <Variant>Fraud</Variant>
        </Variants>
      </Enum>
      <Enum>
        <Name>FiservemeaTransactionState</Name>
        <Variants>
          <Variant>Authorized</Variant>
          <Variant>Captured</Variant>
          <Variant>Declined</Variant>
          <Variant>Checked</Variant>
          <Variant>CompletedGet</Variant>
          <Variant>Initialized</Variant>
          <Variant>Pending</Variant>
          <Variant>Ready</Variant>
          <Variant>Template</Variant>
          <Variant>Settled</Variant>
          <Variant>Voided</Variant>
          <Variant>Waiting</Variant>
        </Variants>
      </Enum>
      <Struct>
        <Name>FiservemeaAmount</Name>
        <Fields>
          <Field>
            <Name>total</Name>
            <Type>f64</Type>
            <Required>true</Required>
          </Field>
          <Field>
            <Name>currency</Name>
            <Type>String</Type>
            <Required>true</Required>
          </Field>
        </Fields>
      </Struct>
      <Struct>
        <Name>FiservemeaProcessor</Name>
        <Fields>
          <Field>
            <Name>reference_number</Name>
            <Type>Option&lt;String&gt;</Type>
          </Field>
          <Field>
            <Name>authorization_code</Name>
            <Type>Option&lt;String&gt;</Type>
          </Field>
          <Field>
            <Name>response_code</Name>
            <Type>Option&lt;String&gt;</Type>
          </Field>
          <Field>
            <Name>response_message</Name>
            <Type>Option&lt;String&gt;</Type>
          </Field>
          <Field>
            <Name>association_response_code</Name>
            <Type>Option&lt;String&gt;</Type>
          </Field>
          <Field>
            <Name>association_response_message</Name>
            <Type>Option&lt;String&gt;</Type>
          </Field>
          <Field>
            <Name>security_code_response</Name>
            <Type>Option&lt;FiservemeaSecurityCodeResponse&gt;</Type>
          </Field>
        </Fields>
      </Struct>
      <Enum>
        <Name>FiservemeaSecurityCodeResponse</Name>
        <Variants>
          <Variant>Matched</Variant>
          <Variant>NotMatched</Variant>
          <Variant>NotProcessed</Variant>
          <Variant>NotPresent</Variant>
          <Variant>NotCertified</Variant>
          <Variant>NotChecked</Variant>
        </Variants>
      </Enum>
      <Struct>
        <Name>FiservemeaPaymentMethodDetails</Name>
        <Fields>
          <Field>
            <Name>payment_method_type</Name>
            <Type>Option&lt;String&gt;</Type>
          </Field>
          <Field>
            <Name>payment_method_brand</Name>
            <Type>Option&lt;String&gt;</Type>
          </Field>
        </Fields>
      </Struct>
      <Struct>
        <Name>FiservemeaAuthenticationResponse</Name>
        <Fields>
          <Field>
            <Name>authentication_value</Name>
            <Type>Option&lt;String&gt;</Type>
          </Field>
          <Field>
            <Name>eci</Name>
            <Type>Option&lt;String&gt;</Type>
          </Field>
          <Field>
            <Name>version</Name>
            <Type>Option&lt;String&gt;</Type>
          </Field>
        </Fields>
      </Struct>
    </NestedStructures>
  </ResponseStructure>

  <!-- ================================================================= -->
  <!-- ERROR RESPONSE STRUCTURE -->
  <!-- ================================================================= -->
  <ErrorResponseStructure>
    <StructName>FiservemeaErrorResponse</StructName>
    <Derives>Debug, Deserialize</Derives>
    <SerdeAttributes>
      <Attribute>rename_all = "camelCase"</Attribute>
    </SerdeAttributes>
    <Fields>
      <Field>
        <Name>client_request_id</Name>
        <Type>String</Type>
        <Required>true</Required>
      </Field>
      <Field>
        <Name>api_trace_id</Name>
        <Type>String</Type>
        <Required>true</Required>
      </Field>
      <Field>
        <Name>response_type</Name>
        <Type>FiservemeaResponseType</Type>
        <Required>true</Required>
      </Field>
      <Field>
        <Name>error</Name>
        <Type>Option&lt;FiservemeaErrorDetail&gt;</Type>
        <Required>false</Required>
      </Field>
      <Field>
        <Name>ipg_transaction_id</Name>
        <Type>Option&lt;String&gt;</Type>
        <Required>false</Required>
      </Field>
      <Field>
        <Name>order_id</Name>
        <Type>Option&lt;String&gt;</Type>
        <Required>false</Required>
      </Field>
      <Field>
        <Name>transaction_type</Name>
        <Type>Option&lt;String&gt;</Type>
        <Required>false</Required>
      </Field>
      <Field>
        <Name>transaction_result</Name>
        <Type>Option&lt;FiservemeaTransactionResult&gt;</Type>
        <Required>false</Required>
      </Field>
      <Field>
        <Name>transaction_state</Name>
        <Type>Option&lt;FiservemeaTransactionState&gt;</Type>
        <Required>false</Required>
      </Field>
      <Field>
        <Name>scheme_response_code</Name>
        <Type>Option&lt;String&gt;</Type>
        <Required>false</Required>
      </Field>
      <Field>
        <Name>error_message</Name>
        <Type>Option&lt;String&gt;</Type>
        <Required>false</Required>
      </Field>
    </Fields>
    <NestedStructures>
      <Enum>
        <Name>FiservemeaResponseType</Name>
        <Variants>
          <Variant>BadRequest</Variant>
          <Variant>Unauthenticated</Variant>
          <Variant>Unauthorized</Variant>
          <Variant>NotFound</Variant>
          <Variant>GatewayDeclined</Variant>
          <Variant>EndpointDeclined</Variant>
          <Variant>ServerError</Variant>
          <Variant>EndpointCommunicationError</Variant>
          <Variant>UnsupportedMediaType</Variant>
        </Variants>
      </Enum>
      <Struct>
        <Name>FiservemeaErrorDetail</Name>
        <Fields>
          <Field>
            <Name>code</Name>
            <Type>String</Type>
            <Required>true</Required>
            <Description>Uniquely identifies an error condition</Description>
          </Field>
          <Field>
            <Name>message</Name>
            <Type>String</Type>
            <Required>true</Required>
            <Description>Generic description of the error condition</Description>
          </Field>
          <Field>
            <Name>details</Name>
            <Type>Option&lt;Vec&lt;FiservemeaErrorDetailItem&gt;&gt;</Type>
            <Required>false</Required>
          </Field>
          <Field>
            <Name>decline_reason_code</Name>
            <Type>Option&lt;String&gt;</Type>
            <Required>false</Required>
          </Field>
        </Fields>
      </Struct>
      <Struct>
        <Name>FiservemeaErrorDetailItem</Name>
        <Fields>
          <Field>
            <Name>field</Name>
            <Type>String</Type>
          </Field>
          <Field>
            <Name>message</Name>
            <Type>String</Type>
          </Field>
        </Fields>
      </Struct>
    </NestedStructures>
  </ErrorResponseStructure>

  <!-- ================================================================= -->
  <!-- STATUS MAPPING -->
  <!-- ================================================================= -->
  <StatusMapping>
    <FunctionName>map_fiservemea_status_to_attempt_status</FunctionName>
    <InputType>&amp;FiservemeaTransactionState</InputType>
    <OutputType>common_enums::AttemptStatus</OutputType>
    <MappingRules>
      <Mapping>
        <From>Authorized</From>
        <To>Authorized</To>
        <Description>Pre-authorization successful, awaiting capture</Description>
      </Mapping>
      <Mapping>
        <From>Captured</From>
        <To>Charged</To>
        <Description>Transaction captured successfully</Description>
      </Mapping>
      <Mapping>
        <From>Declined</From>
        <To>Failure</To>
        <Description>Transaction declined</Description>
      </Mapping>
      <Mapping>
        <From>Pending</From>
        <To>Pending</To>
        <Description>Transaction pending processing</Description>
      </Mapping>
      <Mapping>
        <From>Waiting</From>
        <To>Pending</To>
        <Description>Transaction waiting for action</Description>
      </Mapping>
      <Mapping>
        <From>Initialized</From>
        <To>Pending</To>
        <Description>Transaction initialized</Description>
      </Mapping>
      <Mapping>
        <From>Voided</From>
        <To>Voided</To>
        <Description>Transaction voided</Description>
      </Mapping>
      <Mapping>
        <From>Settled</From>
        <To>Charged</To>
        <Description>Transaction settled</Description>
      </Mapping>
      <Mapping>
        <From>Checked</From>
        <To>AuthenticationPending</To>
        <Description>3DS authentication in progress</Description>
      </Mapping>
      <Mapping>
        <From>CompletedGet</From>
        <To>Charged</To>
        <Description>Transaction completed</Description>
      </Mapping>
      <Mapping>
        <From>Ready</From>
        <To>Pending</To>
        <Description>Transaction ready for processing</Description>
      </Mapping>
      <Mapping>
        <From>Template</From>
        <To>Pending</To>
        <Description>Transaction template created</Description>
      </Mapping>
    </MappingRules>
    <TransactionResultMapping>
      <Mapping>
        <From>Approved</From>
        <To>Authorized</To>
        <Description>Transaction approved</Description>
      </Mapping>
      <Mapping>
        <From>Declined</From>
        <To>Failure</To>
        <Description>Transaction declined</Description>
      </Mapping>
      <Mapping>
        <From>Failed</From>
        <To>Failure</To>
        <Description>Transaction failed</Description>
      </Mapping>
      <Mapping>
        <From>Fraud</From>
        <To>Failure</To>
        <Description>Transaction flagged as fraud</Description>
      </Mapping>
      <Mapping>
        <From>Waiting</From>
        <To>Pending</To>
        <Description>Transaction waiting</Description>
      </Mapping>
      <Mapping>
        <From>Partial</From>
        <To>Charged</To>
        <Description>Partial authorization</Description>
      </Mapping>
    </TransactionResultMapping>
  </StatusMapping>

  <!-- ================================================================= -->
  <!-- AUTHENTICATION TYPE -->
  <!-- ================================================================= -->
  <AuthenticationType>
    <StructName>FiservemeaAuthType</StructName>
    <Fields>
      <Field>
        <Name>api_key</Name>
        <Type>Secret&lt;String&gt;</Type>
        <Required>true</Required>
        <Description>API Key from Developer Portal</Description>
      </Field>
      <Field>
        <Name>api_secret</Name>
        <Type>Secret&lt;String&gt;</Type>
        <Required>true</Required>
        <Description>API Secret for signature generation</Description>
      </Field>
    </Fields>
    <TryFromImplementation>
      <SourceType>ConnectorAuthType</SourceType>
      <MatchPattern>SignatureKey { api_key, api_secret, .. }</MatchPattern>
      <ErrorMessage>FailedToObtainAuthType</ErrorMessage>
    </TryFromImplementation>
    <HelperMethods>
      <Method>
        <Name>generate_client_request_id</Name>
        <ReturnType>String</ReturnType>
        <Description>Generate UUID v4 for Client-Request-Id header</Description>
      </Method>
      <Method>
        <Name>generate_timestamp</Name>
        <ReturnType>i64</ReturnType>
        <Description>Generate current epoch timestamp in milliseconds</Description>
      </Method>
      <Method>
        <Name>generate_message_signature</Name>
        <Parameters>
          <Parameter>
            <Name>client_request_id</Name>
            <Type>&amp;str</Type>
          </Parameter>
          <Parameter>
            <Name>timestamp</Name>
            <Type>i64</Type>
          </Parameter>
          <Parameter>
            <Name>request_body</Name>
            <Type>&amp;str</Type>
          </Parameter>
        </Parameters>
        <ReturnType>String</ReturnType>
        <Description>Generate HMAC-SHA256 signature and encode in Base64</Description>
      </Method>
    </HelperMethods>
  </AuthenticationType>

  <!-- ================================================================= -->
  <!-- TRANSFORMATION LOGIC -->
  <!-- ================================================================= -->
  <TransformationLogic>
    <RequestTransformation>
      <Source>RouterDataV2&lt;Authorize, PaymentFlowData, PaymentsAuthorizeData&lt;T&gt;, PaymentsResponseData&gt;</Source>
      <Target>FiservemeaAuthorizeRequest&lt;T&gt;</Target>
      <Steps>
        <Step>
          <Description>Extract payment method data</Description>
          <Logic>Match on PaymentMethodData::Card to extract card details</Logic>
        </Step>
        <Step>
          <Description>Convert amount to StringMajorUnit</Description>
          <Logic>Use amount_converter to convert minor_amount to major unit string</Logic>
        </Step>
        <Step>
          <Description>Build transaction amount</Description>
          <Logic>Create FiservemeaTransactionAmount with total and currency</Logic>
        </Step>
        <Step>
          <Description>Build payment method</Description>
          <Logic>Create FiservemeaPaymentMethod with card details</Logic>
        </Step>
        <Step>
          <Description>Build order (if available)</Description>
          <Logic>Extract order_id and billing/shipping addresses from router_data</Logic>
        </Step>
        <Step>
          <Description>Build authentication request (if 3DS enabled)</Description>
          <Logic>Include term_url and challenge_indicator if 3DS is configured</Logic>
        </Step>
      </Steps>
    </RequestTransformation>
    <ResponseTransformation>
      <Source>FiservemeaAuthorizeResponse</Source>
      <Target>RouterDataV2&lt;Authorize, PaymentFlowData, PaymentsAuthorizeData&lt;T&gt;, PaymentsResponseData&gt;</Target>
      <Steps>
        <Step>
          <Description>Map transaction state to attempt status</Description>
          <Logic>Use map_fiservemea_status_to_attempt_status function</Logic>
        </Step>
        <Step>
          <Description>Extract transaction ID</Description>
          <Logic>Use ipg_transaction_id as connector_transaction_id</Logic>
        </Step>
        <Step>
          <Description>Build PaymentsResponseData</Description>
          <Logic>Create TransactionResponse with resource_id, redirection_data, etc.</Logic>
        </Step>
        <Step>
          <Description>Handle 3DS response if present</Description>
          <Logic>Extract authentication_response for 3DS flows</Logic>
        </Step>
        <Step>
          <Description>Update resource_common_data status</Description>
          <Logic>Set status based on mapped attempt status</Logic>
        </Step>
      </Steps>
    </ResponseTransformation>
  </TransformationLogic>

  <!-- ================================================================= -->
  <!-- HEADER BUILDING -->
  <!-- ================================================================= -->
  <HeaderBuilding>
    <RequiredHeaders>
      <Header>
        <Name>Content-Type</Name>
        <Value>application/json</Value>
      </Header>
      <Header>
        <Name>Api-Key</Name>
        <Value>auth.api_key.peek()</Value>
      </Header>
      <Header>
        <Name>Client-Request-Id</Name>
        <Value>generate_client_request_id()</Value>
      </Header>
      <Header>
        <Name>Timestamp</Name>
        <Value>generate_timestamp().to_string()</Value>
      </Header>
      <Header>
        <Name>Message-Signature</Name>
        <Value>generate_message_signature(client_request_id, timestamp, request_body_json)</Value>
      </Header>
    </RequiredHeaders>
    <SpecialHandling>
      <Item>
        <Description>Message-Signature requires serialized request body</Description>
        <Implementation>Serialize request to JSON before generating signature</Implementation>
      </Item>
      <Item>
        <Description>Timestamp must be within 5 minutes of server time</Description>
        <Implementation>Generate fresh timestamp for each request</Implementation>
      </Item>
      <Item>
        <Description>Client-Request-Id must be unique per request</Description>
        <Implementation>Generate new UUID for each request</Implementation>
      </Item>
    </SpecialHandling>
  </HeaderBuilding>

  <!-- ================================================================= -->
  <!-- URL CONSTRUCTION -->
  <!-- ================================================================= -->
  <UrlConstruction>
    <BaseUrlMethod>connector_base_url_payments</BaseUrlMethod>
    <Endpoint>/payments</Endpoint>
    <FullUrlFormat>{base_url}/payments</FullUrlFormat>
    <HttpMethod>POST</HttpMethod>
  </UrlConstruction>

  <!-- ================================================================= -->
  <!-- ERROR HANDLING -->
  <!-- ================================================================= -->
  <ErrorHandling>
    <ErrorResponseParsing>
      <ParseAs>FiservemeaErrorResponse</ParseAs>
      <HandleEmptyResponse>Use default error response with UNKNOWN_ERROR</HandleEmptyResponse>
    </ErrorResponseParsing>
    <ErrorMapping>
      <Mapping>
        <ResponseType>BadRequest</ResponseType>
        <HttpStatusCode>400</HttpStatusCode>
        <AttemptStatus>Failure</AttemptStatus>
      </Mapping>
      <Mapping>
        <ResponseType>Unauthenticated</ResponseType>
        <HttpStatusCode>401</HttpStatusCode>
        <AttemptStatus>Failure</AttemptStatus>
      </Mapping>
      <Mapping>
        <ResponseType>Unauthorized</ResponseType>
        <HttpStatusCode>403</HttpStatusCode>
        <AttemptStatus>Failure</AttemptStatus>
      </Mapping>
      <Mapping>
        <ResponseType>NotFound</ResponseType>
        <HttpStatusCode>404</HttpStatusCode>
        <AttemptStatus>Failure</AttemptStatus>
      </Mapping>
      <Mapping>
        <ResponseType>GatewayDeclined</ResponseType>
        <HttpStatusCode>409</HttpStatusCode>
        <AttemptStatus>Failure</AttemptStatus>
      </Mapping>
      <Mapping>
        <ResponseType>EndpointDeclined</ResponseType>
        <HttpStatusCode>422</HttpStatusCode>
        <AttemptStatus>Failure</AttemptStatus>
      </Mapping>
      <Mapping>
        <ResponseType>ServerError</ResponseType>
        <HttpStatusCode>500</HttpStatusCode>
        <AttemptStatus>Failure</AttemptStatus>
      </Mapping>
      <Mapping>
        <ResponseType>EndpointCommunicationError</ResponseType>
        <HttpStatusCode>502</HttpStatusCode>
        <AttemptStatus>Failure</AttemptStatus>
      </Mapping>
    </ErrorMapping>
    <NetworkDeclineCodeExtraction>
      <Source>scheme_response_code</Source>
      <Fallback>processor.association_response_code</Fallback>
    </NetworkDeclineCodeExtraction>
  </ErrorHandling>

  <!-- ================================================================= -->
  <!-- FILE STRUCTURE -->
  <!-- ================================================================= -->
  <FileStructure>
    <Files>
      <File>
        <Path>backend/connector-integration/src/connectors/fiservemea.rs</Path>
        <Description>Main connector implementation file</Description>
        <Contents>
          <Content>Module declaration for transformers</Content>
          <Content>Imports from domain_types, common_utils, interfaces</Content>
          <Content>Trait implementations (ConnectorServiceTrait, PaymentAuthorizeV2)</Content>
          <Content>create_all_prerequisites! macro with Authorize flow</Content>
          <Content>ConnectorCommon trait implementation</Content>
          <Content>macro_connector_implementation! for Authorize flow</Content>
          <Content>Header constants module</Content>
        </Contents>
      </File>
      <File>
        <Path>backend/connector-integration/src/connectors/fiservemea/transformers.rs</Path>
        <Description>Data transformation logic file</Description>
        <Contents>
          <Content>FiservemeaAuthType struct and TryFrom implementation</Content>
          <Content>FiservemeaAuthorizeRequest&lt;T&gt; struct and nested types</Content>
          <Content>FiservemeaAuthorizeResponse struct and nested types</Content>
          <Content>FiservemeaErrorResponse struct and nested types</Content>
          <Content>Status enums (FiservemeaTransactionResult, FiservemeaTransactionState)</Content>
          <Content>map_fiservemea_status_to_attempt_status function</Content>
          <Content>TryFrom implementation for request transformation</Content>
          <Content>TryFrom implementation for response transformation</Content>
          <Content>FiservemeaRouterData helper struct</Content>
        </Contents>
      </File>
    </Files>
  </FileStructure>

  <!-- ================================================================= -->
  <!-- CODE GENERATION RULES -->
  <!-- ================================================================= -->
  <CodeGenerationRules>
    <CriticalRules>
      <Rule>
        <Priority>HIGHEST</Priority>
        <Description>ONLY implement Authorize flow - no other flows</Description>
      </Rule>
      <Rule>
        <Priority>HIGHEST</Priority>
        <Description>ALWAYS use macro_connector_implementation! - never manually implement ConnectorIntegrationV2</Description>
      </Rule>
      <Rule>
        <Priority>HIGHEST</Priority>
        <Description>ALWAYS add Authorize flow to create_all_prerequisites! before using macro_connector_implementation!</Description>
      </Rule>
      <Rule>
        <Priority>HIGHEST</Priority>
        <Description>NEVER hardcode status values - always derive from connector response</Description>
      </Rule>
      <Rule>
        <Priority>HIGHEST</Priority>
        <Description>Use PaymentFlowData as resource_common_data</Description>
      </Rule>
      <Rule>
        <Priority>HIGHEST</Priority>
        <Description>Use PaymentsAuthorizeData&lt;T&gt; as flow_request</Description>
      </Rule>
      <Rule>
        <Priority>HIGHEST</Priority>
        <Description>Use PaymentsResponseData as flow_response</Description>
      </Rule>
      <Rule>
        <Priority>HIGH</Priority>
        <Description>Implement ConnectorIntegrationV2&lt;Authorize, PaymentFlowData, PaymentsAuthorizeData&lt;T&gt;, PaymentsResponseData&gt;</Description>
      </Rule>
    </CriticalRules>
    <SerdeRules>
      <Rule>Rust fields: snake_case</Rule>
      <Rule>JSON: camelCase using #[serde(rename_all = "camelCase")]</Rule>
    </SerdeRules>
    <CodeQualityRules>
      <Rule>Remove all fields hardcoded to None - if always None, delete the field</Rule>
      <Rule>Don't use Option unless truly optional per API spec</Rule>
      <Rule>Use specific NotSupported errors with exact feature names</Rule>
      <Rule>Only include fields actually used by the connector API</Rule>
      <Rule>Use domain_types imports (not hyperswitch_*)</Rule>
      <Rule>Always use RouterDataV2 (not RouterData)</Rule>
      <Rule>Generic &lt;T&gt; needed for Authorize flow</Rule>
      <Rule>POST endpoints: always include curl_request parameter</Rule>
    </CodeQualityRules>
    <AbsoluteProhibitions>
      <Prohibition>Implementing any flow other than Authorize</Prohibition>
      <Prohibition>Manually implementing ConnectorIntegrationV2 trait</Prohibition>
      <Prohibition>Mocked responses</Prohibition>
      <Prohibition>Using unwrap / expect</Prohibition>
      <Prohibition>Returning success on error</Prohibition>
      <Prohibition>Skipping macro-based approach</Prohibition>
      <Prohibition>Adding fields "just in case"</Prohibition>
      <Prohibition>Changing any core files other than fiservemea.rs and fiservemea/transformers.rs</Prohibition>
    </AbsoluteProhibitions>
  </CodeGenerationRules>

  <!-- ================================================================= -->
  <!-- VALIDATION CHECKLIST -->
  <!-- ================================================================= -->
  <ValidationChecklist>
    <PreImplementation>
      <Check>Read technical specification from fiservemea/technicalspecification.md</Check>
      <Check>Read flow pattern from guides/patterns/pattern_authorize.md</Check>
      <Check>Read macro patterns from guides/patterns/macro_patterns_reference.md</Check>
      <Check>Read flow macro guide from guides/patterns/flow_macro_guide.md</Check>
      <Check>Review Airwallex implementation for macro usage patterns</Check>
    </PreImplementation>
    <Implementation>
      <Check>ONLY Authorize flow implemented</Check>
      <Check>create_all_prerequisites! macro updated with Authorize flow</Check>
      <Check>macro_connector_implementation! used for Authorize flow</Check>
      <Check>Request/Response types defined in transformers.rs</Check>
      <Check>Status mapping function implemented</Check>
      <Check>Authentication type defined with signature generation</Check>
      <Check>Headers built with all required FiservEMEA headers</Check>
      <Check>URL construction uses correct endpoint</Check>
    </Implementation>
    <PostImplementation>
      <Check>No todos or mock implementations in code</Check>
      <Check>Production-ready code quality</Check>
      <Check>All fields from API docs included</Check>
      <Check>No fields that will always be None</Check>
      <Check>Status derived from connector response, not hardcoded</Check>
      <Check>Error handling complete</Check>
      <Check>Only fiservemea.rs and fiservemea/transformers.rs modified</Check>
    </PostImplementation>
  </ValidationChecklist>

  <!-- ================================================================= -->
  <!-- REFERENCE IMPLEMENTATIONS -->
  <!-- ================================================================= -->
  <ReferenceImplementations>
    <Reference>
      <Name>Airwallex</Name>
      <Files>
        <File>backend/connector-integration/src/connectors/airwallex.rs</File>
        <File>backend/connector-integration/src/connectors/airwallex/transformers.rs</File>
      </Files>
      <PatternsToStudy>
        <Pattern>Macro usage in create_all_prerequisites!</Pattern>
        <Pattern>Macro usage in macro_connector_implementation!</Pattern>
        <Pattern>Request/Response struct definitions</Pattern>
        <Pattern>Status mapping functions</Pattern>
        <Pattern>Authentication type implementation</Pattern>
        <Pattern>Transformer TryFrom implementations</Pattern>
      </PatternsToStudy>
    </Reference>
  </ReferenceImplementations>

  <!-- ================================================================= -->
  <!-- DELIVERABLES -->
  <!-- ================================================================= -->
  <Deliverables>
    <Deliverable>
      <Name>fiservemea.rs</Name>
      <Path>backend/connector-integration/src/connectors/fiservemea.rs</Path>
      <Description>Main connector file with macro-based Authorize flow implementation</Description>
    </Deliverable>
    <Deliverable>
      <Name>transformers.rs</Name>
      <Path>backend/connector-integration/src/connectors/fiservemea/transformers.rs</Path>
      <Description>Transformers file with request/response types and transformation logic</Description>
    </Deliverable>
  </Deliverables>

  <!-- ================================================================= -->
  <!-- NOTES AND SPECIAL CONSIDERATIONS -->
  <!-- ================================================================= -->
  <Notes>
    <Note>
      <Category>Authentication</Category>
      <Description>FiservEMEA uses complex message signature authentication requiring HMAC-SHA256 with Base64 encoding. The signature must be generated from API-Key + ClientRequestId + Timestamp + requestBody concatenated together.</Description>
    </Note>
    <Note>
      <Category>Timestamp</Category>
      <Description>Timestamp must be in milliseconds since Unix Epoch and must be within 5 minutes of server time. Generate fresh timestamp for each request.</Description>
    </Note>
    <Note>
      <Category>Client-Request-Id</Category>
      <Description>Must be a unique UUID v4 for each request. This value is echoed back in the response for tracking.</Description>
    </Note>
    <Note>
      <Category>Amount Format</Category>
      <Description>FiservEMEA expects amounts as strings in major units (e.g., "100.00" for $100.00). Use StringMajorUnit converter.</Description>
    </Note>
    <Note>
      <Category>Card Expiry</Category>
      <Description>Card expiry year must be in 2-digit format (e.g., "25" for 2025, "29" for 2029).</Description>
    </Note>
    <Note>
      <Category>Transaction Type</Category>
      <Description>For Authorize flow, use "PaymentCardPreAuthTransaction" as request_type. This creates a pre-authorization that can be completed later via PostAuthTransaction.</Description>
    </Note>
    <Note>
      <Category>Status Mapping</Category>
      <Description>Both transaction_result and transaction_state should be considered when determining final status. transaction_state "Authorized" indicates successful pre-authorization.</Description>
    </Note>
    <Note>
      <Category>3DS Support</Category>
      <Description>3DS authentication is supported via authentication_request field. Include term_url and challenge_indicator when 3DS is required.</Description>
    </Note>
    <Note>
      <Category>Order ID</Category>
      <Description>If order_id is not supplied by client, IPG will generate one. The first 12 alphanumeric digits are passed to Fiserv Enterprise reporting tools.</Description>
    </Note>
  </Notes>
</RequirementAnalysis>