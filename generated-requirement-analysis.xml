<?xml version="1.0" encoding="UTF-8"?>
<RequirementAnalysis xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <Metadata>
    <Title>FiservMEA Authorize Flow Implementation Requirement Analysis</Title>
    <Version>1.0</Version>
    <GeneratedAt>2026-02-12</GeneratedAt>
    <ConnectorName>FiservMEA</ConnectorName>
    <ConnectorDisplayName>Authipay Payments API</ConnectorName>
    <Scope>Authorize Flow Only</Scope>
  </Metadata>

  <!-- ================================================================= -->
  <!-- EXECUTIVE SUMMARY -->
  <!-- ================================================================= -->
  <ExecutiveSummary>
    <Description>
      This requirement analysis defines the implementation of the Authorize flow for the FiservMEA (Authipay Payments API) connector using the GRACE-UCS macro-based architecture. The implementation follows strict guidelines: only the Authorize flow will be implemented, using macro_connector_implementation! pattern, with modifications limited to fiservemea.rs and fiservemea/transformers.rs files only.
    </Description>
    <KeyConstraints>
      <Constraint>ONLY Authorize flow implementation permitted</Constraint>
      <Constraint>MUST use macro-based approach (create_all_prerequisites! and macro_connector_implementation!)</Constraint>
      <Constraint>ONLY modify fiservemea.rs and fiservemea/transformers.rs</Constraint>
      <Constraint>NO manual ConnectorIntegrationV2 trait implementation</Constraint>
      <Constraint>Production-ready code with NO TODOs or mocks</Constraint>
    </KeyConstraints>
  </ExecutiveSummary>

  <!-- ================================================================= -->
  <!-- TECHNICAL SPECIFICATION ANALYSIS -->
  <!-- ================================================================= -->
  <TechnicalSpecification>
    <ConnectorInformation>
      <Name>Authipay Payments API</Name>
      <InternalName>FiservMEA</InternalName>
      <BaseUrls>
        <Production>https://prod.emea.api.fiservapps.com/sandbox/ipp/payments-gateway/v2/payments</Production>
        <Sandbox>https://prod.emea.api.fiservapps.com/sandbox/ipp/payments-gateway/v2/payments</Sandbox>
      </BaseUrls>
    </ConnectorInformation>

    <Authentication>
      <Method>Message Signature Authentication</Method>
      <Type>SignatureKey</Type>
      <Parameters>
        <Parameter name="Api-Key" type="String" required="true" description="Key given to merchant after boarding"/>
        <Parameter name="Client-Request-Id" type="String" required="true" description="UUID for request tracking and idempotency"/>
        <Parameter name="Timestamp" type="int64" required="true" description="Epoch timestamp in milliseconds"/>
        <Parameter name="Message-Signature" type="String" required="true" description="HMAC-SHA256 signature in Base64"/>
      </Parameters>
      <SignatureGenerationProcess>
        <Step>Concatenate: API-Key + ClientRequestId + Timestamp + requestBody</Step>
        <Step>Generate HMAC-SHA256 using API Secret as key</Step>
        <Step>Apply HMAC to concatenated string</Step>
        <Step>Encode result in Base64</Step>
      </SignatureGenerationProcess>
    </Authentication>

    <AuthorizeFlowEndpoint>
      <Url>/payments</Url>
      <HttpMethod>POST</HttpMethod>
      <ContentType>application/json</ContentType>
      <RequestType>PaymentCardPreAuthTransaction</RequestType>
      <Description>Pre-authorize an amount (requires completion via PostAuthTransaction)</Description>
    </AuthorizeFlowEndpoint>

    <RequestStructure>
      <RootField name="requestType" type="String" required="true" value="PaymentCardPreAuthTransaction"/>
      <Object name="transactionAmount">
        <Field name="total" type="String" required="true" description="Amount as string (e.g., '100.00')"/>
        <Field name="currency" type="String" required="true" description="ISO 4217 currency code"/>
      </Object>
      <Object name="paymentMethod">
        <Object name="paymentCard">
          <Field name="number" type="String" required="true"/>
          <Field name="securityCode" type="String" required="true"/>
          <Object name="expiryDate">
            <Field name="month" type="String" required="true"/>
            <Field name="year" type="String" required="true"/>
          </Object>
        </Object>
      </Object>
      <Object name="order" optional="true">
        <Field name="orderId" type="String" optional="true"/>
        <Object name="billing" optional="true">
          <Field name="name" type="String" optional="true"/>
          <Field name="customerId" type="String" optional="true"/>
        </Object>
      </Object>
    </RequestStructure>

    <ResponseStructure>
      <Field name="clientRequestId" type="String" description="Echoed from request"/>
      <Field name="apiTraceId" type="String" description="Request identifier for support"/>
      <Field name="ipgTransactionId" type="String" description="The response transaction ID"/>
      <Field name="orderId" type="String" description="Client Order ID"/>
      <Field name="transactionType" type="String" description="Type of transaction (PREAUTH)"/>
      <Field name="transactionResult" type="String" description="APPROVED, DECLINED, FAILED, WAITING, PARTIAL, FRAUD"/>
      <Field name="transactionState" type="String" description="AUTHORIZED, CAPTURED, DECLINED, CHECKED, COMPLETED_GET, INITIALIZED, PENDING, READY, TEMPLATE, SETTLED, VOIDED, WAITING"/>
      <Field name="approvalCode" type="String" description="Transaction approval code"/>
      <Field name="schemeResponseCode" type="String" description="Scheme Response Code"/>
      <Field name="errorMessage" type="String" description="Human readable error message"/>
      <Object name="approvedAmount">
        <Field name="total" type="number"/>
        <Field name="currency" type="String"/>
      </Object>
      <Object name="processor">
        <Field name="referenceNumber" type="String"/>
        <Field name="authorizationCode" type="String"/>
        <Field name="responseCode" type="String"/>
        <Field name="responseMessage" type="String"/>
        <Field name="securityCodeResponse" type="String" values="MATCHED, NOT_MATCHED, NOT_PROCESSED, NOT_PRESENT, NOT_CERTIFIED, NOT_CHECKED"/>
      </Object>
      <Object name="paymentMethodDetails">
        <Field name="paymentMethodType" type="String"/>
        <Field name="paymentMethodBrand" type="String"/>
      </Object>
    </ResponseStructure>

    <ErrorResponseStructure>
      <Field name="clientRequestId" type="String"/>
      <Field name="apiTraceId" type="String"/>
      <Field name="responseType" type="String" values="BadRequest, Unauthenticated, Unauthorized, NotFound, GatewayDeclined, EndpointDeclined, ServerError, EndpointCommunicationError, UnsupportedMediaType"/>
      <Object name="error">
        <Field name="code" type="String"/>
        <Field name="message" type="String"/>
        <Field name="details" type="Array">
          <Item>
            <Field name="field" type="String"/>
            <Field name="message" type="String"/>
          </Item>
        </Field>
        <Field name="declineReasonCode" type="String"/>
      </Object>
    </ErrorResponseStructure>

    <StatusMappings>
      <Mapping>
        <ConnectorStatus>APPROVED</ConnectorStatus>
        <ConnectorState>AUTHORIZED</ConnectorState>
        <AttemptStatus>Authorized</AttemptStatus>
      </Mapping>
      <Mapping>
        <ConnectorStatus>DECLINED</ConnectorStatus>
        <ConnectorState>DECLINED</ConnectorState>
        <AttemptStatus>Failure</AttemptStatus>
      </Mapping>
      <Mapping>
        <ConnectorStatus>FAILED</ConnectorStatus>
        <ConnectorState>DECLINED</ConnectorState>
        <AttemptStatus>Failure</AttemptStatus>
      </Mapping>
      <Mapping>
        <ConnectorStatus>WAITING</ConnectorStatus>
        <ConnectorState>PENDING</ConnectorState>
        <AttemptStatus>Pending</AttemptStatus>
      </Mapping>
      <Mapping>
        <ConnectorStatus>PARTIAL</ConnectorStatus>
        <ConnectorState>PENDING</ConnectorState>
        <AttemptStatus>Pending</AttemptStatus>
      </Mapping>
      <Mapping>
        <ConnectorStatus>FRAUD</ConnectorStatus>
        <ConnectorState>DECLINED</ConnectorState>
        <AttemptStatus>Failure</AttemptStatus>
      </Mapping>
    </StatusMappings>

    <AmountFormat>
      <Type>StringMajorUnit</Type>
      <Description>Amount as string with decimal (e.g., "100.00" for $100.00)</Description>
      <Examples>
        <Example input="10000" output="100.00"/>
        <Example input="500" output="5.00"/>
        <Example input="123456" output="1234.56"/>
      </Examples>
    </AmountFormat>
  </TechnicalSpecification>

  <!-- ================================================================= -->
  <!-- IMPLEMENTATION ARCHITECTURE -->
  <!-- ================================================================= -->
  <ImplementationArchitecture>
    <Approach>Macro-Based</Approach>
    <Framework>GRACE-UCS</Framework>
    <Language>Rust 2021</Language>

    <FilesToModify>
      <File path="backend/connector-integration/src/connectors/fiservemea.rs">
        <Purpose>Main connector implementation with macro setup</Purpose>
        <Changes>
          <Change>Add trait implementations for PaymentAuthorizeV2</Change>
          <Change>Add create_all_prerequisites! macro with Authorize flow</Change>
          <Change>Add macro_connector_implementation! for Authorize flow</Change>
          <Change>Implement ConnectorCommon trait</Change>
          <Change>Add authentication header generation</Change>
        </Changes>
      </File>
      <File path="backend/connector-integration/src/connectors/fiservemea/transformers.rs">
        <Purpose>Data transformation structures and implementations</Purpose>
        <Changes>
          <Change>Define FiservmeaAuthType for SignatureKey authentication</Change>
          <Change>Define FiservmeaAuthorizeRequest struct</Change>
          <Change>Define FiservmeaAuthorizeResponse struct</Change>
          <Change>Define FiservmeaErrorResponse struct</Change>
          <Change>Define status enums (FiservmeaTransactionResult, FiservmeaTransactionState)</Change>
          <Change>Implement TryFrom for request transformation</Change>
          <Change>Implement TryFrom for response transformation</Change>
          <Change>Implement status mapping function</Change>
        </Changes>
      </File>
    </FilesToModify>

    <FilesNotToModify>
      <File>Any other connector files</File>
      <File>Core framework files</File>
      <File>Domain types files</File>
      <File>Common utilities files</File>
    </FilesNotToModify>
  </ImplementationArchitecture>

  <!-- ================================================================= -->
  <!-- MACRO CONFIGURATION -->
  <!-- ================================================================= -->
  <MacroConfiguration>
    <PrerequisitesMacro>
      <Name>create_all_prerequisites!</Name>
      <Parameters>
        <Parameter name="connector_name">Fiservmea</Parameter>
        <Parameter name="generic_type">T</Parameter>
      </Parameters>
      <ApiDefinitions>
        <FlowDefinition>
          <Flow>Authorize</Flow>
          <RequestBody>FiservmeaAuthorizeRequest&lt;T&gt;</RequestBody>
          <ResponseBody>FiservmeaAuthorizeResponse</ResponseBody>
          <RouterData>RouterDataV2&lt;Authorize, PaymentFlowData, PaymentsAuthorizeData&lt;T&gt;, PaymentsResponseData&gt;</RouterData>
        </FlowDefinition>
      </ApiDefinitions>
      <AmountConverters>
        <Converter name="amount_converter">StringMajorUnit</Converter>
      </AmountConverters>
      <MemberFunctions>
        <Function name="build_headers">
          <Signature>pub fn build_headers&lt;F, FCD, Req, Res&gt;(&amp;self, req: &amp;RouterDataV2&lt;F, FCD, Req, Res&gt;) -&gt; CustomResult&lt;Vec&lt;(String, Maskable&lt;String&gt;)&gt;, ConnectorError&gt;</Signature>
          <Description>Build headers including Content-Type, Api-Key, Client-Request-Id, Timestamp, and Message-Signature</Description>
        </Function>
        <Function name="connector_base_url_payments">
          <Signature>pub fn connector_base_url_payments&lt;'a, F, Req, Res&gt;(&amp;self, req: &'a RouterDataV2&lt;F, PaymentFlowData, Req, Res&gt;) -&gt; &'a str</Signature>
          <Description>Get base URL for payment operations</Description>
        </Function>
      </MemberFunctions>
    </PrerequisitesMacro>

    <ImplementationMacro>
      <Name>macro_connector_implementation!</Name>
      <Parameters>
        <Parameter name="connector_default_implementations">[get_content_type, get_error_response_v2]</Parameter>
        <Parameter name="connector">Fiservmea</Parameter>
        <Parameter name="curl_request">Json(FiservmeaAuthorizeRequest)</Parameter>
        <Parameter name="curl_response">FiservmeaAuthorizeResponse</Parameter>
        <Parameter name="flow_name">Authorize</Parameter>
        <Parameter name="resource_common_data">PaymentFlowData</Parameter>
        <Parameter name="flow_request">PaymentsAuthorizeData&lt;T&gt;</Parameter>
        <Parameter name="flow_response">PaymentsResponseData</Parameter>
        <Parameter name="http_method">Post</Parameter>
        <Parameter name="generic_type">T</Parameter>
        <Parameter name="trait_bounds">[PaymentMethodDataTypes + Debug + Sync + Send + 'static + Serialize]</Parameter>
      </Parameters>
      <OtherFunctions>
        <Function name="get_headers">
          <Signature>fn get_headers(&amp;self, req: &amp;RouterDataV2&lt;Authorize, PaymentFlowData, PaymentsAuthorizeData&lt;T&gt;, PaymentsResponseData&gt;) -&gt; CustomResult&lt;Vec&lt;(String, Maskable&lt;String&gt;)&gt;, ConnectorError&gt;</Signature>
          <Implementation>self.build_headers(req)</Implementation>
        </Function>
        <Function name="get_url">
          <Signature>fn get_url(&amp;self, req: &amp;RouterDataV2&lt;Authorize, PaymentFlowData, PaymentsAuthorizeData&lt;T&gt;, PaymentsResponseData&gt;) -&gt; CustomResult&lt;String, ConnectorError&gt;</Signature>
          <Implementation>Ok(format!("{}/payments", self.connector_base_url_payments(req)))</Implementation>
        </Function>
      </OtherFunctions>
    </ImplementationMacro>
  </MacroConfiguration>

  <!-- ================================================================= -->
  <!-- DATA STRUCTURES -->
  <!-- ================================================================= -->
  <DataStructures>
    <Transformers>
      <AuthenticationType>
        <Name>FiservmeaAuthType</Name>
        <Purpose>Handle SignatureKey authentication</Purpose>
        <Fields>
          <Field name="api_key" type="Secret&lt;String&gt;" description="API Key from merchant boarding"/>
          <Field name="api_secret" type="Secret&lt;String&gt;" description="API Secret for signature generation"/>
        </Fields>
        <Methods>
          <Method name="generate_signature" signature="pub fn generate_signature(&amp;self, client_request_id: &amp;str, timestamp: i64, request_body: &amp;str) -&gt; String" description="Generate HMAC-SHA256 signature"/>
        </Methods>
        <TryFrom>
          <SourceType>&amp;ConnectorAuthType</SourceType>
          <Variant>SignatureKey { api_key, api_secret, .. }</Variant>
        </TryFrom>
      </AuthenticationType>

      <RequestStruct>
        <Name>FiservmeaAuthorizeRequest&lt;T&gt;</Name>
        <Derives>Debug, Serialize</Derives>
        <SerdeAttributes>
          <Attribute name="rename_all" value="camelCase"/>
        </SerdeAttributes>
        <Fields>
          <Field name="request_type" type="String" required="true" serializeAs="requestType" defaultValue="PaymentCardPreAuthTransaction"/>
          <Field name="transaction_amount" type="FiservmeaTransactionAmount" required="true" serializeAs="transactionAmount"/>
          <Field name="payment_method" type="FiservmeaPaymentMethod&lt;T&gt;" required="true" serializeAs="paymentMethod"/>
          <Field name="order" type="Option&lt;FiservmeaOrder&gt;" optional="true" serializeAs="order"/>
        </Fields>
      </RequestStruct>

      <NestedStructs>
        <Struct name="FiservmeaTransactionAmount">
          <Derives>Debug, Serialize</Derives>
          <SerdeAttributes>
            <Attribute name="rename_all" value="camelCase"/>
          </SerdeAttributes>
          <Fields>
            <Field name="total" type="String" required="true"/>
            <Field name="currency" type="String" required="true"/>
          </Fields>
        </Struct>

        <Struct name="FiservmeaPaymentMethod&lt;T&gt;">
          <Derives>Debug, Serialize</Derives>
          <SerdeAttributes>
            <Attribute name="rename_all" value="camelCase"/>
          </SerdeAttributes>
          <Fields>
            <Field name="payment_card" type="FiservmeaPaymentCard&lt;T&gt;" required="true"/>
          </Fields>
        </Struct>

        <Struct name="FiservmeaPaymentCard&lt;T&gt;">
          <Derives>Debug, Serialize</Derives>
          <SerdeAttributes>
            <Attribute name="rename_all" value="camelCase"/>
          </SerdeAttributes>
          <Fields>
            <Field name="number" type="RawCardNumber&lt;T&gt;" required="true"/>
            <Field name="security_code" type="Secret&lt;String&gt;" required="true"/>
            <Field name="expiry_date" type="FiservmeaExpiryDate" required="true"/>
          </Fields>
        </Struct>

        <Struct name="FiservmeaExpiryDate">
          <Derives>Debug, Serialize</Derives>
          <SerdeAttributes>
            <Attribute name="rename_all" value="camelCase"/>
          </SerdeAttributes>
          <Fields>
            <Field name="month" type="String" required="true"/>
            <Field name="year" type="String" required="true"/>
          </Fields>
        </Struct>

        <Struct name="FiservmeaOrder">
          <Derives>Debug, Serialize</Derives>
          <SerdeAttributes>
            <Attribute name="rename_all" value="camelCase"/>
          </SerdeAttributes>
          <Fields>
            <Field name="order_id" type="String" optional="true"/>
            <Field name="billing" type="Option&lt;FiservmeaBilling&gt;" optional="true"/>
          </Fields>
        </Struct>

        <Struct name="FiservmeaBilling">
          <Derives>Debug, Serialize</Derives>
          <SerdeAttributes>
            <Attribute name="rename_all" value="camelCase"/>
          </SerdeAttributes>
          <Fields>
            <Field name="name" type="Secret&lt;String&gt;" optional="true"/>
            <Field name="customer_id" type="String" optional="true"/>
          </Fields>
        </Struct>
      </NestedStructs>

      <ResponseStruct>
        <Name>FiservmeaAuthorizeResponse</Name>
        <Derives>Debug, Deserialize</Derives>
        <SerdeAttributes>
          <Attribute name="rename_all" value="camelCase"/>
        </SerdeAttributes>
        <Fields>
          <Field name="client_request_id" type="String" required="true"/>
          <Field name="api_trace_id" type="String" required="true"/>
          <Field name="ipg_transaction_id" type="String" required="true"/>
          <Field name="order_id" type="String" required="true"/>
          <Field name="transaction_type" type="String" required="true"/>
          <Field name="transaction_result" type="FiservmeaTransactionResult" required="true"/>
          <Field name="transaction_state" type="FiservmeaTransactionState" required="true"/>
          <Field name="approval_code" type="Option&lt;String&gt;" optional="true"/>
          <Field name="scheme_response_code" type="Option&lt;String&gt;" optional="true"/>
          <Field name="error_message" type="Option&lt;String&gt;" optional="true"/>
          <Field name="approved_amount" type="Option&lt;FiservmeaAmount&gt;" optional="true"/>
          <Field name="processor" type="Option&lt;FiservmeaProcessor&gt;" optional="true"/>
          <Field name="payment_method_details" type="Option&lt;FiservmeaPaymentMethodDetails&gt;" optional="true"/>
        </Fields>
      </ResponseStruct>

      <ResponseNestedStructs>
        <Struct name="FiservmeaAmount">
          <Derives>Debug, Deserialize</Derives>
          <SerdeAttributes>
            <Attribute name="rename_all" value="camelCase"/>
          </SerdeAttributes>
          <Fields>
            <Field name="total" type="f64" optional="true"/>
            <Field name="currency" type="String" optional="true"/>
          </Fields>
        </Struct>

        <Struct name="FiservmeaProcessor">
          <Derives>Debug, Deserialize</Derives>
          <SerdeAttributes>
            <Attribute name="rename_all" value="camelCase"/>
          </SerdeAttributes>
          <Fields>
            <Field name="reference_number" type="Option&lt;String&gt;" optional="true"/>
            <Field name="authorization_code" type="Option&lt;String&gt;" optional="true"/>
            <Field name="response_code" type="Option&lt;String&gt;" optional="true"/>
            <Field name="response_message" type="Option&lt;String&gt;" optional="true"/>
            <Field name="security_code_response" type="Option&lt;FiservmeaSecurityCodeResponse&gt;" optional="true"/>
          </Fields>
        </Struct>

        <Struct name="FiservmeaPaymentMethodDetails">
          <Derives>Debug, Deserialize</Derives>
          <SerdeAttributes>
            <Attribute name="rename_all" value="camelCase"/>
          </SerdeAttributes>
          <Fields>
            <Field name="payment_method_type" type="Option&lt;String&gt;" optional="true"/>
            <Field name="payment_method_brand" type="Option&lt;String&gt;" optional="true"/>
          </Fields>
        </Struct>
      </ResponseNestedStructs>

      <StatusEnums>
        <Enum name="FiservmeaTransactionResult">
          <Derives>Debug, Deserialize, Clone, PartialEq</Derives>
          <SerdeAttributes>
            <Attribute name="rename_all" value="SCREAMING_SNAKE_CASE"/>
          </SerdeAttributes>
          <Variants>
            <Variant name="Approved"/>
            <Variant name="Declined"/>
            <Variant name="Failed"/>
            <Variant name="Waiting"/>
            <Variant name="Partial"/>
            <Variant name="Fraud"/>
          </Variants>
        </Enum>

        <Enum name="FiservmeaTransactionState">
          <Derives>Debug, Deserialize, Clone, PartialEq</Derives>
          <SerdeAttributes>
            <Attribute name="rename_all" value="SCREAMING_SNAKE_CASE"/>
          </SerdeAttributes>
          <Variants>
            <Variant name="Authorized"/>
            <Variant name="Captured"/>
            <Variant name="Declined"/>
            <Variant name="Checked"/>
            <Variant name="CompletedGet"/>
            <Variant name="Initialized"/>
            <Variant name="Pending"/>
            <Variant name="Ready"/>
            <Variant name="Template"/>
            <Variant name="Settled"/>
            <Variant name="Voided"/>
            <Variant name="Waiting"/>
          </Variants>
        </Enum>

        <Enum name="FiservmeaSecurityCodeResponse">
          <Derives>Debug, Deserialize, Clone, PartialEq</Derives>
          <SerdeAttributes>
            <Attribute name="rename_all" value="SCREAMING_SNAKE_CASE"/>
          </SerdeAttributes>
          <Variants>
            <Variant name="Matched"/>
            <Variant name="NotMatched"/>
            <Variant name="NotProcessed"/>
            <Variant name="NotPresent"/>
            <Variant name="NotCertified"/>
            <Variant name="NotChecked"/>
          </Variants>
        </Enum>
      </StatusEnums>

      <ErrorResponseStruct>
        <Name>FiservmeaErrorResponse</Name>
        <Derives>Debug, Deserialize</Derives>
        <SerdeAttributes>
          <Attribute name="rename_all" value="camelCase"/>
        </SerdeAttributes>
        <Fields>
          <Field name="client_request_id" type="String" optional="true"/>
          <Field name="api_trace_id" type="String" optional="true"/>
          <Field name="response_type" type="String" optional="true"/>
          <Field name="error" type="Option&lt;FiservmeaErrorDetail&gt;" optional="true"/>
        </Fields>
        <DefaultImplementation>
          <Field name="client_request_id" defaultValue="String::new()"/>
          <Field name="api_trace_id" defaultValue="String::new()"/>
          <Field name="response_type" defaultValue="String::new()"/>
          <Field name="error" defaultValue="None"/>
        </DefaultImplementation>
      </ErrorResponseStruct>

      <ErrorDetailStruct>
        <Name>FiservmeaErrorDetail</Name>
        <Derives>Debug, Deserialize</Derives>
        <SerdeAttributes>
          <Attribute name="rename_all" value="camelCase"/>
        </SerdeAttributes>
        <Fields>
          <Field name="code" type="String" optional="true"/>
          <Field name="message" type="String" optional="true"/>
          <Field name="details" type="Option&lt;Vec&lt;FiservmeaErrorField&gt;&gt;" optional="true"/>
          <Field name="decline_reason_code" type="Option&lt;String&gt;" optional="true"/>
        </Fields>
      </ErrorDetailStruct>

      <ErrorFieldStruct>
        <Name>FiservmeaErrorField</Name>
        <Derives>Debug, Deserialize</Derives>
        <SerdeAttributes>
          <Attribute name="rename_all" value="camelCase"/>
        </SerdeAttributes>
        <Fields>
          <Field name="field" type="String" optional="true"/>
          <Field name="message" type="String" optional="true"/>
        </Fields>
      </ErrorFieldStruct>
    </Transformers>
  </DataStructures>

  <!-- ================================================================= -->
  <!-- TRANSFORMATION LOGIC -->
  <!-- ================================================================= -->
  <TransformationLogic>
    <RequestTransformation>
      <Source>FiservmeaRouterData&lt;RouterDataV2&lt;Authorize, PaymentFlowData, PaymentsAuthorizeData&lt;T&gt;, PaymentsResponseData&gt;, T&gt;</Source>
      <Target>FiservmeaAuthorizeRequest&lt;T&gt;</Target>
      <Steps>
        <Step>
          <Description>Extract amount and convert to StringMajorUnit</Description>
          <Logic>Use amount_converter from macro to convert minor_amount to major unit string</Logic>
        </Step>
        <Step>
          <Description>Extract currency</Description>
          <Logic>Get currency from router_data.request.currency</Logic>
        </Step>
        <Step>
          <Description>Extract payment method data</Description>
          <Logic>Match PaymentMethodData::Card and transform to FiservmeaPaymentCard</Logic>
        </Step>
        <Step>
          <Description>Build order object if available</Description>
          <Logic>Extract connector_request_reference_id and customer_name if present</Logic>
        </Step>
        <Step>
          <Description>Construct request with fixed requestType</Description>
          <Logic>Set requestType to "PaymentCardPreAuthTransaction"</Logic>
        </Step>
      </Steps>
      <ErrorHandling>
        <Error type="UnsupportedPaymentMethod">
          <Condition>PaymentMethodData is not Card</Condition>
          <Return>ConnectorError::NotImplemented("Only card payments are supported for FiservMEA")</Return>
        </Error>
      </ErrorHandling>
    </RequestTransformation>

    <ResponseTransformation>
      <Source>ResponseRouterData&lt;FiservmeaAuthorizeResponse, RouterDataV2&lt;Authorize, PaymentFlowData, PaymentsAuthorizeData&lt;T&gt;, PaymentsResponseData&gt;&gt;</Source>
      <Target>RouterDataV2&lt;Authorize, PaymentFlowData, PaymentsAuthorizeData&lt;T&gt;, PaymentsResponseData&gt;</Target>
      <Steps>
        <Step>
          <Description>Map connector status to attempt status</Description>
          <Logic>Call map_fiservmea_status_to_attempt_status with transaction_result and transaction_state</Logic>
        </Step>
        <Step>
          <Description>Extract connector transaction ID</Description>
          <Logic>Use ipgTransactionId as connector_transaction_id</Logic>
        </Step>
        <Step>
          <Description>Build PaymentsResponseData</Description>
          <Logic>Create TransactionResponse with resource_id, redirection_data (None), etc.</Logic>
        </Step>
        <Step>
          <Description>Update resource_common_data status</Description>
          <Logic>Set status based on mapped attempt_status</Logic>
        </Step>
      </Steps>
      <ErrorHandling>
        <Error type="ErrorResponse">
          <Condition>errorMessage is present or transaction_result indicates failure</Condition>
          <Logic>Return ErrorResponse with appropriate error details</Logic>
        </Error>
      </ErrorHandling>
    </ResponseTransformation>

    <StatusMappingFunction>
      <Name>map_fiservmea_status_to_attempt_status</Name>
      <Input>
        <Parameter name="transaction_result" type="&amp;FiservmeaTransactionResult"/>
        <Parameter name="transaction_state" type="&amp;FiservmeaTransactionState"/>
      </Input>
      <Output>common_enums::AttemptStatus</Output>
      <MappingRules>
        <Rule>
          <Condition>transaction_result == Approved AND transaction_state == Authorized</Condition>
          <Result>AttemptStatus::Authorized</Result>
        </Rule>
        <Rule>
          <Condition>transaction_result == Declined OR transaction_result == Failed OR transaction_result == Fraud</Condition>
          <Result>AttemptStatus::Failure</Result>
        </Rule>
        <Rule>
          <Condition>transaction_result == Waiting OR transaction_result == Partial</Condition>
          <Result>AttemptStatus::Pending</Result>
        </Rule>
        <Rule>
          <Condition>transaction_state == Declined</Condition>
          <Result>AttemptStatus::Failure</Result>
        </Rule>
        <Rule>
          <Condition>transaction_state == Pending OR transaction_state == Waiting</Condition>
          <Result>AttemptStatus::Pending</Result>
        </Rule>
        <Rule>
          <Condition>Default fallback</Condition>
          <Result>AttemptStatus::Failure</Result>
        </Rule>
      </MappingRules>
    </StatusMappingFunction>
  </TransformationLogic>

  <!-- ================================================================= -->
  <!-- AUTHENTICATION IMPLEMENTATION -->
  <!-- ================================================================= -->
  <AuthenticationImplementation>
    <Type>SignatureKey</Type>
    <Headers>
      <Header name="Content-Type" value="application/json"/>
      <Header name="Api-Key" source="auth.api_key"/>
      <Header name="Client-Request-Id" source="generate_uuid()"/>
      <Header name="Timestamp" source="current_epoch_millis()"/>
      <Header name="Message-Signature" source="auth.generate_signature(client_request_id, timestamp, request_body)"/>
    </Headers>

    <SignatureGeneration>
      <FunctionName>generate_signature</FunctionName>
      <Parameters>
        <Parameter name="&amp;self"/>
        <Parameter name="client_request_id" type="&amp;str"/>
        <Parameter name="timestamp" type="i64"/>
        <Parameter name="request_body" type="&amp;str"/>
      </Parameters>
      <ReturnType>String</ReturnType>
      <Algorithm>HMAC-SHA256</Algorithm>
      <Steps>
        <Step>Concatenate: api_key + client_request_id + timestamp + request_body</Step>
        <Step>Generate HMAC-SHA256 using api_secret as key</Step>
        <Step>Encode result in Base64</Step>
        <Step>Return Base64 string</Step>
      </Steps>
      <Dependencies>
        <Dependency>hmac crate</Dependency>
        <Dependency>sha2 crate</Dependency>
        <Dependency>base64 crate</Dependency>
      </Dependencies>
    </SignatureGeneration>

    <UuidGeneration>
      <Method>Use uuid::Uuid::new_v4().to_string()</Method>
      <Purpose>Generate unique Client-Request-Id for each request</Purpose>
    </UuidGeneration>

    <TimestampGeneration>
      <Method>Use std::time::SystemTime::now().duration_since(UNIX_EPOCH).unwrap().as_millis() as i64</Method>
      <Purpose>Generate current epoch timestamp in milliseconds</Purpose>
    </TimestampGeneration>
  </AuthenticationImplementation>

  <!-- ================================================================= -->
  <!-- CONNECTOR COMMON IMPLEMENTATION -->
  <!-- ================================================================= -->
  <ConnectorCommonImplementation>
    <Trait>ConnectorCommon</Trait>
    <GenericBounds>T: PaymentMethodDataTypes + Debug + Sync + Send + 'static + Serialize</GenericBounds>

    <Methods>
      <Method name="id">
        <Signature>fn id(&amp;self) -&gt; &amp;'static str</Signature>
        <Implementation>"fiservemea"</Implementation>
      </Method>

      <Method name="get_currency_unit">
        <Signature>fn get_currency_unit(&amp;self) -&gt; common_enums::CurrencyUnit</Signature>
        <Implementation>common_enums::CurrencyUnit::Base</Implementation>
        <Reason>FiservMEA uses major unit amounts (e.g., "100.00")</Reason>
      </Method>

      <Method name="base_url">
        <Signature>fn base_url&lt;'a&gt;(&amp;self, connectors: &'a Connectors) -&gt; &'a str</Signature>
        <Implementation>connectors.fiservemea.base_url.as_ref()</Implementation>
      </Method>

      <Method name="get_auth_header">
        <Signature>fn get_auth_header(&amp;self, auth_type: &amp;ConnectorAuthType) -&gt; CustomResult&lt;Vec&lt;(String, Maskable&lt;String&gt;)&gt;, ConnectorError&gt;</Signature>
        <Implementation>
          <Step>Convert ConnectorAuthType to FiservmeaAuthType using TryFrom</Step>
          <Step>Return error if conversion fails</Step>
          <Step>Note: Actual headers are built in build_headers with signature</Step>
        </Implementation>
      </Method>

      <Method name="build_error_response">
        <Signature>fn build_error_response(&amp;self, res: Response, event_builder: Option&lt;&amp;mut Event&gt;) -&gt; CustomResult&lt;ErrorResponse, ConnectorError&gt;</Signature>
        <Implementation>
          <Step>Parse response as FiservmeaErrorResponse</Step>
          <Step>Set error response body in event_builder if present</Step>
          <Step>Extract error code, message, and details</Step>
          <Step>Map responseType to attempt_status if applicable</Step>
          <Step>Return ErrorResponse with all relevant fields</Step>
        </Implementation>
      </Method>
    </Methods>
  </ConnectorCommonImplementation>

  <!-- ================================================================= -->
  <!-- VALIDATION RULES -->
  <!-- ================================================================= -->
  <ValidationRules>
    <Scope>Implementation</Scope>
    <Rules>
      <Rule id="VR001" severity="CRITICAL">
        <Description>ONLY Authorize flow must be implemented</Description>
        <Check>No other flows (Capture, Refund, Void, PSync, etc.) in implementation</Check>
      </Rule>
      <Rule id="VR002" severity="CRITICAL">
        <Description>MUST use macro-based approach</Description>
        <Check>create_all_prerequisites! macro is used</Check>
        <Check>macro_connector_implementation! macro is used</Check>
        <Check>NO manual ConnectorIntegrationV2 trait implementation</Check>
      </Rule>
      <Rule id="VR003" severity="CRITICAL">
        <Description>ONLY modify specified files</Description>
        <Check>fiservemea.rs is modified</Check>
        <Check>fiservemea/transformers.rs is modified</Check>
        <Check>NO other files are modified</Check>
      </Rule>
      <Rule id="VR004" severity="CRITICAL">
        <Description>Status must be derived from connector response</Description>
        <Check>NO hardcoded status values</Check>
        <Check>Status mapping function exists</Check>
        <Check>Status is mapped from transaction_result and transaction_state</Check>
      </Rule>
      <Rule id="VR005" severity="HIGH">
        <Description>Request/Response types must match between macros</Description>
        <Check>create_all_prerequisites! request_body matches macro_connector_implementation! curl_request</Check>
        <Check>create_all_prerequisites! response_body matches macro_connector_implementation! curl_response</Check>
      </Rule>
      <Rule id="VR006" severity="HIGH">
        <Description>Flow name must match exactly</Description>
        <Check>Flow name in create_all_prerequisites! matches macro_connector_implementation!</Check>
      </Rule>
      <Rule id="VR007" severity="HIGH">
        <Description>Correct resource_common_data type</Description>
        <Check>PaymentFlowData is used for Authorize flow</Check>
      </Rule>
      <Rule id="VR008" severity="HIGH">
        <Description>Generic type T must be used for Authorize</Description>
        <Check>PaymentsAuthorizeData&lt;T&gt; is used</Check>
        <Check>FiservmeaAuthorizeRequest&lt;T&gt; is used</Check>
      </Rule>
      <Rule id="VR009" severity="MEDIUM">
        <Description>Remove unused optional fields</Description>
        <Check>NO fields that are always None</Check>
        <Check>NO placeholder fields</Check>
      </Rule>
      <Rule id="VR010" severity="MEDIUM">
        <Description>Proper error handling</Description>
        <Check>Specific error messages for unsupported payment methods</Check>
        <Check>Error response parsing handles all cases</Check>
      </Rule>
      <Rule id="VR011" severity="MEDIUM">
        <Description>Serde configuration</Description>
        <Check>snake_case for Rust fields</Check>
        <Check>camelCase for JSON via rename_all attribute</Check>
      </Rule>
      <Rule id="VR012" severity="LOW">
        <Description>Code quality</Description>
        <Check>cargo build succeeds</Check>
        <Check>cargo clippy passes</Check>
        <Check>NO TODO comments</Check>
        <Check>NO FIXME comments</Check>
      </Rule>
    </Rules>
  </ValidationRules>

  <!-- ================================================================= -->
  <!-- TESTING REQUIREMENTS -->
  <!-- ================================================================= -->
  <TestingRequirements>
    <UnitTests>
      <Test name="test_authorize_request_transformation">
        <Description>Test request transformation from RouterDataV2 to FiservmeaAuthorizeRequest</Description>
        <Assertions>
          <Assertion>Amount is correctly converted to StringMajorUnit</Assertion>
          <Assertion>Currency is preserved</Assertion>
          <Assertion>Payment method is correctly transformed</Assertion>
          <Assertion>requestType is set to "PaymentCardPreAuthTransaction"</Assertion>
        </Assertions>
      </Test>
      <Test name="test_authorize_response_transformation_success">
        <Description>Test successful response transformation</Description>
        <Assertions>
          <Assertion>Status is mapped to Authorized for APPROVED/AUTHORIZED</Assertion>
          <Assertion>Connector transaction ID is extracted</Assertion>
          <Assertion>PaymentsResponseData is correctly constructed</Assertion>
        </Assertions>
      </Test>
      <Test name="test_authorize_response_transformation_declined">
        <Description>Test declined response transformation</Description>
        <Assertions>
          <Assertion>Status is mapped to Failure for DECLINED</Assertion>
          <Assertion>Error details are captured</Assertion>
        </Assertions>
      </Test>
      <Test name="test_status_mapping">
        <Description>Test status mapping function</Description>
        <Assertions>
          <Assertion>All transaction_result values are mapped</Assertion>
          <Assertion>All transaction_state values are handled</Assertion>
          <Assertion>Edge cases are covered</Assertion>
        </Assertions>
      </Test>
      <Test name="test_authentication_signature_generation">
        <Description>Test HMAC-SHA256 signature generation</Description>
        <Assertions>
          <Assertion>Signature is correctly generated</Assertion>
          <Assertion>Signature is Base64 encoded</Assertion>
          <Assertion>Same inputs produce same signature</Assertion>
        </Assertions>
      </Test>
      <Test name="test_unsupported_payment_method">
        <Description>Test error handling for non-card payment methods</Description>
        <Assertions>
          <Assertion>Appropriate error is returned</Assertion>
          <Assertion>Error message is descriptive</Assertion>
        </Assertions>
      </Test>
    </UnitTests>

    <IntegrationTests>
      <Test name="test_authorize_flow_complete">
        <Description>Test complete authorize flow with mocked connector</Description>
        <Steps>
          <Step>Create test RouterDataV2 with card payment</Step>
          <Step>Call authorize flow</Step>
          <Step>Verify request headers are correct</Step>
          <Step>Verify request body is correct</Step>
          <Step>Verify URL is correct</Step>
          <Step>Verify response is parsed correctly</Step>
        </Steps>
      </Test>
    </IntegrationTests>
  </TestingRequirements>

  <!-- ================================================================= -->
  <!-- IMPLEMENTATION TASKS -->
  <!-- ================================================================= -->
  <ImplementationTasks>
    <Phase number="1" name="File Setup">
      <Tasks>
        <Task id="T001" priority="HIGH">
          <Description>Create fiservemea directory if not exists</Description>
          <File>backend/connector-integration/src/connectors/fiservemea/</File>
        </Task>
        <Task id="T002" priority="HIGH">
          <Description>Create fiservemea.rs file with basic structure</Description>
          <File>backend/connector-integration/src/connectors/fiservemea.rs</File>
        </Task>
        <Task id="T003" priority="HIGH">
          <Description>Create transformers.rs file</Description>
          <File>backend/connector-integration/src/connectors/fiservemea/transformers.rs</File>
        </Task>
      </Tasks>
    </Phase>

    <Phase number="2" name="Transformers Implementation">
      <Tasks>
        <Task id="T004" priority="HIGH">
          <Description>Define FiservmeaAuthType struct</Description>
          <File>transformers.rs</File>
        </Task>
        <Task id="T005" priority="HIGH">
          <Description>Implement TryFrom for FiservmeaAuthType</Description>
          <File>transformers.rs</File>
        </Task>
        <Task id="T006" priority="HIGH">
          <Description>Implement generate_signature method</Description>
          <File>transformers.rs</File>
        </Task>
        <Task id="T007" priority="HIGH">
          <Description>Define FiservmeaAuthorizeRequest struct and nested structs</Description>
          <File>transformers.rs</File>
        </Task>
        <Task id="T008" priority="HIGH">
          <Description>Define FiservmeaAuthorizeResponse struct and nested structs</Description>
          <File>transformers.rs</File>
        </Task>
        <Task id="T009" priority="HIGH">
          <Description>Define status enums (FiservmeaTransactionResult, FiservmeaTransactionState)</Description>
          <File>transformers.rs</File>
        </Task>
        <Task id="T010" priority="HIGH">
          <Description>Define FiservmeaErrorResponse struct</Description>
          <File>transformers.rs</File>
        </Task>
        <Task id="T011" priority="HIGH">
          <Description>Implement TryFrom for request transformation</Description>
          <File>transformers.rs</File>
        </Task>
        <Task id="T012" priority="HIGH">
          <Description>Implement TryFrom for response transformation</Description>
          <File>transformers.rs</File>
        </Task>
        <Task id="T013" priority="HIGH">
          <Description>Implement map_fiservmea_status_to_attempt_status function</Description>
          <File>transformers.rs</File>
        </Task>
      </Tasks>
    </Phase>

    <Phase number="3" name="Main Connector Implementation">
      <Tasks>
        <Task id="T014" priority="HIGH">
          <Description>Add imports and module declaration</Description>
          <File>fiservemea.rs</File>
        </Task>
        <Task id="T015" priority="HIGH">
          <Description>Define headers module</Description>
          <File>fiservemea.rs</File>
        </Task>
        <Task id="T016" priority="HIGH">
          <Description>Implement trait markers (PaymentAuthorizeV2, etc.)</Description>
          <File>fiservemea.rs</File>
        </Task>
        <Task id="T017" priority="HIGH">
          <Description>Add create_all_prerequisites! macro with Authorize flow</Description>
          <File>fiservemea.rs</File>
        </Task>
        <Task id="T018" priority="HIGH">
          <Description>Implement build_headers member function</Description>
          <File>fiservemea.rs</File>
        </Task>
        <Task id="T019" priority="HIGH">
          <Description>Implement connector_base_url_payments member function</Description>
          <File>fiservemea.rs</File>
        </Task>
        <Task id="T020" priority="HIGH">
          <Description>Add macro_connector_implementation! for Authorize flow</Description>
          <File>fiservemea.rs</File>
        </Task>
        <Task id="T021" priority="HIGH">
          <Description>Implement ConnectorCommon trait</Description>
          <File>fiservemea.rs</File>
        </Task>
      </Tasks>
    </Phase>

    <Phase number="4" name="Validation and Testing">
      <Tasks>
        <Task id="T022" priority="HIGH">
          <Description>Run cargo build and fix compilation errors</Description>
        </Task>
        <Task id="T023" priority="HIGH">
          <Description>Run cargo clippy and fix warnings</Description>
        </Task>
        <Task id="T024" priority="MEDIUM">
          <Description>Write unit tests for transformers</Description>
        </Task>
        <Task id="T025" priority="MEDIUM">
          <Description>Write integration tests for authorize flow</Description>
        </Task>
        <Task id="T026" priority="MEDIUM">
          <Description>Run cargo test and ensure all tests pass</Description>
        </Task>
      </Tasks>
    </Phase>

    <Phase number="5" name="Final Steps">
      <Tasks>
        <Task id="T027" priority="HIGH">
          <Description>Mark generated-requirement-analysis.xml as resolved</Description>
          <Command>mv generated-requirement-analysis.xml generated-requirement-analysis.xml.resolved</Command>
        </Task>
      </Tasks>
    </Phase>
  </ImplementationTasks>

  <!-- ================================================================= -->
  <!-- DEPENDENCIES -->
  <!-- ================================================================= -->
  <Dependencies>
    <ExternalCrates>
      <Crate name="hmac" version="*" reason="HMAC signature generation"/>
      <Crate name="sha2" version="*" reason="SHA-256 hashing"/>
      <Crate name="base64" version="*" reason="Base64 encoding for signature"/>
      <Crate name="uuid" version="*" reason="UUID generation for Client-Request-Id"/>
    </ExternalCrates>
    <InternalModules>
      <Module path="common_utils" usage="errors, types, ext_traits"/>
      <Module path="domain_types" usage="connector_flow, connector_types, errors, payment_method_data, router_data, router_data_v2"/>
      <Module path="common_enums" usage="AttemptStatus, CurrencyUnit"/>
      <Module path="hyperswitch_masking" usage="Maskable, Secret"/>
      <Module path="interfaces" usage="ConnectorCommon, ConnectorIntegrationV2"/>
      <Module path="serde" usage="Serialize, Deserialize"/>
      <Module path="error_stack" usage="ResultExt, report"/>
    </InternalModules>
  </Dependencies>

  <!-- ================================================================= -->
  <!-- ACCEPTANCE CRITERIA -->
  <!-- ================================================================= -->
  <AcceptanceCriteria>
    <Criteria id="AC001" priority="CRITICAL">
      <Description>Only Authorize flow is implemented</Description>
      <Verification>Code review confirms no other flows are present</Verification>
    </Criteria>
    <Criteria id="AC002" priority="CRITICAL">
      <Description>Macro-based approach is used exclusively</Description>
      <Verification>create_all_prerequisites! and macro_connector_implementation! macros are present</Verification>
      <Verification>No manual ConnectorIntegrationV2 implementation exists</Verification>
    </Criteria>
    <Criteria id="AC003" priority="CRITICAL">
      <Description>Only fiservemea.rs and fiservemea/transformers.rs are modified</Description>
      <Verification>Git diff shows only these two files changed</Verification>
    </Criteria>
    <Criteria id="AC004" priority="CRITICAL">
      <Description>Project compiles without errors</Description>
      <Verification>cargo build succeeds</Verification>
    </Criteria>
    <Criteria id="AC005" priority="CRITICAL">
      <Description>No clippy warnings</Description>
      <Verification>cargo clippy passes with no warnings</Verification>
    </Criteria>
    <Criteria id="AC006" priority="HIGH">
      <Description>Status is derived from connector response</Description>
      <Verification>Status mapping function exists and is used</Verification>
      <Verification>No hardcoded status values in response transformation</Verification>
    </Criteria>
    <Criteria id="AC007" priority="HIGH">
      <Description>Authentication is correctly implemented</Description>
      <Verification>Signature generation follows spec</Verification>
      <Verification>All required headers are present</Verification>
    </Criteria>
    <Criteria id="AC008" priority="HIGH">
      <Description>Request/Response structures match API specification</Description>
      <Verification>All required fields are present</Verification>
      <Verification>No unnecessary optional fields</Verification>
    </Criteria>
    <Criteria id="AC009" priority="MEDIUM">
      <Description>Unit tests cover main functionality</Description>
      <Verification>Tests for request transformation exist</Verification>
      <Verification>Tests for response transformation exist</Verification>
      <Verification>Tests for status mapping exist</Verification>
    </Criteria>
    <Criteria id="AC010" priority="MEDIUM">
      <Description>No TODO or FIXME comments</Description>
      <Verification>Code search finds no TODO/FIXME markers</Verification>
    </Criteria>
    <Criteria id="AC011" priority="MEDIUM">
      <Description>Production-ready code quality</Description>
      <Verification>Code follows project conventions</Verification>
      <Verification>Proper error handling throughout</Verification>
    </Criteria>
    <Criteria id="AC012" priority="LOW">
      <Description>Documentation is adequate</Description>
      <Verification>Complex logic has comments</Verification>
      <Verification>Public functions have doc comments</Verification>
    </Criteria>
  </AcceptanceCriteria>

  <!-- ================================================================= -->
  <!-- RISK ASSESSMENT -->
  <!-- ================================================================= -->
  <RiskAssessment>
    <Risk id="R001" level="MEDIUM">
      <Description>Signature generation complexity</Description>
      <Mitigation>Follow spec exactly, test with known vectors</Mitigation>
      <Impact>Incorrect signatures will cause authentication failures</Impact>
    </Risk>
    <Risk id="R002" level="LOW">
      <Description>Status mapping edge cases</Description>
      <Mitigation>Comprehensive status mapping with fallback</Mitigation>
      <Impact>Incorrect status could affect payment processing</Impact>
    </Risk>
    <Risk id="R003" level="LOW">
      <Description>Amount conversion precision</Description>
      <Mitigation>Use StringMajorUnit as specified in API</Mitigation>
      <Impact>Incorrect amounts would cause transaction failures</Impact>
    </Risk>
    <Risk id="R004" level="LOW">
      <Description>UUID collision</Description>
      <Mitigation>Use v4 UUIDs with sufficient entropy</Mitigation>
      <Impact>Low probability, could affect idempotency</Impact>
    </Risk>
  </RiskAssessment>

  <!-- ================================================================= -->
  <!-- NOTES AND ASSUMPTIONS -->
  <!-- ================================================================= -->
  <NotesAndAssumptions>
    <Note>
      <Category>Authentication</Category>
      <Content>The Message-Signature header requires the request body to be serialized before signature calculation. This means the signature must be generated after the request body is created.</Content>
    </Note>
    <Note>
      <Category>Timestamp</Category>
      <Content>Timestamp must be within 5 minutes of server time. Ensure system clock is synchronized.</Content>
    </Note>
    <Note>
      <Category>RequestType</Category>
      <Content>For Authorize flow, we use "PaymentCardPreAuthTransaction" which creates a pre-authorization that can be completed later via PostAuthTransaction (not in scope).</Content>
    </Note>
    <Note>
      <Category>Amount Format</Category>
      <Content>FiservMEA expects amounts as strings with decimal places (e.g., "100.00"). We use StringMajorUnit converter.</Content>
    </Note>
    <Note>
      <Category>Card Data</Category>
      <Content>Only card payments are supported in this implementation. Other payment methods (Wallet, APM, etc.) are not implemented.</Content>
    </Note>
    <Assumption>
      <Category>Connector Registration</Category>
      <Content>The FiservMEA connector is already registered in the connector enum and configuration files. This implementation only adds the Authorize flow.</Content>
    </Assumption>
    <Assumption>
      <Category>Base URL</Category>
      <Content>The base URL is configured in the Connectors struct and accessible via req.resource_common_data.connectors.fiservemea.base_url</Content>
    </Assumption>
  </NotesAndAssumptions>

  <!-- ================================================================= -->
  <!-- SIGN-OFF -->
  <!-- ================================================================= -->
  <SignOff>
    <GeneratedBy>Open-Thinking Model</GeneratedBy>
    <GeneratedAt>2026-02-12</GeneratedAt>
    <Status>Ready for Implementation</Status>
    <NextSteps>
      <Step>Review this requirement analysis</Step>
      <Step>Begin implementation following the task list</Step>
      <Step>Validate against acceptance criteria</Step>
      <Step>Mark analysis as resolved upon completion</Step>
    </NextSteps>
  </SignOff>
</RequirementAnalysis>