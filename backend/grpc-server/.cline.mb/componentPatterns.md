# Component Patterns: gRPC Server

## 1. Component-Specific Design Patterns

*   **Service Layer Pattern:** The gRPC service implementations in `src/server/` (e.g., `payments.rs`, `health_check.rs`) act as a service layer. They handle API contract adherence, request validation, and orchestration of calls to business logic (in `domain_types`) and data access/connector layers (`connector-integration`).
*   **Dependency Injection (via AppState):** The `src/app.rs` likely defines an `AppState` struct that holds shared resources (like configurations, potentially clients for other services, or thread pools). This `AppState` is typically cloned and passed to each gRPC service handler, providing access to necessary dependencies. This is a common pattern in Rust web/gRPC frameworks like Actix, Axum, and Tonic.
*   **Request/Response Model:** Follows the standard gRPC request/response pattern defined by the `.proto` files. Transformations between gRPC types (generated by `tonic-build`) and internal domain types (`domain_types`) are crucial.
*   **Error Handling Centralization:** `src/error.rs` likely defines custom error types for the gRPC server and provides conversions from errors originating in other components (`domain_types`, `connector-integration`) into gRPC status codes (e.g., `tonic::Status`). This ensures consistent error reporting to clients.
*   **Builder Pattern (for Server Setup):** The `main.rs` or `server.rs` might use a builder pattern (provided by `tonic::transport::Server`) to configure and launch the gRPC server (e.g., setting TLS, adding services, defining interceptors).

## 2. Internal Architecture

```mermaid
graph TD
    ClientApp[Client Applications / SDKs] -->|gRPC Request| TonicServer[Tonic gRPC Server Core]
    
    TonicServer -->|Request| PaymentsServiceImpl[Payments Service Impl (payments.rs)]
    TonicServer -->|Request| HealthCheckServiceImpl[HealthCheck Service Impl (health_check.rs)]
    TonicServer -->|Request| OtherServicesImpl[...]

    subgraph PaymentsServiceImpl
        direction LR
        PS_Validate[Validate Request] --> PS_MapToDomain[Map to DomainType]
        PS_MapToDomain --> PS_CallDomainLogic[Call Domain Logic (domain_types)]
        PS_CallDomainLogic --> PS_CallConnector[Call Connector Integration (connector-integration)]
        PS_CallConnector --> PS_MapToProto[Map Response to Proto]
        PS_MapToProto --> PS_Respond[Send gRPC Response]
    end

    PaymentsServiceImpl --> AppState[AppState (app.rs)]
    HealthCheckServiceImpl --> AppState

    AppState --> Configs[Configurations (configs.rs)]
    AppState --> Logger[Logger (logger/)]
    AppState --> Metrics[Metrics (metrics.rs)]
    
    PaymentsServiceImpl -->|gRPC Response| TonicServer
    HealthCheckServiceImpl -->|gRPC Response| TonicServer
    OtherServicesImpl -->|gRPC Response| TonicServer

    TonicServer -->|gRPC Response| ClientApp

    style ClientApp fill:#f9f,stroke:#333,stroke-width:2px
    style TonicServer fill:#ccf,stroke:#333,stroke-width:2px
    style PaymentsServiceImpl fill:#cfc,stroke:#333,stroke-width:2px
    style HealthCheckServiceImpl fill:#cfc,stroke:#333,stroke-width:2px
    style OtherServicesImpl fill:#cfc,stroke:#333,stroke-width:2px
    style AppState fill:#ffc,stroke:#333,stroke-width:2px
```

*   **`main.rs`:** Entry point. Initializes logging, configuration, `AppState`, and starts the gRPC server.
*   **`app.rs`:** Defines `AppState` which holds shared state and resources. This state is typically wrapped in an `Arc` to be shared across threads/tasks.
*   **`server.rs`:** Contains the core logic for setting up and running the Tonic gRPC server, including adding services.
*   **`src/server/` (e.g., `payments.rs`, `health_check.rs`):** Modules implementing the actual gRPC service traits generated from `.proto` files. Each method here will handle a specific RPC.
*   **`configs.rs`:** Handles loading and providing access to application configuration (from `config/development.toml`).
*   **`logger/`:** Custom logging setup, potentially using `tracing` or `log` crates with custom formatters.
*   **`metrics.rs`:** Logic for collecting and exposing application metrics (e.g., Prometheus).
*   **`error.rs`:** Defines error types and conversions for consistent gRPC error responses.
*   **`utils.rs`:** Common utility functions specific to the gRPC server.

## 3. Key Algorithms and Approaches

*   **Asynchronous Processing:** All gRPC service handlers are `async` functions, leveraging Rust's `async/await` and the `tokio` runtime (which `tonic` is built upon).
*   **Data Validation:** Incoming requests should be validated for correctness and completeness before further processing. This might involve custom validation logic or libraries.
*   **Type Mapping:** Conversion between gRPC generated types and internal `domain_types` is a common operation. `From`/`Into` traits are often used for this.
*   **Graceful Shutdown:** The server should handle termination signals (SIGINT, SIGTERM) to shut down gracefully, allowing in-flight requests to complete.

## 4. Data Flows Within the Component

1.  **gRPC Request Ingestion:** `tonic::transport::Server` receives raw requests.
2.  **Service Dispatch:** Tonic routes the request to the appropriate service implementation (e.g., `PaymentsServiceImpl`).
3.  **Handler Execution:** The specific RPC handler function is called.
    *   It receives the gRPC request message and access to `AppState`.
    *   Validates the request.
    *   Maps gRPC request types to internal domain types.
    *   Calls business logic in `domain_types` or `connector-integration`.
    *   Receives results (or errors) from downstream components.
    *   Maps domain response types (or errors) back to gRPC response types (or `tonic::Status`).
4.  **gRPC Response Emission:** Tonic sends the gRPC response (or error status) back to the client.

## 5. State Management Strategies

*   **`AppState`:** The primary mechanism for managing shared, read-only (or `Arc<Mutex<T>>` for mutable) state across request handlers. This includes configuration, potentially database connection pools, clients for other services, etc.
*   **Request-Local State:** Handled within individual RPC handler functions. The server itself aims to be stateless beyond the shared `AppState`.

*(This is an initial draft. Specific libraries like `tonic`, `tokio`, `tracing` are assumed based on common Rust gRPC practices and will be confirmed by code/`Cargo.toml` review.)*
