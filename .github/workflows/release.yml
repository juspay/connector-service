name: Release

on:
  push:
    branches:
      - ffi-implementation
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to release from'
        required: true
        default: 'main'
        type: string
      dry_run:
        description: 'Dry run (do not create release)'
        required: false
        default: true
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Workflow-level permissions
permissions:
  contents: write      # Required for creating releases and pushing tags
  actions: read        # Required for downloading artifacts
  pull-requests: read  # Required for reading PR information

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 1
  CARGO_NET_RETRY: 10
  RUSTFLAGS: "-C codegen-units=16"

jobs:
  # Job 1: Generate version and changelog
  version-and-changelog:
    name: Generate Version and Changelog
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.version.outputs.new_version }}
      changelog: ${{ steps.changelog.outputs.content }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.event.inputs.branch }}

      - name: Install git-cliff
        run: |
          cargo install git-cliff

      - name: Generate new version
        id: version
        run: |
          # git-cliff automatically detects bump type from conventional commits
          # Breaking changes (! or BREAKING CHANGE) -> major
          # Features (feat:) -> minor
          # Fixes and others -> patch
          NEW_VERSION=$(git-cliff --bumped-version)
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"
          
      - name: Show detected changes
        run: |
          echo "Changes since last tag:"
          git-cliff --unreleased

      - name: Generate changelog
        id: changelog
        run: |
          CHANGELOG=$(git-cliff --unreleased --strip header)
          # Escape multiline string for GitHub Actions
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update CHANGELOG.md
        run: |
          git-cliff -o CHANGELOG.md

      - name: Upload changelog artifact
        uses: actions/upload-artifact@v4
        with:
          name: changelog
          path: CHANGELOG.md

  # Job 2: Build binaries for all platforms
  build-binaries:
    name: Build Binaries (${{ matrix.os }} ${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    needs: version-and-changelog
    strategy:
      matrix:
        include:
          # macOS Intel (temporarily disabled)
          # - os: macos
          #   arch: x86_64
          #   target: x86_64-apple-darwin
          #   runner: macos-latest
          # macOS ARM
          - os: macos
            arch: aarch64
            target: aarch64-apple-darwin
            runner: macos-latest
          # Linux x86_64
          - os: linux
            arch: x86_64
            target: x86_64-unknown-linux-gnu
            runner: ubuntu-latest
          # Linux ARM (temporarily disabled)
          # - os: linux
          #   arch: aarch64
          #   target: aarch64-unknown-linux-gnu
          #   runner: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable
          components: clippy
          targets: ${{ matrix.target }}

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "release-${{ matrix.target }}"
          cache-directories: |
            ~/.cargo/registry/cache
            ~/.cargo/git/db

      - name: Install Protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install PostgreSQL (macOS)
        if: matrix.os == 'macos'
        run: |
          brew install libpq
          echo "LIBRARY_PATH=$(brew --prefix libpq)/lib:$LIBRARY_PATH" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=$(brew --prefix libpq)/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV

      # Cross-compilation tools disabled - building native platforms only
      # - name: Install cross-compilation tools (Linux)
      #   if: matrix.os == 'linux'
      #   run: |
      #     curl -L https://github.com/ziglang/zig/releases/download/0.11.0/zig-linux-x86_64-0.11.0.tar.xz | tar -xJ
      #     sudo mv zig-linux-x86_64-0.11.0/zig /usr/local/bin/zig
      #     cargo install cargo-zigbuild
      #     sudo apt-get update
      #     sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Build binary (${{ matrix.target }})
        run: |
          if [ "${{ matrix.os }}" = "linux" ]; then
            make -f ci-makefiles/compile/Makefile build-linux-${{ matrix.arch }}
          else
            make -f ci-makefiles/compile/Makefile build-macos-${{ matrix.arch }}
          fi

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: binary-${{ matrix.target }}
          path: |
            target/${{ matrix.target }}/release/libconnector_service_ffi.*

  # Job 3: Build universal macOS binary (temporarily disabled)
  # build-macos-universal:
  #   name: Build macOS Universal Binary
  #   runs-on: macos-latest
  #   needs: build-binaries
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4
  #
  #     - name: Download macOS binaries
  #       uses: actions/download-artifact@v4
  #       with:
  #         path: target
  #         pattern: binary-*-apple-darwin
  #
  #     - name: Create universal binary
  #       run: |
  #         mkdir -p target/universal/release
  #         lipo -create \
  #           target/binary-x86_64-apple-darwin/libconnector_service_ffi.dylib \
  #           target/binary-aarch64-apple-darwin/libconnector_service_ffi.dylib \
  #           -output target/universal/release/libconnector_service_ffi.dylib
  #
  #     - name: Upload universal binary
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: binary-universal-apple-darwin
  #         path: target/universal/release/libconnector_service_ffi.dylib

  # Job 4a: Package Java SDK
  package-sdk-java:
    name: Package Java SDK
    runs-on: ubuntu-latest
    needs: [build-binaries, version-and-changelog]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      - uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Download binaries
        uses: actions/download-artifact@v4
        with:
          pattern: binary-*
          path: target
      - name: Organize binaries
        run: |
          for dir in target/binary-*; do
            if [ -d "$dir" ]; then
              target_name=$(basename "$dir" | sed 's/binary-//')
              mkdir -p "target/$target_name/release"
              cp "$dir"/* "target/$target_name/release/" 2>/dev/null || true
            fi
          done
      - name: Package Java SDK
        run: make -f ci-makefiles/package/sdk-java/Makefile dist
      - name: Upload Java SDK artifact
        uses: actions/upload-artifact@v4
        with:
          name: sdk-java
          path: artifacts/sdk-java/*.zip

  # Job 4b: Package Python SDK
  package-sdk-python:
    name: Package Python SDK
    runs-on: ubuntu-latest
    needs: [build-binaries, version-and-changelog]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      - uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Install Python dependencies
        run: pip install grpcio grpcio-tools requests
      - name: Download binaries
        uses: actions/download-artifact@v4
        with:
          pattern: binary-*
          path: target
      - name: Organize binaries
        run: |
          for dir in target/binary-*; do
            if [ -d "$dir" ]; then
              target_name=$(basename "$dir" | sed 's/binary-//')
              mkdir -p "target/$target_name/release"
              cp "$dir"/* "target/$target_name/release/" 2>/dev/null || true
            fi
          done
      - name: Package Python SDK
        run: make -f ci-makefiles/package/sdk-python/Makefile dist
      - name: Upload Python SDK artifact
        uses: actions/upload-artifact@v4
        with:
          name: sdk-python
          path: artifacts/sdk-python/*.zip

  # Job 4c: Package JavaScript SDK
  package-sdk-javascript:
    name: Package JavaScript SDK
    runs-on: ubuntu-latest
    needs: [build-binaries, version-and-changelog]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: sdk/javascript/package-lock.json
      - uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Install Node.js dependencies
        run: cd sdk/javascript && npm ci && cd ../..
      - name: Download binaries
        uses: actions/download-artifact@v4
        with:
          pattern: binary-*
          path: target
      - name: Organize binaries
        run: |
          for dir in target/binary-*; do
            if [ -d "$dir" ]; then
              target_name=$(basename "$dir" | sed 's/binary-//')
              mkdir -p "target/$target_name/release"
              cp "$dir"/* "target/$target_name/release/" 2>/dev/null || true
            fi
          done
      - name: Package JavaScript SDK
        run: make -f ci-makefiles/package/sdk-javascript/Makefile dist
      - name: Upload JavaScript SDK artifact
        uses: actions/upload-artifact@v4
        with:
          name: sdk-javascript
          path: artifacts/sdk-javascript/*.zip

  # Job 4d: Package Rust SDK (builds for verification, packages source only)
  package-sdk-rust:
    name: Package Rust SDK
    runs-on: ubuntu-latest
    needs: [build-binaries, version-and-changelog]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable
      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "sdk-rust"
      - uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Package Rust SDK
        run: make -f ci-makefiles/package/sdk-rust/Makefile dist
      - name: Upload Rust SDK artifact
        uses: actions/upload-artifact@v4
        with:
          name: sdk-rust
          path: artifacts/sdk-rust/*.zip

  # Job 4e: Collect SDK Artifacts
  collect-sdks:
    name: Collect SDK Artifacts
    runs-on: ubuntu-latest
    needs: [package-sdk-java, package-sdk-python, package-sdk-javascript, package-sdk-rust]
    steps:
      - name: Download all SDK artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/sdks
          pattern: sdk-*
      - name: Upload combined SDK artifact
        uses: actions/upload-artifact@v4
        with:
          name: sdks
          path: artifacts/sdk-*/*.zip

  # Job 5: Create GitHub Release
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [version-and-changelog, collect-sdks]
    if: ${{ !github.event.inputs.dry_run }}
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download changelog
        uses: actions/download-artifact@v4
        with:
          name: changelog

      - name: Download SDK artifacts
        uses: actions/download-artifact@v4
        with:
          name: sdks
          path: artifacts/sdks

      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md
          git commit -m "chore(release): prepare for ${{ needs.version-and-changelog.outputs.new_version }}" || true
          git tag -a "${{ needs.version-and-changelog.outputs.new_version }}" -m "Release ${{ needs.version-and-changelog.outputs.new_version }}"
          git push origin "${{ needs.version-and-changelog.outputs.new_version }}"
          git push origin HEAD

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.version-and-changelog.outputs.new_version }}
          name: Release ${{ needs.version-and-changelog.outputs.new_version }}
          body: ${{ needs.version-and-changelog.outputs.changelog }}
          files: |
            artifacts/sdks/*.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Dry run summary
  dry-run-summary:
    name: Dry Run Summary
    runs-on: ubuntu-latest
    needs: [version-and-changelog, collect-sdks]
    if: ${{ github.event.inputs.dry_run }}
    steps:
      - name: Print summary
        run: |
          echo "## Dry Run Summary"
          echo ""
          echo "New version: ${{ needs.version-and-changelog.outputs.new_version }}"
          echo ""
          echo "### Changelog Preview"
          echo "```"
          echo "${{ needs.version-and-changelog.outputs.changelog }}"
          echo "```"
          echo ""
          echo "### SDK Artifacts"
          ls -la artifacts/sdks/*.zip 2>/dev/null || echo "No artifacts found"
          echo ""
          echo "This was a dry run. No release was created."
