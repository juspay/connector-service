name: Release

on:
  push:
    branches:
      - ffi-implementation
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to release from'
        required: true
        default: 'main'
        type: string
      dry_run:
        description: 'Dry run (do not create release)'
        required: false
        default: false
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Workflow-level permissions
permissions:
  contents: write      # Required for creating releases and pushing tags
  actions: read        # Required for downloading artifacts
  pull-requests: read  # Required for reading PR information

env:
  CARGO_TERM_COLOR: always

jobs:
  # Job 1: Generate version and changelog
  version-and-changelog:
    name: Generate Version and Changelog
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.version.outputs.new_version }}
      changelog: ${{ steps.changelog.outputs.content }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.event.inputs.branch }}

      - name: Install git-cliff
        run: |
          cargo install git-cliff

      - name: Generate new version
        id: version
        run: |
          # git-cliff automatically detects bump type from conventional commits
          # Breaking changes (! or BREAKING CHANGE) -> major
          # Features (feat:) -> minor
          # Fixes and others -> patch
          NEW_VERSION=$(git-cliff --bumped-version)
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"
          
      - name: Show detected changes
        run: |
          echo "Changes since last tag:"
          git-cliff --unreleased

      - name: Generate changelog
        id: changelog
        run: |
          CHANGELOG=$(git-cliff --unreleased --strip header)
          # Escape multiline string for GitHub Actions
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update CHANGELOG.md
        run: |
          git-cliff -o CHANGELOG.md

      - name: Upload changelog artifact
        uses: actions/upload-artifact@v4
        with:
          name: changelog
          path: CHANGELOG.md

  # Job 2: Build binaries for all platforms
  build-binaries:
    name: Build Binaries (${{ matrix.os }} ${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    needs: version-and-changelog
    strategy:
      matrix:
        include:
          # macOS Intel
          - os: macos
            arch: x86_64
            target: x86_64-apple-darwin
            runner: macos-latest
          # macOS ARM
          - os: macos
            arch: aarch64
            target: aarch64-apple-darwin
            runner: macos-latest
          # Linux x86_64
          - os: linux
            arch: x86_64
            target: x86_64-unknown-linux-gnu
            runner: ubuntu-latest
          # Linux ARM
          - os: linux
            arch: aarch64
            target: aarch64-unknown-linux-gnu
            runner: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools (Linux)
        if: matrix.os == 'linux'
        run: |
          cargo install cargo-zigbuild
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Build binary (${{ matrix.target }})
        run: |
          if [ "${{ matrix.os }}" = "linux" ]; then
            make -f ci-makefiles/build/Makefile build-linux-${{ matrix.arch }}
          else
            make -f ci-makefiles/build/Makefile build-macos-${{ matrix.arch }}
          fi

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: binary-${{ matrix.target }}
          path: |
            target/${{ matrix.target }}/release/libconnector_service_ffi.*

  # Job 3: Build universal macOS binary
  build-macos-universal:
    name: Build macOS Universal Binary
    runs-on: macos-latest
    needs: build-binaries
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download macOS binaries
        uses: actions/download-artifact@v4
        with:
          path: target
          pattern: binary-*-apple-darwin

      - name: Create universal binary
        run: |
          mkdir -p target/universal/release
          lipo -create \
            target/binary-x86_64-apple-darwin/libconnector_service_ffi.dylib \
            target/binary-aarch64-apple-darwin/libconnector_service_ffi.dylib \
            -output target/universal/release/libconnector_service_ffi.dylib

      - name: Upload universal binary
        uses: actions/upload-artifact@v4
        with:
          name: binary-universal-apple-darwin
          path: target/universal/release/libconnector_service_ffi.dylib

  # Job 4: Package all SDKs
  package-sdks:
    name: Package SDKs
    runs-on: macos-latest
    needs: [build-binaries, build-macos-universal, version-and-changelog]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Rust
        uses: dtolnay/rust-action@stable

      - name: Download all binaries
        uses: actions/download-artifact@v4
        with:
          path: target
          pattern: binary-*

      - name: Organize binaries
        run: |
          # Reorganize downloaded artifacts to proper locations
          for dir in target/binary-*; do
            if [ -d "$dir" ]; then
              target_name=$(basename "$dir" | sed 's/binary-//')
              mkdir -p "target/$target_name/release"
              cp "$dir"/* "target/$target_name/release/" 2>/dev/null || true
            fi
          done

      - name: Install dependencies for SDKs
        run: |
          # Install Python dependencies
          pip install grpcio grpcio-tools requests
          # Install Node.js dependencies for JavaScript SDK
          cd sdk/javascript && npm install && cd ../..

      - name: Generate bindings and package Java SDK
        run: |
          make -f ci-makefiles/package/sdk-java/Makefile dist

      - name: Generate bindings and package Python SDK
        run: |
          make -f ci-makefiles/package/sdk-python/Makefile dist

      - name: Generate bindings and package JavaScript SDK
        run: |
          make -f ci-makefiles/package/sdk-javascript/Makefile dist

      - name: Package Rust SDK
        run: |
          make -f ci-makefiles/package/sdk-rust/Makefile dist

      - name: Collect all SDK artifacts
        run: |
          mkdir -p artifacts/sdks
          cp artifacts/sdk-java/*.zip artifacts/sdks/ 2>/dev/null || true
          cp artifacts/sdk-python/*.zip artifacts/sdks/ 2>/dev/null || true
          cp artifacts/sdk-javascript/*.zip artifacts/sdks/ 2>/dev/null || true
          cp artifacts/sdk-rust/*.zip artifacts/sdks/ 2>/dev/null || true

      - name: Upload SDK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sdks
          path: artifacts/sdks/*.zip

  # Job 5: Create GitHub Release
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [version-and-changelog, package-sdks]
    if: ${{ !github.event.inputs.dry_run }}
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download changelog
        uses: actions/download-artifact@v4
        with:
          name: changelog

      - name: Download SDK artifacts
        uses: actions/download-artifact@v4
        with:
          name: sdks
          path: artifacts/sdks

      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md
          git commit -m "chore(release): prepare for ${{ needs.version-and-changelog.outputs.new_version }}" || true
          git tag -a "${{ needs.version-and-changelog.outputs.new_version }}" -m "Release ${{ needs.version-and-changelog.outputs.new_version }}"
          git push origin "${{ needs.version-and-changelog.outputs.new_version }}"
          git push origin HEAD

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.version-and-changelog.outputs.new_version }}
          name: Release ${{ needs.version-and-changelog.outputs.new_version }}
          body: ${{ needs.version-and-changelog.outputs.changelog }}
          files: |
            artifacts/sdks/*.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Dry run summary
  dry-run-summary:
    name: Dry Run Summary
    runs-on: ubuntu-latest
    needs: [version-and-changelog, package-sdks]
    if: ${{ github.event.inputs.dry_run }}
    steps:
      - name: Print summary
        run: |
          echo "## Dry Run Summary"
          echo ""
          echo "New version: ${{ needs.version-and-changelog.outputs.new_version }}"
          echo ""
          echo "### Changelog Preview"
          echo "```"
          echo "${{ needs.version-and-changelog.outputs.changelog }}"
          echo "```"
          echo ""
          echo "### SDK Artifacts"
          ls -la artifacts/sdks/*.zip 2>/dev/null || echo "No artifacts found"
          echo ""
          echo "This was a dry run. No release was created."
